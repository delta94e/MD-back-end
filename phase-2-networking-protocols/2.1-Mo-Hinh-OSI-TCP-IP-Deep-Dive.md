# 2.1 MÃ´ HÃ¬nh OSI / TCP-IP â€” Deep Dive

> **Má»¥c tiÃªu:** Hiá»ƒu THáº¬T SÃ‚U mÃ´ hÃ¬nh máº¡ng â€” khÃ´ng chá»‰ "7 layers" mÃ  cÃ²n Táº I SAO cÃ³ 7 layers, má»—i layer giáº£i quyáº¿t bÃ i toÃ¡n gÃ¬, vÃ  chÃºng áº£nh hÆ°á»Ÿng Ä‘áº¿n backend engineering nhÆ° tháº¿ nÃ o.
>
> **NgÃ´n ngá»¯:** Go | **PhÆ°Æ¡ng phÃ¡p:** 6 Analysis Patterns | **Äá»‘i tÆ°á»£ng:** Backend Engineer hÆ°á»›ng Senior

---

## Báº£n Äá»“ Tá»•ng Quan â€” Mental Map

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Tá»ª CODE Äáº¾N DÃ‚Y CÃP â€” HÃ€NH TRÃŒNH Cá»¦A 1 HTTP REQUEST               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                           â•‘
â•‘  Go Code: resp, _ := http.Get("https://api.example.com/users/1")        â•‘
â•‘                                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚ Layer 7 â€” Application  â”‚ HTTP GET /users/1 Host: api.example.com   â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚ Layer 6 â€” Presentation â”‚ TLS encrypt â†’ ciphertext                  â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚ Layer 5 â€” Session      â”‚ TLS session, keep-alive management       â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚ Layer 4 â€” Transport    â”‚ TCP: src port 54321 â†’ dst port 443      â”‚ â•‘
â•‘  â”‚                         â”‚ SEQ=1, ACK=0, SYN flag                   â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚ Layer 3 â€” Network      â”‚ IP: src 192.168.1.5 â†’ dst 93.184.216.34â”‚ â•‘
â•‘  â”‚                         â”‚ TTL=64, Protocol=TCP                     â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚ Layer 2 â€” Data Link    â”‚ Ethernet: src MAC â†’ dst MAC (router)    â”‚ â•‘
â•‘  â”‚                         â”‚ Frame check sequence (CRC)               â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚ Layer 1 â€” Physical     â”‚ Electrical signals / Light pulses        â”‚ â•‘
â•‘  â”‚                         â”‚ 1 Gbps Ethernet / Fiber optic            â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                                                           â•‘
â•‘  Má»–I LAYER thÃªm HEADER â†’ gá»i lÃ  ENCAPSULATION:                         â•‘
â•‘  [HTTP data] â†’ [TLS][HTTP] â†’ [TCP][TLS][HTTP] â†’ [IP][TCP][TLS][HTTP]  â•‘
â•‘  â†’ [ETH][IP][TCP][TLS][HTTP] â†’ 010110... (bits trÃªn dÃ¢y)              â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Contextual History â€” Táº¡i Sao CÃ³ 2 MÃ´ HÃ¬nh?

### CÃ¢u chuyá»‡n: Tá»« há»—n loáº¡n Ä‘áº¿n chuáº©n hÃ³a

**Tháº­p niÃªn 1960** â€” Chiáº¿n tranh Láº¡nh. Bá»™ Quá»‘c phÃ²ng Má»¹ (DoD) Ä‘áº·t cÃ¢u há»i: _"LÃ m sao giá»¯ liÃªn láº¡c khi LiÃªn XÃ´ Ä‘Ã¡nh bom trung tÃ¢m chá»‰ huy?"_ Máº¡ng Ä‘iá»‡n thoáº¡i truyá»n thá»‘ng dÃ¹ng **circuit switching** = 1 Ä‘Æ°á»ng dÃ¢y dÃ nh riÃªng cho 1 cuá»™c gá»i. Bom 1 tá»•ng Ä‘Ã i â†’ máº¥t toÃ n bá»™ káº¿t ná»‘i qua Ä‘Ã³.

**Paul Baran (RAND Corporation, 1964)** Ä‘á» xuáº¥t Ã½ tÆ°á»Ÿng cÃ¡ch máº¡ng: **packet switching** â€” chia message thÃ nh nhiá»u **packets nhá»**, má»—i packet tá»± tÃ¬m Ä‘Æ°á»ng Ä‘áº¿n Ä‘Ã­ch qua nhiá»u route khÃ¡c nhau. Náº¿u 1 node bá»‹ phÃ¡ há»§y, packets tá»± Ä‘á»™ng Ä‘i Ä‘Æ°á»ng khÃ¡c. ÄÃ¢y lÃ  **DNA cá»§a Internet**.

**1969 â€” ARPANET** khai sinh: 4 nodes Ä‘áº§u tiÃªn (UCLA, Stanford, UCSB, Utah). NgÃ y 29/10/1969, message Ä‘áº§u tiÃªn Ä‘Æ°á»£c gá»­i: **"LO"** (thá»±c ra muá»‘n gá»­i "LOGIN" nhÆ°ng há»‡ thá»‘ng crash sau 2 kÃ½ tá»± Ä‘áº§u â€” origin story ráº¥t "Internet"!).

**1974 â€” Vint Cerf & Bob Kahn** publish paper mÃ´ táº£ TCP protocol. Äáº¿n **1983**, TCP/IP trá»Ÿ thÃ nh giao thá»©c báº¯t buá»™c trÃªn ARPANET, Ä‘Ã¡nh dáº¥u **ngÃ y sinh chÃ­nh thá»©c cá»§a Internet**.

Trong khi Ä‘Ã³, **1977 â€” ISO** (International Organization for Standardization) báº¯t Ä‘áº§u thiáº¿t káº¿ **OSI Model** â€” mÃ´ hÃ¬nh "lÃ½ tÆ°á»Ÿng" vá»›i 7 layers rÃµ rÃ ng. Má»¥c tiÃªu: chuáº©n hÃ³a Ä‘á»ƒ Táº¤T Cáº¢ mÃ¡y tÃ­nh cÃ³ thá»ƒ giao tiáº¿p, báº¥t ká»ƒ vendor. OSI Ä‘Æ°á»£c thiáº¿t káº¿ **top-down** (lÃ½ thuyáº¿t trÆ°á»›c, implement sau), trong khi TCP/IP Ä‘Æ°á»£c phÃ¡t triá»ƒn **bottom-up** (viáº¿t code trÆ°á»›c, chuáº©n hÃ³a sau).

Káº¿t quáº£? Khi OSI hoÃ n thÃ nh (cuá»‘i 1980s), TCP/IP Ä‘Ã£ **chiáº¿m lÄ©nh tháº¿ giá»›i**. OSI trá»Ÿ thÃ nh mÃ´ hÃ¬nh **há»c thuáº­t** Ä‘á»ƒ dáº¡y vÃ  debug, cÃ²n TCP/IP lÃ  mÃ´ hÃ¬nh **thá»±c táº¿** mÃ  Internet cháº¡y.

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   OSI vs TCP/IP â€” HAI MÃ” HÃŒNH                               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  OSI Model (7 layers)     TCP/IP Model (4 layers)            â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â•‘
â•‘  â”‚ 7. Application  â”‚      â”‚                 â”‚               â•‘
â•‘  â”‚ 6. Presentation â”‚ â”€â”€â”€â–º â”‚ 4. Application  â”‚               â•‘
â•‘  â”‚ 5. Session      â”‚      â”‚                 â”‚               â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â•‘
â•‘  â”‚ 4. Transport    â”‚ â”€â”€â”€â–º â”‚ 3. Transport    â”‚               â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â•‘
â•‘  â”‚ 3. Network      â”‚ â”€â”€â”€â–º â”‚ 2. Internet     â”‚               â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â•‘
â•‘  â”‚ 2. Data Link    â”‚      â”‚ 1. Network      â”‚               â•‘
â•‘  â”‚ 1. Physical     â”‚ â”€â”€â”€â–º â”‚    Access       â”‚               â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â•‘
â•‘                                                               â•‘
â•‘  Timeline:                                                    â•‘
â•‘  1969  ARPANET (4 nodes)                                     â•‘
â•‘  1974  TCP paper (Cerf & Kahn)                               â•‘
â•‘  1977  ISO báº¯t Ä‘áº§u thiáº¿t káº¿ OSI                             â•‘
â•‘  1983  TCP/IP báº¯t buá»™c trÃªn ARPANET = "Internet birthday"  â•‘
â•‘  1989  OSI hoÃ n thÃ nh â†’ quÃ¡ muá»™n, TCP/IP Ä‘Ã£ tháº¯ng!        â•‘
â•‘  1991  World Wide Web (HTTP)                                 â•‘
â•‘  2015  HTTP/2                                                â•‘
â•‘  2022  HTTP/3 (QUIC)                                        â•‘
â•‘                                                               â•‘
â•‘  OSI = MÃ” HÃŒNH Há»ŒC THUáº¬T (dÃ¹ng Ä‘á»ƒ GIáº¢I THÃCH)             â•‘
â•‘  TCP/IP = MÃ” HÃŒNH THá»°C Táº¾ (dÃ¹ng Ä‘á»ƒ Láº¬P TRÃŒNH)             â•‘
â•‘                                                               â•‘
â•‘  Backend Engineer cáº§n cáº£ hai:                                â•‘
â•‘  â†’ OSI Ä‘á»ƒ debug ("váº¥n Ä‘á» á»Ÿ layer nÃ o?")                    â•‘
â•‘  â†’ TCP/IP Ä‘á»ƒ implement (socket, HTTP, TLS)                  â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

> **"Worse is Better" â€” BÃ i Há»c MuÃ´n Thuá»Ÿ Cho Software Engineer:**
>
> Richard Gabriel (1989) Ä‘áº·t tÃªn triáº¿t lÃ½ nÃ y khi so sÃ¡nh Unix/C vá»›i Lisp/MIT approach. TCP/IP lÃ  case study hoÃ n háº£o:
>
> |                    | OSI ("The Right Thing")      | TCP/IP ("Worse is Better")     |
> | ------------------ | ---------------------------- | ------------------------------ |
> | **Design**         | HoÃ n háº£o, 7 layers rÃµ rÃ ng   | "Táº¡m Ä‘Æ°á»£c", 4 layers pragmatic |
> | **Implementation** | Phá»©c táº¡p, nhiá»u nÄƒm          | ÄÆ¡n giáº£n, ship nhanh           |
> | **Adoption**       | Bureaucratic (ISO committee) | Open source, miá»…n phÃ­          |
> | **Káº¿t quáº£**        | Cháº¿t trÃªn giáº¥y               | Cháº¡y Internet toÃ n cáº§u         |
>
> BÃ i há»c cho báº¡n: **Ship trÆ°á»›c, hoÃ n thiá»‡n sau.** Go tháº¯ng Haskell khÃ´ng pháº£i vÃ¬ type system máº¡nh hÆ¡n, mÃ  vÃ¬ compile nhanh, deploy dá»…, vÃ  **good enough** cho 99% backend tasks. Kubernetes tháº¯ng Mesos vÃ¬ community, dÃ¹ Mesos "Ä‘Ãºng" hÆ¡n vá» máº·t kiáº¿n trÃºc.

### Encapsulation â€” "BÃºp BÃª Nga" Cá»§a Máº¡ng

Khi data di chuyá»ƒn **xuá»‘ng** qua cÃ¡c layers, má»—i layer **bá»c thÃªm header** vÃ o data â€” giá»‘ng **bÃºp bÃª Nga (Matryoshka)**: má»—i lá»›p bao bá»c lá»›p bÃªn trong.

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ENCAPSULATION â€” DATA ÄI XUá»NG                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                       â•‘
â•‘  Layer 7: [         HTTP Data: GET /users/1 + headers          ]    â•‘
â•‘                                    â”‚                                  â•‘
â•‘                                    â–¼                                  â•‘
â•‘  Layer 6: [    TLS  â”‚         HTTP Data (encrypted)            ]    â•‘
â•‘                                    â”‚                                  â•‘
â•‘                                    â–¼                                  â•‘
â•‘  Layer 4: [  TCP  â”‚  TLS  â”‚       HTTP Data                    ]    â•‘
â•‘           â”‚20-60B â”‚                                                   â•‘
â•‘                                    â”‚                                  â•‘
â•‘                                    â–¼                                  â•‘
â•‘  Layer 3: [  IP â”‚ TCP  â”‚  TLS  â”‚  HTTP Data                    ]    â•‘
â•‘           â”‚20B â”‚                                                      â•‘
â•‘                                    â”‚                                  â•‘
â•‘                                    â–¼                                  â•‘
â•‘  Layer 2: [ETH â”‚ IP â”‚ TCP â”‚ TLS â”‚ HTTP Data â”‚ FCS]                  â•‘
â•‘           â”‚14B â”‚                              â”‚ 4Bâ”‚                   â•‘
â•‘                                    â”‚                                  â•‘
â•‘                                    â–¼                                  â•‘
â•‘  Layer 1: 01001010110101001... (bits trÃªn dÃ¢y/sÃ³ng/quang)           â•‘
â•‘                                                                       â•‘
â•‘  Overhead tá»‘i thiá»ƒu per packet:                                      â•‘
â•‘  ETH (14) + IP (20) + TCP (20) = 54 bytes header                    â•‘
â•‘  Vá»›i TLS: + ~40 bytes = ~94 bytes overhead per packet               â•‘
â•‘  Vá»›i MTU 1500: payload hiá»‡u dá»¥ng = 1500 - 54 = 1446 bytes (96.4%) â•‘
â•‘  Vá»›i small packets (e.g. ACK): 54B header + ~0B data = 100% waste! â•‘
â•‘                                                                       â•‘
â•‘  DE-ENCAPSULATION â€” DATA ÄI LÃŠN (receiver side):                    â•‘
â•‘  Layer 1 â†’ 2: kiá»ƒm tra FCS, strip ETH header                       â•‘
â•‘  Layer 2 â†’ 3: Ä‘á»c Dst IP, routing decision                         â•‘
â•‘  Layer 3 â†’ 4: Ä‘á»c port number, deliver to correct socket           â•‘
â•‘  Layer 4 â†’ 7: reassemble segments â†’ TLS decrypt â†’ HTTP parse      â•‘
â•‘                                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Táº¡i sao overhead nÃ y quan trá»ng?**

Vá»›i **Nagle's Algorithm** (TCP máº·c Ä‘á»‹nh), TCP cá»‘ gáº¯ng gom nhiá»u bytes nhá» thÃ nh 1 segment lá»›n Ä‘á»ƒ giáº£m overhead. NhÆ°ng vá»›i **interactive applications** (SSH, gaming, real-time trading), báº¡n muá»‘n gá»­i tá»«ng byte NGAY Láº¬P Tá»¨C â†’ pháº£i táº¯t Nagle (`TCP_NODELAY`). Go `net.TCPConn` cÃ³ method `SetNoDelay(true)` cho má»¥c Ä‘Ã­ch nÃ y.

Vá»›i **gRPC streaming**: má»—i message nhá» (vÃ­ dá»¥ 50 bytes) + 94 bytes overhead = hiá»‡u suáº¥t chá»‰ 34%. ÄÃ¢y lÃ  lÃ½ do gRPC khuyáº¿n khÃ­ch **batch messages** khi cÃ³ thá»ƒ, hoáº·c dÃ¹ng **HTTP/2 multiplexing** Ä‘á»ƒ amortize TCP/TLS overhead qua nhiá»u streams.

---

## Â§1. Layer 1 â€” Physical: Bits TrÃªn DÃ¢y

### BÃ i toÃ¡n gá»‘c: Truyá»n 0 vÃ  1 giá»¯a hai mÃ¡y

Táº¥t cáº£ networking, cuá»‘i cÃ¹ng, lÃ  viá»‡c gá»­i **bits** (0/1) tá»« mÃ¡y A sang mÃ¡y B qua má»™t phÆ°Æ¡ng tiá»‡n váº­t lÃ½. Layer 1 giáº£i quyáº¿t: **lÃ m sao biá»ƒu diá»…n 0/1 báº±ng tÃ­n hiá»‡u váº­t lÃ½?**

HÃ£y tÆ°á»Ÿng tÆ°á»£ng báº¡n Ä‘á»©ng trÃªn Ä‘á»‰nh nÃºi vÃ  muá»‘n gá»­i tin nháº¯n Ä‘áº¿n ngÆ°á»i báº¡n á»Ÿ Ä‘á»‰nh nÃºi bÃªn kia. Báº¡n cÃ³ thá»ƒ dÃ¹ng **lá»­a** (cÃ³/khÃ´ng = 1/0), **gÆ°Æ¡ng pháº£n chiáº¿u Ã¡nh náº¯ng** (Morse code), hoáº·c **tiáº¿ng trá»‘ng** (táº§n sá»‘ khÃ¡c nhau). ÄÃ³ chÃ­nh xÃ¡c lÃ  Layer 1 â€” **biáº¿n thÃ´ng tin thÃ nh tÃ­n hiá»‡u váº­t lÃ½**.

Trong máº¡ng mÃ¡y tÃ­nh hiá»‡n Ä‘áº¡i, cÃ³ 3 phÆ°Æ¡ng tiá»‡n chÃ­nh:

- **CÃ¡p Ä‘á»“ng** (copper) dÃ¹ng **xung Ä‘iá»‡n** â€” high voltage = 1, low = 0
- **CÃ¡p quang** (fiber optic) dÃ¹ng **xung Ã¡nh sÃ¡ng** â€” light on = 1, off = 0
- **Wi-Fi** dÃ¹ng **sÃ³ng radio** â€” modulated electromagnetic waves

### Signal Encoding â€” CÃ¡ch Bits Thá»±c Sá»± ÄÆ°á»£c Truyá»n

Thá»±c táº¿ phá»©c táº¡p hÆ¡n "high voltage = 1, low = 0" ráº¥t nhiá»u. Náº¿u báº¡n gá»­i 8 bits `11111111`, voltage cao liÃªn tá»¥c â†’ **receiver khÃ´ng biáº¿t Ä‘Ã¢u lÃ  ranh giá»›i** giá»¯a cÃ¡c bits! ÄÃ¢y gá»i lÃ  **clock synchronization problem**.

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   SIGNAL ENCODING â€” CÃCH BITS THÃ€NH TÃN HIá»†U                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â‘  NRZ (Non-Return to Zero) â€” Ä‘Æ¡n giáº£n nháº¥t:               â•‘
â•‘                                                               â•‘
â•‘  Data:    1   1   0   1   0   0   1   1                      â•‘
â•‘  Signal:  â–„â–„â–„â–„â–„â–„â–„â–„â–‘â–‘â–‘â–‘â–„â–„â–„â–„â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–„â–„â–„â–„â–„â–„â–„â–„                â•‘
â•‘           â†‘ high     â†‘ low                                    â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Váº¥n Ä‘á»: 11111111 = voltage cao liÃªn tá»¥c                â•‘
â•‘  â†’ Receiver máº¥t Ä‘á»“ng bá»™ clock! KhÃ´ng biáº¿t 5 hay 8 bits "1" â•‘
â•‘  â†’ DC bias: voltage trung bÃ¬nh lá»‡ch â†’ circuit issues       â•‘
â•‘                                                               â•‘
â•‘  â‘¡ Manchester Encoding (Ethernet 10BASE-T):                  â•‘
â•‘                                                               â•‘
â•‘  Data:    1     0     1     1     0                           â•‘
â•‘  Signal:  â–„â–„â–‘â–‘  â–‘â–‘â–„â–„  â–„â–„â–‘â–‘  â–„â–„â–‘â–‘  â–‘â–‘â–„â–„                     â•‘
â•‘           â†‘ highâ†’low = 1   â†‘ lowâ†’high = 0                   â•‘
â•‘                                                               â•‘
â•‘  âœ… Má»—i bit CÃ“ transition â†’ clock recovery tá»‘t!            â•‘
â•‘  âŒ Bandwidth efficiency giáº£m 50% (2 signal changes/bit)    â•‘
â•‘                                                               â•‘
â•‘  â‘¢ PAM-4 (Pulse Amplitude Modulation, 4 levels):            â•‘
â•‘  â†’ DÃ¹ng cho 100Gbps+ Ethernet, NVMe, PCIe 6.0              â•‘
â•‘                                                               â•‘
â•‘  Signal levels:                                               â•‘
â•‘  â–„â–„â–„â–„ (+3) = "11"    â”‚ 1 signal change = 2 bits!           â•‘
â•‘  â–ƒâ–ƒâ–ƒâ–ƒ (+1) = "10"    â”‚ TÄƒng throughput 2X so vá»›i NRZ!      â•‘
â•‘  â–‚â–‚â–‚â–‚ (-1) = "01"    â”‚ âŒ NhÆ°ng: cáº§n phÃ¢n biá»‡t 4 levels    â•‘
â•‘  â–â–â–â– (-3) = "00"    â”‚    â†’ dá»… lá»—i hÆ¡n, cáº§n FEC (Forward  â•‘
â•‘                        â”‚       Error Correction)              â•‘
â•‘                                                               â•‘
â•‘  Backend relevance:                                           â•‘
â•‘  â†’ Data center 100G/400G Ethernet dÃ¹ng PAM-4               â•‘
â•‘  â†’ Má»—i tháº¿ há»‡ NIC nhanh hÆ¡n = encoding phá»©c táº¡p hÆ¡n      â•‘
â•‘  â†’ FEC tá»‘n CPU nhÆ°ng cáº§n thiáº¿t â†’å½±éŸ¿ tail latency         â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### PhÆ°Æ¡ng Tiá»‡n Truyá»n â€” So SÃ¡nh Chi Tiáº¿t

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   LAYER 1 â€” PHYSICAL MEDIA                                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚ Medium       â”‚ Tá»‘c Ä‘á»™   â”‚ Khoáº£ng cÃ¡châ”‚ Chi phÃ­      â”‚    â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â•‘
â•‘  â”‚ Cat5e Copper â”‚ 1 Gbps   â”‚ 100m      â”‚ $0.15/m      â”‚    â•‘
â•‘  â”‚ Cat6a Copper â”‚ 10 Gbps  â”‚ 55m (10G) â”‚ $0.50/m      â”‚    â•‘
â•‘  â”‚ Cat8 Copper  â”‚ 40 Gbps  â”‚ 30m       â”‚ $2.00/m      â”‚    â•‘
â•‘  â”‚ MM Fiber     â”‚ 100 Gbps â”‚ 550m      â”‚ $1.00/m      â”‚    â•‘
â•‘  â”‚ SM Fiber     â”‚ 400 Gbps â”‚ 80km      â”‚ $0.50/m      â”‚    â•‘
â•‘  â”‚ Wi-Fi 6E     â”‚ 9.6 Gbps â”‚ ~30m      â”‚ per AP       â”‚    â•‘
â•‘  â”‚ Wi-Fi 7      â”‚ 46 Gbps  â”‚ ~30m      â”‚ per AP       â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

#### CÃ¡p Äá»“ng (Copper â€” Twisted Pair) â€” Táº¡i Sao Xoáº¯n?

Twisted pair cable lÃ  phÃ¡t minh thiÃªn tÃ i cá»§a Alexander Graham Bell (1881). Táº¡i sao pháº£i xoáº¯n? VÃ¬ **Electromagnetic Interference (EMI)**.

Má»—i dÃ¢y dáº«n táº¡o ra trÆ°á»ng Ä‘iá»‡n tá»« khi cÃ³ dÃ²ng Ä‘iá»‡n cháº¡y qua. Náº¿u 2 dÃ¢y cháº¡y song song, trÆ°á»ng Ä‘iá»‡n tá»« tá»« dÃ¢y bÃªn cáº¡nh (hoáº·c tá»« thiáº¿t bá»‹ khÃ¡c: motor, Ä‘Ã¨n huá»³nh quang) sáº½ **gÃ¢y nhiá»…u** lÃªn tÃ­n hiá»‡u â€” gá»i lÃ  **crosstalk**.

**Giáº£i phÃ¡p: xoáº¯n 2 dÃ¢y láº¡i vá»›i nhau.** Táº¡i má»—i vÃ²ng xoáº¯n, hÆ°á»›ng nhiá»…u **Ä‘áº£o ngÆ°á»£c** â†’ nhiá»…u **tá»± triá»‡t tiÃªu** (cancellation)!

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TWISTED PAIR â€” Táº I SAO XOáº®N?                               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  KhÃ´ng xoáº¯n (flat cable):                                    â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Wire A                               â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Wire B                               â•‘
â•‘  â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘ Nhiá»…u tá»« nguá»“n bÃªn ngoÃ i             â•‘
â•‘  â†’ Cáº£ 2 dÃ¢y nháº­n CÃ™NG nhiá»…u â†’ tÃ­n hiá»‡u bá»‹ lá»‡ch!          â•‘
â•‘                                                               â•‘
â•‘  Xoáº¯n (twisted pair):                                        â•‘
â•‘   â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±  Wire A                                    â•‘
â•‘   â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²  Wire B                                   â•‘
â•‘  â†‘â†“â†‘â†“â†‘â†“â†‘â†“â†‘â†“â†‘â†“â†‘â†“ Nhiá»…u Ä‘áº£o chiá»u má»—i vÃ²ng xoáº¯n          â•‘
â•‘  â†’ Nhiá»…u tá»± TRIá»†T TIÃŠU khi Ä‘o hiá»‡u (differential)!      â•‘
â•‘                                                               â•‘
â•‘  CÃ¡p Ethernet cÃ³ 4 cáº·p xoáº¯n:                                â•‘
â•‘  â†’ Cat5e: má»—i cáº·p xoáº¯n density khÃ¡c nhau (5-6.5 twists/inch)â•‘
â•‘  â†’ Cat6a: thÃªm separator giá»¯a cÃ¡c cáº·p + shielding          â•‘
â•‘  â†’ Twist rate khÃ¡c nhau â†’ giáº£m crosstalk GIá»®A cÃ¡c cáº·p     â•‘
â•‘                                                               â•‘
â•‘  Giá»›i háº¡n Ä‘á»“ng:                                              â•‘
â•‘  â†’ 100m max (signal attenuation = suy giáº£m tÃ­n hiá»‡u)       â•‘
â•‘  â†’ QuÃ¡ 100m: dÃ¹ng switch/repeater Ä‘á»ƒ khuáº¿ch Ä‘áº¡i láº¡i       â•‘
â•‘  â†’ Nhiá»‡t Ä‘á»™ cao â†’ resistance tÄƒng â†’ signal degradation    â•‘
â•‘  â†’ EMI tá»« motor, Ä‘Ã¨n huá»³nh quang, microwave â†’ avoid!       â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

#### CÃ¡p Quang (Fiber Optic) â€” Ãnh SÃ¡ng Trong á»ng KÃ­nh

CÃ¡p quang truyá»n data báº±ng **Ã¡nh sÃ¡ng** thay vÃ¬ Ä‘iá»‡n. NguyÃªn lÃ½: **Total Internal Reflection** (pháº£n xáº¡ toÃ n pháº§n) â€” khi Ã¡nh sÃ¡ng Ä‘i trong váº­t liá»‡u cÃ³ chiáº¿t suáº¥t cao (core) gáº·p ranh giá»›i váº­t liá»‡u chiáº¿t suáº¥t tháº¥p (cladding), náº¿u gÃ³c tá»›i Ä‘á»§ nhá», Ã¡nh sÃ¡ng pháº£n xáº¡ 100% vÃ  **khÃ´ng thoÃ¡t ra** â†’ Ã¡nh sÃ¡ng "báº«y" bÃªn trong sá»£i quang vÃ  Ä‘i cáº£ trÄƒm km!

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   FIBER OPTIC â€” SINGLE-MODE vs MULTI-MODE                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Single-Mode Fiber (SMF):                                    â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â•‘
â•‘  â”‚ Core: 9Î¼m (cá»±c nhá», = 1/10 sá»£i tÃ³c!)         â”‚          â•‘
â•‘  â”‚ â†’ Chá»‰ 1 mode (1 tia sÃ¡ng) Ä‘i tháº³ng            â”‚          â•‘
â•‘  â”‚ â†’ Laser transmitter (Ä‘áº¯t hÆ¡n LED)              â”‚          â•‘
â•‘  â”‚                                                  â”‚          â•‘
â•‘  â”‚         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•               â”‚          â•‘
â•‘  â”‚         1 tia sÃ¡ng Ä‘i tháº³ng                     â”‚          â•‘
â•‘  â”‚         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•               â”‚          â•‘
â•‘  â”‚                                                  â”‚          â•‘
â•‘  â”‚ âœ… Khoáº£ng cÃ¡ch: 10-80km (tháº­m chÃ­ 120km+)     â”‚          â•‘
â•‘  â”‚ âœ… Bandwidth: 400Gbps+ per wavelength          â”‚          â•‘
â•‘  â”‚ âœ… KhÃ´ng modal dispersion â†’ signal rÃµ rÃ ng    â”‚          â•‘
â•‘  â”‚ âŒ Chi phÃ­ transmitter cao                      â”‚          â•‘
â•‘  â”‚ ğŸ”§ DÃ¹ng cho: inter-datacenter, submarine cablesâ”‚          â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â•‘
â•‘                                                               â•‘
â•‘  Multi-Mode Fiber (MMF):                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â•‘
â•‘  â”‚ Core: 50Î¼m hoáº·c 62.5Î¼m (lá»›n hÆ¡n)             â”‚          â•‘
â•‘  â”‚ â†’ Nhiá»u modes (tia sÃ¡ng) pháº£n xáº¡ nhau          â”‚          â•‘
â•‘  â”‚ â†’ LED transmitter (ráº» hÆ¡n laser)                â”‚          â•‘
â•‘  â”‚                                                  â”‚          â•‘
â•‘  â”‚         â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±             â”‚          â•‘
â•‘  â”‚         nhiá»u tia sÃ¡ng pháº£n xáº¡ â†’ modal dispersionâ”‚         â•‘
â•‘  â”‚         â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²â•±â•²             â”‚          â•‘
â•‘  â”‚                                                  â”‚          â•‘
â•‘  â”‚ âœ… Chi phÃ­ tháº¥p (LED + connector dá»… káº¿t ná»‘i)  â”‚          â•‘
â•‘  â”‚ âŒ Khoáº£ng cÃ¡ch: 100-550m                       â”‚          â•‘
â•‘  â”‚ âŒ Modal dispersion: tia khÃ¡c nhau Ä‘áº¿n vÃ o     â”‚          â•‘
â•‘  â”‚    thá»i Ä‘iá»ƒm khÃ¡c nhau â†’ signal bá»‹ "má»"       â”‚          â•‘
â•‘  â”‚ ğŸ”§ DÃ¹ng cho: intra-datacenter (rack-to-rack)  â”‚          â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â•‘
â•‘                                                               â•‘
â•‘  WDM (Wavelength Division Multiplexing):                     â•‘
â•‘  â†’ 1 sá»£i quang mang NHIá»€U colors (wavelengths) Ä‘á»“ng thá»i  â•‘
â•‘  â†’ DWDM: 96+ channels Ã— 400Gbps = 38.4 Tbps / sá»£i!       â•‘
â•‘  â†’ Submarine cables dÃ¹ng DWDM â†’ terabits trÃªn 1 sá»£i       â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

#### Duplex â€” NÃ³i VÃ  Nghe CÃ¹ng LÃºc?

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   DUPLEX MODES                                                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Half-Duplex (bá»™ Ä‘Ã m):                                      â•‘
â•‘  â†’ A nÃ³i xong â†’ B má»›i nÃ³i (1 chiá»u táº¡i 1 thá»i Ä‘iá»ƒm)      â•‘
â•‘  â†’ Wi-Fi = half-duplex! (do shared medium = khÃ´ng khÃ­)     â•‘
â•‘  â†’ Hub cÅ© = half-duplex (collision domain)                  â•‘
â•‘  â†’ Collision: 2 devices nÃ³i cÃ¹ng lÃºc â†’ CSMA/CD detect      â•‘
â•‘    â†’ Cáº£ 2 dá»«ng, chá» random time, thá»­ láº¡i                  â•‘
â•‘                                                               â•‘
â•‘  Full-Duplex (Ä‘iá»‡n thoáº¡i):                                   â•‘
â•‘  â†’ A vÃ  B nÃ³i CÃ™ng LÃšC (2 chiá»u Ä‘á»“ng thá»i)               â•‘
â•‘  â†’ Ethernet switch = full-duplex (2 cáº·p dÃ¢y riÃªng biá»‡t)   â•‘
â•‘  â†’ 1 Gbps full-duplex = 1 Gbps gá»­i + 1 Gbps nháº­n         â•‘
â•‘    = 2 Gbps aggregate bandwidth!                             â•‘
â•‘                                                               â•‘
â•‘  Backend Impact:                                             â•‘
â•‘  â†’ WiFi bottleneck: 50 devices trÃªn 1 AP = contention!     â•‘
â•‘  â†’ Data center: LUÃ”N full-duplex (Ethernet switch)          â•‘
â•‘  â†’ Benchmark: iperf3 -d (test duplex throughput)            â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### NIC (Network Interface Card) â€” Cá»•ng VÃ o Máº¡ng

NIC lÃ  **pháº§n cá»©ng** káº¿t ná»‘i mÃ¡y tÃ­nh vá»›i máº¡ng. Má»—i NIC cÃ³ má»™t **MAC address** duy nháº¥t (sáº½ discuss á»Ÿ Layer 2). NhÆ°ng NIC lÃ m nhiá»u hÆ¡n viá»‡c "cáº¯m dÃ¢y":

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   NIC ARCHITECTURE â€” KHÃ”NG CHá»ˆ LÃ€ "Cá»”NG Máº NG"              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚                     NIC Card                         â”‚    â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â•‘
â•‘  â”‚  â”‚ PHY     â”‚  â”‚ MAC      â”‚  â”‚ DMA Engine       â”‚  â”‚    â•‘
â•‘  â”‚  â”‚ (Layer1)â”‚â†’â”‚ (Layer2) â”‚â†’â”‚ (Direct Memory   â”‚  â”‚    â•‘
â•‘  â”‚  â”‚         â”‚  â”‚          â”‚  â”‚  Access to RAM!)  â”‚  â”‚    â•‘
â•‘  â”‚  â”‚ Signal  â”‚  â”‚ Frame    â”‚  â”‚                   â”‚  â”‚    â•‘
â•‘  â”‚  â”‚ encode/ â”‚  â”‚ parsing  â”‚  â”‚ Ring buffer:     â”‚  â”‚    â•‘
â•‘  â”‚  â”‚ decode  â”‚  â”‚ CRC checkâ”‚  â”‚ packets â†’ RAM    â”‚  â”‚    â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ KHÃ”NG qua CPU!   â”‚  â”‚    â•‘
â•‘  â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                               â•‘
â•‘  Advanced NIC Features (data center):                        â•‘
â•‘                                                               â•‘
â•‘  RSS (Receive Side Scaling):                                 â•‘
â•‘  â†’ NIC tá»± hash packet header â†’ phÃ¢n bá»• vÃ o cÃ¡c CPU cores  â•‘
â•‘  â†’ Thay vÃ¬ 1 core xá»­ lÃ½ Táº¤T Cáº¢ packets = bottleneck     â•‘
â•‘  â†’ 10Gbps = ~14.88 million packets/sec (64B packets)       â•‘
â•‘  â†’ 1 core xá»­ lÃ½ max ~3-5M pps â†’ cáº§n Ã­t nháº¥t 3-5 cores!  â•‘
â•‘                                                               â•‘
â•‘  TCP Offload Engine (TOE):                                   â•‘
â•‘  â†’ NIC tá»± xá»­ lÃ½ TCP checksum, segmentation                â•‘
â•‘  â†’ CPU khÃ´ng pháº£i compute checksum cho má»—i packet          â•‘
â•‘  â†’ Giáº£m CPU load 10-30% cho network-heavy servers          â•‘
â•‘                                                               â•‘
â•‘  SR-IOV (Single Root I/O Virtualization):                    â•‘
â•‘  â†’ 1 NIC váº­t lÃ½ â†’ nhiá»u "virtual NICs" cho VMs            â•‘
â•‘  â†’ Cloud VMs (AWS EC2) dÃ¹ng SR-IOV cho network perf       â•‘
â•‘  â†’ Bypass hypervisor network stack â†’ near-native perf      â•‘
â•‘                                                               â•‘
â•‘  DPDK (Data Plane Development Kit):                          â•‘
â•‘  â†’ Bypass kernel network stack hoÃ n toÃ n!                   â•‘
â•‘  â†’ Userspace packet processing â†’ 10-100x throughput        â•‘
â•‘  â†’ DÃ¹ng cho: load balancers (Envoy), CDN, telecom          â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Bandwidth vs Throughput vs Latency â€” Ba KhÃ¡i Niá»‡m KhÃ¡c Nhau!

Nhiá»u ngÆ°á»i nháº§m láº«n 3 khÃ¡i niá»‡m nÃ y. HÃ£y dÃ¹ng **analogy á»‘ng nÆ°á»›c**:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   BANDWIDTH vs THROUGHPUT vs LATENCY                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  á»ng nÆ°á»›c:                                                    â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â•‘
â•‘  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚â† Bandwidth  â•‘
â•‘  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚   (Ä‘Æ°á»ng    â•‘
â•‘  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚    kÃ­nh á»‘ng) â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â•‘
â•‘    â†• Latency = thá»i gian 1 giá»t nÆ°á»›c Ä‘i tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i   â•‘
â•‘    â†” Throughput = lÆ°á»£ng nÆ°á»›c thá»±c sá»± cháº£y qua / giÃ¢y       â•‘
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘  â”‚ KhÃ¡i niá»‡m â”‚ Ã nghÄ©a                                â”‚     â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â•‘
â•‘  â”‚ Bandwidth â”‚ Capacity tá»‘i Ä‘a (10 Gbps)              â”‚     â•‘
â•‘  â”‚           â”‚ = Ä‘Æ°á»ng kÃ­nh á»‘ng (khÃ´ng Ä‘á»•i khi sá»­ dá»¥ng)â”‚     â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â•‘
â•‘  â”‚ Throughputâ”‚ LÆ°u lÆ°á»£ng thá»±c táº¿ (7 Gbps)              â”‚     â•‘
â•‘  â”‚           â”‚ = lÆ°á»£ng nÆ°á»›c THá»°C Sá»° cháº£y (< bandwidth) â”‚     â•‘
â•‘  â”‚           â”‚ Giáº£m bá»Ÿi: congestion, protocol overhead,â”‚     â•‘
â•‘  â”‚           â”‚ packet loss, distance                    â”‚     â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â•‘
â•‘  â”‚ Latency   â”‚ Thá»i gian 1 packet Ä‘i Aâ†’B (30ms)       â”‚     â•‘
â•‘  â”‚           â”‚ = thá»i gian 1 giá»t nÆ°á»›c cháº£y qua á»‘ng   â”‚     â•‘
â•‘  â”‚           â”‚ Quyáº¿t Ä‘á»‹nh bá»Ÿi: khoáº£ng cÃ¡ch, routing,  â”‚     â•‘
â•‘  â”‚           â”‚ processing delay táº¡i má»—i hop            â”‚     â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ HIGH BANDWIDTH â‰  LOW LATENCY!                           â•‘
â•‘  â†’ Submarine cable 400Gbps bandwidth, nhÆ°ng latency 75ms! â•‘
â•‘  â†’ CÃ¹ng rack 1Gbps bandwidth, nhÆ°ng latency 0.1ms!        â•‘
â•‘                                                               â•‘
â•‘  CÃ´ng thá»©c quan trá»ng:                                       â•‘
â•‘  Bandwidth-Delay Product (BDP) = Bandwidth Ã— RTT            â•‘
â•‘  â†’ 10Gbps link, RTT 100ms:                                  â•‘
â•‘    BDP = 10Gbps Ã— 0.1s = 1Gbit = 125 MB                    â•‘
â•‘  â†’ = lÆ°á»£ng data "in flight" tá»‘i Ä‘a trÆ°á»›c khi nháº­n ACK     â•‘
â•‘  â†’ TCP window pháº£i â‰¥ BDP Ä‘á»ƒ max throughput!                â•‘
â•‘  â†’ Náº¿u window < BDP â†’ link khÃ´ng bao giá» full!            â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Submarine Cables â€” XÆ°Æ¡ng Sá»‘ng Cá»§a Internet

Khoáº£ng **99% traffic Internet quá»‘c táº¿** Ä‘i qua cÃ¡p quang dÆ°á»›i biá»ƒn â€” KHÃ”NG PHáº¢I vá»‡ tinh! CÃ³ hÆ¡n **550 há»‡ thá»‘ng cÃ¡p biá»ƒn** Ä‘ang hoáº¡t Ä‘á»™ng, tá»•ng cá»™ng **1.4 triá»‡u km** (Ä‘á»§ quáº¥n TrÃ¡i Äáº¥t 35 vÃ²ng).

**Cáº¥u trÃºc cÃ¡p biá»ƒn:**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   SUBMARINE CABLE â€” CROSS SECTION                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Cáº¯t ngang 1 sá»£i cÃ¡p biá»ƒn (Ä‘Æ°á»ng kÃ­nh ~2.5cm = á»‘ng nÆ°á»›c):  â•‘
â•‘                                                               â•‘
â•‘         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â•‘
â•‘         â”‚ Polyethylene (bá»c ngoÃ i)â”‚ â† báº£o vá»‡ nÆ°á»›c biá»ƒn    â•‘
â•‘         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                          â•‘
â•‘         â”‚  â”‚ Steel armor       â”‚  â”‚ â† báº£o vá»‡ má» neo, cÃ¡   â•‘
â•‘         â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚                          â•‘
â•‘         â”‚  â”‚  â”‚ Copper tube  â”‚  â”‚  â”‚ â† cáº¥p Ä‘iá»‡n (10kV!)    â•‘
â•‘         â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚                          â•‘
â•‘         â”‚  â”‚  â”‚  â”‚ Gel fill â”‚â”‚  â”‚  â”‚ â† chá»‘ng nÆ°á»›c          â•‘
â•‘         â”‚  â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚â”‚  â”‚  â”‚                          â•‘
â•‘         â”‚  â”‚  â”‚  â”‚ â”‚Fiberâ”‚ â”‚â”‚  â”‚  â”‚ â† 8-24 sá»£i quang      â•‘
â•‘         â”‚  â”‚  â”‚  â”‚ â”‚pairsâ”‚ â”‚â”‚  â”‚  â”‚   má»—i sá»£i: 20Tbps+    â•‘
â•‘         â”‚  â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚â”‚  â”‚  â”‚                          â•‘
â•‘         â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚                          â•‘
â•‘         â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                          â•‘
â•‘         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                          â•‘
â•‘         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â•‘
â•‘                                                               â•‘
â•‘  Fun facts:                                                   â•‘
â•‘  â†’ CÃ¡ máº­p Cáº®N cÃ¡p biá»ƒn! (bá»‹ háº¥p dáº«n bá»Ÿi tá»« trÆ°á»ng)       â•‘
â•‘    â†’ Google bá»c thÃªm Kevlar cho cÃ¡p cá»§a há» (2014+)         â•‘
â•‘  â†’ Má» neo tÃ u = nguyÃªn nhÃ¢n #1 gÃ¢y Ä‘á»©t cÃ¡p                â•‘
â•‘  â†’ 1 cÃ¡p Ä‘á»©t = traffic reroute â†’ latency tÄƒng 50-200ms   â•‘
â•‘  â†’ Redundancy: thÆ°á»ng cÃ³ 3-4 Ä‘Æ°á»ng cÃ¡p giá»¯a 2 Ä‘iá»ƒm       â•‘
â•‘                                                               â•‘
â•‘  Google projects:                                             â•‘
â•‘  â†’ "Curie": US â†” Chile (10,500km)                          â•‘
â•‘  â†’ "Equiano": Portugal â†” South Africa (12,000km)           â•‘
â•‘  â†’ "Grace Hopper": US â†” UK â†” Spain (6,300km, 340Tbps!)   â•‘
â•‘  â†’ Tá»•ng Ä‘áº§u tÆ°: >$10 billion (!!)                          â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Data Center Physical Topology â€” CÃ¡ch Bá»‘ TrÃ­ Server Thá»±c Táº¿

Khi báº¡n deploy service lÃªn AWS/GCP, code báº¡n cháº¡y trÃªn server trong **rack**, ná»‘i qua switch theo topology cá»¥ thá»ƒ. Hiá»ƒu topology = hiá»ƒu **latency patterns**:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   DATA CENTER TOPOLOGY â€” SPINE-LEAF                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Modern data centers dÃ¹ng Spine-Leaf (Clos) topology:       â•‘
â•‘                                                               â•‘
â•‘              â”Œâ”€Spine 1â”€â”  â”Œâ”€Spine 2â”€â”  â”Œâ”€Spine 3â”€â”       â•‘
â•‘              â””â”€â”€â”€â”€â”¬â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”¬â”€â”€â”€â”€â”˜       â•‘
â•‘                   â”‚â”‚            â”‚â”‚            â”‚â”‚              â•‘
â•‘           â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚              â•‘
â•‘           â”‚  â”Œâ”€â”€â”€â”€â”˜â”‚       â”Œâ”€â”€â”€â”€â”˜â”‚              â”‚             â•‘
â•‘           â”‚  â”‚     â”‚       â”‚     â”‚              â”‚              â•‘
â•‘        â”Œâ”€â”€â–¼â”€â”€â–¼â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â–¼â”€â” â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”           â•‘
â•‘        â”‚Leaf 1 â”‚ â”‚ Leaf 2   â”‚ â”‚  Leaf 3        â”‚           â•‘
â•‘        â”‚(ToR)  â”‚ â”‚ (ToR)    â”‚ â”‚  (ToR)         â”‚           â•‘
â•‘        â””â”¬â”¬â”¬â”¬â”¬â”¬â”˜ â””â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”˜ â””â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”¬â”˜           â•‘
â•‘         â”‚â”‚â”‚â”‚â”‚â”‚   â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚    â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚               â•‘
â•‘        Servers  Servers       Servers                        â•‘
â•‘        (rack 1) (rack 2)     (rack 3)                       â•‘
â•‘                                                               â•‘
â•‘  ToR (Top-of-Rack) switch = Leaf switch                      â•‘
â•‘  â†’ Má»—i rack 20-48 servers â†’ 1 ToR switch                   â•‘
â•‘  â†’ Server â†” ToR: 10-25Gbps copper (Cat6a, ráº¥t ngáº¯n)        â•‘
â•‘  â†’ ToR â†” Spine: 100-400Gbps fiber (multi-mode, ~100m)     â•‘
â•‘                                                               â•‘
â•‘  Latency implications:                                       â•‘
â•‘  â†’ CÃ¹ng rack (qua 1 ToR):      ~0.1ms (microseconds!)     â•‘
â•‘  â†’ KhÃ¡c rack cÃ¹ng cluster (ToRâ†’Spineâ†’ToR): ~0.3-0.5ms    â•‘
â•‘  â†’ KhÃ¡c AZ (giá»¯a 2 data centers cÃ¡ch 1-3km): ~1-2ms       â•‘
â•‘  â†’ KhÃ¡c region (SGâ†’US): ~150-200ms                          â•‘
â•‘                                                               â•‘
â•‘  Oversubscription:                                           â•‘
â•‘  â†’ 48 servers Ã— 25Gbps = 1.2Tbps tá»•ng capacity             â•‘
â•‘  â†’ ToR uplink: 4Ã—100Gbps = 400Gbps                         â•‘
â•‘  â†’ Oversubscription ratio: 1.2T/400G = 3:1                  â•‘
â•‘  â†’ = khÃ´ng pháº£i táº¥t cáº£ servers Ä‘á»u nÃ³i full speed cÃ¹ng lÃºcâ•‘
â•‘  â†’ Cloud "noisy neighbor" problem: sameracå…± trafficBurst  â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### First Principles â€” Tá»‘c Äá»™ Ãnh SÃ¡ng LÃ  Bá»©c TÆ°á»ng

ÄÃ¢y lÃ  Ä‘iá»u mÃ  nhiá»u Backend Engineer bá» qua khi thiáº¿t káº¿ há»‡ thá»‘ng: **khÃ´ng cÃ³ cache nÃ o, khÃ´ng cÃ³ cÆ¡ sá»Ÿ dá»¯ liá»‡u nÃ o, khÃ´ng cÃ³ thuáº­t toÃ¡n nÃ o cÃ³ thá»ƒ phÃ¡ vá»¡ tá»‘c Ä‘á»™ Ã¡nh sÃ¡ng.**

Ãnh sÃ¡ng trong chÃ¢n khÃ´ng di chuyá»ƒn á»Ÿ **299,792 km/s**. NhÆ°ng trong cÃ¡p quang (fiber optic), do hiá»‡n tÆ°á»£ng khÃºc xáº¡, tá»‘c Ä‘á»™ giáº£m xuá»‘ng cÃ²n khoáº£ng **200,000 km/s** (~2/3 tá»‘c Ä‘á»™ Ã¡nh sÃ¡ng). NgoÃ i ra, cÃ¡p khÃ´ng Ä‘i theo Ä‘Æ°á»ng tháº³ng â€” nÃ³ Ä‘i theo Ä‘Æ°á»ng bá» biá»ƒn, qua cÃ¡c tráº¡m khuáº¿ch Ä‘áº¡i (amplifier repeaters má»—i 60-80km), Ä‘i vÃ²ng qua nÃºi vÃ  Ä‘áº¡i dÆ°Æ¡ng.

**Báº£ng Latency Tham Kháº£o â€” Má»i Backend Engineer Pháº£i Thuá»™c:**

| Route                               | Khoáº£ng cÃ¡ch cÃ¡p | Latency lÃ½ thuyáº¿t | Latency thá»±c táº¿ | Ghi chÃº                   |
| ----------------------------------- | --------------- | ----------------- | --------------- | ------------------------- |
| CÃ¹ng rack                           | ~2m             | 0.01Î¼s            | 0.05-0.1ms      | Microseconds!             |
| CÃ¹ng AZ (AWS)                       | 1-3km           | 0.005ms           | 0.3-0.5ms       | DB luÃ´n cÃ¹ng AZ!          |
| Cross-AZ (cÃ¹ng region)              | 5-15km          | 0.03ms            | 1-2ms           | OK cho redundancy         |
| Singapore â†’ Tokyo                   | ~5,500km        | 27ms              | 60-80ms         | Gáº§n, nhÆ°ng váº«n RTT 120ms+ |
| Singapore â†’ US East                 | ~15,000km       | 75ms              | 180-220ms       | CDN critical!             |
| US East â†’ US West                   | ~4,000km        | 20ms              | 40-60ms         | Cross-region replicate    |
| US East â†’ Europe                    | ~6,000km        | 30ms              | 70-90ms         | Multi-region deployment   |
| Anywhere â†’ LEO Satellite (Starlink) | ~550km altitude | 1.8ms             | 20-40ms         | Cáº£i tiáº¿n vs GEO (600ms!)  |

> **BÃ i há»c cho System Design:**
>
> Khi ai Ä‘Ã³ há»i "táº¡i sao cáº§n CDN?" hay "táº¡i sao cáº§n multi-region?", cÃ¢u tráº£ lá»i cuá»‘i cÃ¹ng LUÃ”N quay vá» Layer 1: **váº­t lÃ½ quyáº¿t Ä‘á»‹nh latency tá»‘i thiá»ƒu**. Má»i tá»‘i Æ°u (caching, connection pooling, HTTP/2) chá»‰ giáº£m **overhead pháº§n má»m**, khÃ´ng giáº£m Ä‘Æ°á»£c **overhead váº­t lÃ½**.
>
> **CDN math:** User á»Ÿ Viá»‡t Nam, origin server á»Ÿ US East:
>
> - KhÃ´ng CDN: 220ms RTT Ã— (DNS + TCP + TLS + HTTP) = **800-1200ms** cho first request!
> - CÃ³ CDN (edge á»Ÿ Singapore): 5ms RTT Ã— (TCP + TLS + HTTP) = **20-50ms** cho cached content!
> - **Cáº£i thiá»‡n 20-40x** chá»‰ báº±ng cÃ¡ch Ä‘áº·t server Gáº¦N user.
>
> ÄÃ¢y cÅ©ng giáº£i thÃ­ch táº¡i sao **cloud providers cÃ³ nhiá»u regions**: AWS cÃ³ 33 regions, GCP cÃ³ 40 regions â€” má»—i region Ä‘áº·t server Gáº¦N user Ä‘á»ƒ giáº£m khoáº£ng cÃ¡ch váº­t lÃ½. Khi thiáº¿t káº¿ há»‡ thá»‘ng, cÃ¢u há»i Ä‘áº§u tiÃªn luÃ´n lÃ : **"Users cá»§a mÃ¬nh á»Ÿ Ä‘Ã¢u?"**
>
> **Framework chá»n region:**
>
> 1. **Users chá»§ yáº¿u á»Ÿ 1 nÆ°á»›c** â†’ chá»n region gáº§n nháº¥t (VN users â†’ `ap-southeast-1` Singapore)
> 2. **Users toÃ n cáº§u, read-heavy** â†’ 1 primary region + CDN + read replicas
> 3. **Users toÃ n cáº§u, write-heavy** â†’ multi-region active-active (cá»±c khÃ³! CRDTs, eventual consistency)
> 4. **Compliance requirements** â†’ data pháº£i á»Ÿ Ä‘Ãºng jurisdiction (GDPR â†’ eu-west, China â†’ cn-north)

---

## Â§2. Layer 2 â€” Data Link: Frame & MAC Address

### BÃ i toÃ¡n gá»‘c: Gá»­i data giá»¯a 2 mÃ¡y CÃ™NG máº¡ng

Layer 1 truyá»n bits, nhÆ°ng nÃ³ giá»‘ng nhÆ° má»™t **dÃ²ng sÃ´ng** â€” bits cháº£y liÃªn tá»¥c mÃ  khÃ´ng ai biáº¿t Ä‘Ã¢u lÃ  báº¯t Ä‘áº§u, Ä‘Ã¢u lÃ  káº¿t thÃºc cá»§a má»™t message. Layer 1 cÅ©ng khÃ´ng biáº¿t náº¿u bits bá»‹ há»ng trÃªn Ä‘Æ°á»ng Ä‘i (do nhiá»…u Ä‘iá»‡n tá»«, sÃ©t Ä‘Ã¡nh, hay Ä‘Æ¡n giáº£n lÃ  cÃ¡p kÃ©m cháº¥t lÆ°á»£ng).

Layer 2 giáº£i quyáº¿t 3 bÃ i toÃ¡n:

1. **Framing**: Ä‘Ã³ng gÃ³i bits thÃ nh cÃ¡c **frame** cÃ³ ranh giá»›i rÃµ rÃ ng (biáº¿t Ä‘Ã¢u lÃ  Ä‘áº§u, Ä‘Ã¢u lÃ  cuá»‘i)
2. **Addressing**: thÃªm Ä‘á»‹a chá»‰ **MAC** Ä‘á»ƒ biáº¿t frame gá»­i cho ai trong LAN
3. **Error Detection**: thÃªm **FCS** (Frame Check Sequence) Ä‘á»ƒ phÃ¡t hiá»‡n bits bá»‹ há»ng

HÃ£y tÆ°á»Ÿng tÆ°á»£ng Layer 1 lÃ  **Ä‘Æ°á»ng á»‘ng nÆ°á»›c** â€” nÆ°á»›c (bits) cháº£y liÃªn tá»¥c. Layer 2 lÃ  ngÆ°á»i **Ä‘Ã³ng gÃ³i nÆ°á»›c vÃ o chai** (frame), ghi **tÃªn ngÆ°á»i nháº­n** trÃªn chai (MAC address), vÃ  **niÃªm phong** Ä‘á»ƒ biáº¿t chai cÃ³ bá»‹ vá»¡ trÃªn Ä‘Æ°á»ng Ä‘i khÃ´ng (FCS checksum).

### Ethernet Frame â€” PhÃ¢n TÃ­ch Tá»«ng Byte

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ETHERNET FRAME (IEEE 802.3) â€” CHI TIáº¾T Tá»ªNG FIELD                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘  â”‚Preamble â”‚Dst   â”‚Src   â”‚Type/ â”‚      Payload            â”‚ FCS  â”‚     â•‘
â•‘  â”‚+ SFD    â”‚MAC   â”‚MAC   â”‚Lengthâ”‚   (46-1500 bytes)       â”‚      â”‚     â•‘
â•‘  â”‚ 8B      â”‚ 6B   â”‚ 6B   â”‚ 2B  â”‚                         â”‚ 4B   â”‚     â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘   â†‘                        â†‘                                â†‘           â•‘
â•‘   â”‚                        â”‚                                â”‚            â•‘
â•‘   â”‚  Preamble (7B):        â”‚  EtherType / Length:           â”‚            â•‘
â•‘   â”‚  10101010 Ã— 7 láº§n     â”‚  0x0800 = IPv4                â”‚            â•‘
â•‘   â”‚  = clock sync pattern  â”‚  0x0806 = ARP                 â”‚            â•‘
â•‘   â”‚                        â”‚  0x86DD = IPv6                â”‚            â•‘
â•‘   â”‚  SFD (1B):             â”‚  0x8100 = VLAN tagged (802.1Q)â”‚            â•‘
â•‘   â”‚  10101011              â”‚  0x8847 = MPLS                â”‚            â•‘
â•‘   â”‚  = "frame báº¯t Ä‘áº§u!"   â”‚                                â”‚            â•‘
â•‘   â”‚                        â”‚                                â”‚            â•‘
â•‘   â”‚                        â”‚  FCS (Frame Check Sequence):  â”‚            â•‘
â•‘   â”‚                        â”‚  CRC-32 polynomial check      â”‚            â•‘
â•‘   â”‚                        â”‚  Receiver tÃ­nh CRC toÃ n frameâ”‚            â•‘
â•‘   â”‚                        â”‚  â†’ Match = OK                 â”‚            â•‘
â•‘   â”‚                        â”‚  â†’ Mismatch = DROP!           â”‚            â•‘
â•‘   â”‚                        â”‚  (khÃ´ng retry, viá»‡c Ä‘Ã³ lÃ  TCP)â”‚            â•‘
â•‘                                                                           â•‘
â•‘  Payload constraints:                                                    â•‘
â•‘  â†’ Minimum: 46 bytes (náº¿u data < 46B â†’ pad thÃªm 0x00)                 â•‘
â•‘    â†’ Táº¡i sao 46B min? VÃ¬ collision detection (CSMA/CD)                 â•‘
â•‘      cáº§n frame Ä‘á»§ dÃ i Ä‘á»ƒ phÃ¡t hiá»‡n collision trÆ°á»›c khi                 â•‘
â•‘      sender gá»­i xong frame. 64B total min cho 10Mbps Ethernet.        â•‘
â•‘  â†’ Maximum: 1500 bytes = MTU (Maximum Transmission Unit)               â•‘
â•‘  â†’ Total frame size: 64-1518 bytes (hoáº·c 9018 vá»›i Jumbo Frames)       â•‘
â•‘                                                                           â•‘
â•‘  Inter-Frame Gap (IFG): 12 bytes thá»i gian nghá»‰ giá»¯a 2 frames        â•‘
â•‘  â†’ Cho receiver thá»i gian xá»­ lÃ½ frame trÆ°á»›c                           â•‘
â•‘  â†’ 10Gbps Ethernet: IFG = 9.6 nanoseconds!                            â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### MAC Address â€” Äá»‹nh Danh Pháº§n Cá»©ng

MAC (Media Access Control) address lÃ  **48-bit address** gÃ¡n cho má»—i network interface, viáº¿t dÆ°á»›i dáº¡ng 6 cáº·p hex: `AA:BB:CC:DD:EE:FF`. NhÆ°ng MAC khÃ´ng Ä‘Æ¡n giáº£n nhÆ° váº» bá» ngoÃ i:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   MAC ADDRESS â€” ANATOMY                                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Format: XX:XX:XX:YY:YY:YY                                  â•‘
â•‘          â”€â”€â”€â”€â”¬â”€â”€â”€â”€ â”€â”€â”€â”€â”¬â”€â”€â”€â”€                                  â•‘
â•‘              â”‚         â”‚                                      â•‘
â•‘         OUI (Org       Device                                â•‘
â•‘         Unique ID)     Unique ID                              â•‘
â•‘                                                               â•‘
â•‘  VÃ­ dá»¥ phá»• biáº¿n OUI:                                        â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â•‘
â•‘  â”‚ OUI        â”‚ Vendor                           â”‚           â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â•‘
â•‘  â”‚ 00:50:56   â”‚ VMware                           â”‚           â•‘
â•‘  â”‚ 02:42:xx   â”‚ Docker container                 â”‚           â•‘
â•‘  â”‚ 0A:58:xx   â”‚ OpenShift / OVN-Kubernetes       â”‚           â•‘
â•‘  â”‚ DC:A6:32   â”‚ Raspberry Pi                     â”‚           â•‘
â•‘  â”‚ AC:DE:48   â”‚ Apple (iPhone/Mac)               â”‚           â•‘
â•‘  â”‚ 3C:22:FB   â”‚ Apple (newer)                    â”‚           â•‘
â•‘  â”‚ FC:34:97   â”‚ ASUSTek (router)                 â”‚           â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â•‘
â•‘                                                               â•‘
â•‘  Bit Ä‘áº·c biá»‡t trong byte Ä‘áº§u tiÃªn:                         â•‘
â•‘                                                               â•‘
â•‘  Bit 0 (LSB) = Unicast/Multicast                            â•‘
â•‘  â†’ 0 = Unicast (gá»­i cho 1 device)                          â•‘
â•‘  â†’ 1 = Multicast (gá»­i cho nhÃ³m)                            â•‘
â•‘  â†’ FF:FF:FF:FF:FF:FF = Broadcast (gá»­i cho Táº¤T Cáº¢)        â•‘
â•‘                                                               â•‘
â•‘  Bit 1 = Global/Local                                        â•‘
â•‘  â†’ 0 = Globally unique (IEEE Ä‘Äƒng kÃ½, MAC "tháº­t")         â•‘
â•‘  â†’ 1 = Locally administered (tá»± gÃ¡n, MAC "áº£o")            â•‘
â•‘  â†’ Docker containers dÃ¹ng locally administered MACs!       â•‘
â•‘  â†’ VM guest NICs cÅ©ng dÃ¹ng locally administered           â•‘
â•‘                                                               â•‘
â•‘  MAC Randomization (privacy):                                â•‘
â•‘  â†’ iOS 14+, Android 10+: random MAC má»—i WiFi network      â•‘
â•‘  â†’ Coffee shop khÃ´ng track Ä‘Æ°á»£c báº¡n qua MAC ná»¯a!          â•‘
â•‘  â†’ âš ï¸ DHCP server assignment pháº£i dÃ¹ng client-id,         â•‘
â•‘    KHÃ”NG NÃŠN dÃ¹ng MAC cá»‘ Ä‘á»‹nh ná»¯a                          â•‘
â•‘                                                               â•‘
â•‘  Backend relevance:                                          â•‘
â•‘  â†’ Debug: `ip link show` â†’ xem MAC cá»§a interfaces          â•‘
â•‘  â†’ Docker: má»—i container = 1 veth pair = 1 MAC áº£o        â•‘
â•‘  â†’ K8s: pod MAC visible trong `ip link` bÃªn trong pod      â•‘
â•‘  â†’ Cloud: EC2 ENI (Elastic Network Interface) = 1 MAC      â•‘
â•‘  â†’ MAC spoofing detection quan trá»ng cho security!          â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### ARP â€” "PhiÃªn Dá»‹ch" Giá»¯a IP vÃ  MAC

Khi mÃ¡y A muá»‘n gá»­i data Ä‘áº¿n mÃ¡y B trong cÃ¹ng LAN, nÃ³ biáº¿t **IP** cá»§a B (vÃ­ dá»¥ 192.168.1.5) nhÆ°ng Layer 2 cáº§n **MAC address**. ARP (Address Resolution Protocol) giáº£i quyáº¿t bÃ i toÃ¡n nÃ y â€” nÃ³ lÃ  **cáº§u ná»‘i giá»¯a Layer 2 (MAC) vÃ  Layer 3 (IP)**.

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ARP â€” ADDRESS RESOLUTION PROTOCOL                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  ARP Request/Reply Flow:                                     â•‘
â•‘                                                               â•‘
â•‘  MÃ¡y A (192.168.1.2) muá»‘n gá»­i Ä‘áº¿n MÃ¡y B (192.168.1.5):    â•‘
â•‘                                                               â•‘
â•‘  â‘  A kiá»ƒm tra ARP cache (báº£ng IPâ†’MAC local)                â•‘
â•‘     â†’ Cache miss! ChÆ°a biáº¿t MAC cá»§a B                       â•‘
â•‘                                                               â•‘
â•‘  â‘¡ A gá»­i ARP Request (broadcast â†’ FF:FF:FF:FF:FF:FF)       â•‘
â•‘     Ná»™i dung: "Ai cÃ³ IP 192.168.1.5? HÃ£y tráº£ lá»i cho      â•‘
â•‘     192.168.1.2 (MAC: AA:11:22:33:44:55)"                   â•‘
â•‘     â†’ Má»ŒI mÃ¡y trong LAN Ä‘á»u nháº­n!                          â•‘
â•‘     â†’ MÃ¡y C, D, E: "khÃ´ng pháº£i tÃ´i" â†’ ignore              â•‘
â•‘                                                               â•‘
â•‘  â‘¢ B nháº­n: "ÄÃ³ lÃ  IP cá»§a tÃ´i!"                              â•‘
â•‘     â†’ B cÅ©ng cache MAC cá»§a A (vÃ¬ biáº¿t A sáº½ gá»­i data)     â•‘
â•‘     â†’ B gá»­i ARP Reply (unicast â†’ chá»‰ cho A)               â•‘
â•‘     "192.168.1.5 = BB:66:77:88:99:AA"                       â•‘
â•‘                                                               â•‘
â•‘  â‘£ A cache: 192.168.1.5 â†’ BB:66:77:88:99:AA                â•‘
â•‘     â†’ Cache TTL: Linux 30-300 giÃ¢y (tuá»•i thá» ngáº¯n!)       â•‘
â•‘     â†’ Sau Ä‘Ã³ pháº£i ARP láº¡i                                   â•‘
â•‘                                                               â•‘
â•‘  â±ï¸ ARP overhead: 1 broadcast + 1 unicast = ~1ms           â•‘
â•‘  â†’ Vá»›i 1000 hosts, má»—i host ARP má»—i 60s = 16 ARP/giÃ¢y   â•‘
â•‘  â†’ Broadcast storm náº¿u quÃ¡ nhiá»u hosts trong 1 VLAN!      â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**CÃ¡c loáº¡i ARP Ä‘áº·c biá»‡t:**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ARP VARIANTS â€” KHÃ”NG CHá»ˆ CÃ“ REQUEST/REPLY                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â‘  Gratuitous ARP (GARP):                                   â•‘
â•‘  â†’ MÃ¡y gá»­i ARP request cho CHÃNH IP Cá»¦A MÃŒNH              â•‘
â•‘  â†’ Má»¥c Ä‘Ã­ch: "TÃ´i vá»«a thay Ä‘á»•i MAC, cáº­p nháº­t Ä‘i!"        â•‘
â•‘  â†’ Use cases:                                                â•‘
â•‘    â†’ Failover (VRRP/HSRP): backup server lÃªn lÃ m primary  â•‘
â•‘      â†’ Gá»­i GARP: "IP 10.0.0.1 giá» á»Ÿ MAC má»›i"             â•‘
â•‘      â†’ Táº¤T Cáº¢ hosts update ARP cache â†’ traffic chuyá»ƒn!    â•‘
â•‘    â†’ Duplicate IP detection: náº¿u ai reply â†’ IP bá»‹ trÃ¹ng!  â•‘
â•‘    â†’ AWS EIP reassignment: EC2 GARP khi Elastic IP chuyá»ƒn â•‘
â•‘                                                               â•‘
â•‘  â‘¡ Proxy ARP:                                                â•‘
â•‘  â†’ Router tráº£ lá»i ARP thay cho host á»Ÿ Máº NG KHÃC           â•‘
â•‘  â†’ Host A (10.0.1.0/24) ARP cho 10.0.2.5 (khÃ¡c subnet)   â•‘
â•‘  â†’ Router: "MAC cá»§a tÃ´i Ä‘Ã¢y!" â†’ A gá»­i frame cho Router   â•‘
â•‘  â†’ Router forward Ä‘áº¿n máº¡ng 10.0.2.0/24                      â•‘
â•‘  â†’ âš ï¸ Security risk: attacker cÃ³ thá»ƒ proxy ARP giáº£!      â•‘
â•‘                                                               â•‘
â•‘  â‘¢ ARP Spoofing / Poisoning:                                 â•‘
â•‘  â†’ Attacker gá»­i fake ARP reply liÃªn tá»¥c:                   â•‘
â•‘    "192.168.1.1 (gateway) = ATTACKER_MAC"                   â•‘
â•‘  â†’ Victims update ARP cache â†’ gá»­i traffic qua attacker!  â•‘
â•‘  â†’ = Man-in-the-Middle attack!                              â•‘
â•‘  â†’ Attacker Ä‘á»c Ä‘Æ°á»£c password, session tokens, API keys!  â•‘
â•‘                                                               â•‘
â•‘  FIX:                                                         â•‘
â•‘  â†’ Dynamic ARP Inspection (DAI) trÃªn managed switch        â•‘
â•‘  â†’ Static ARP entries cho critical servers (gateway, DB)    â•‘
â•‘  â†’ 802.1X port authentication                                â•‘
â•‘  â†’ Encrypted protocols (HTTPS, SSH) â†’ Ä‘á»c Ä‘Æ°á»£c nhÆ°ng      â•‘
â•‘    khÃ´ng decrypt Ä‘Æ°á»£c â†’ giáº£m impact                        â•‘
â•‘                                                               â•‘
â•‘  â‘£ IPv6: ARP bá»‹ thay báº±ng NDP (Neighbor Discovery Protocol)â•‘
â•‘  â†’ ICMPv6 Neighbor Solicitation/Advertisement               â•‘
â•‘  â†’ Multicast thay vÃ¬ broadcast â†’ hiá»‡u quáº£ hÆ¡n!           â•‘
â•‘  â†’ TÃ­ch há»£p SLAAC (auto IP config, khÃ´ng cáº§n DHCP!)       â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Debug ARP:**

```bash
# Xem ARP cache hiá»‡n táº¡i
arp -n                          # Linux/Mac
ip neigh show                   # Linux (modern)

# Output vÃ­ dá»¥:
# 192.168.1.1 dev eth0 lladdr aa:bb:cc:dd:ee:ff REACHABLE
# 192.168.1.5 dev eth0 lladdr 11:22:33:44:55:66 STALE
#                                                    â†‘
# States: REACHABLE (má»›i confirm), STALE (cáº§n re-verify),
#         DELAY (Ä‘ang chá» probe), FAILED (unreachable)

# Clear ARP cache (debug)
sudo ip neigh flush all

# Watch ARP traffic real-time
sudo tcpdump -i eth0 arp -n
# Output: "ARP, Request who-has 192.168.1.5 tell 192.168.1.2"
# Output: "ARP, Reply 192.168.1.5 is-at bb:66:77:88:99:aa"
```

### Switch â€” "Hub ThÃ´ng Minh" VÃ  MAC Learning

Switch lÃ  thiáº¿t bá»‹ **Layer 2** quan trá»ng nháº¥t. NÃ³ khÃ´ng chá»‰ forward frames â€” nÃ³ **há»c** vÃ  ra **quyáº¿t Ä‘á»‹nh intelligent**:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   SWITCH â€” MAC LEARNING & FORWARDING                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  MAC Address Table (CAM Table):                              â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â•‘
â•‘  â”‚ Port â”‚ MAC Address         â”‚ Age/Timerâ”‚                   â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â•‘
â•‘  â”‚ 1    â”‚ AA:11:22:33:44:55  â”‚ 120s     â”‚                   â•‘
â•‘  â”‚ 3    â”‚ BB:66:77:88:99:AA  â”‚ 45s      â”‚                   â•‘
â•‘  â”‚ 7    â”‚ CC:DD:EE:11:22:33  â”‚ 200s     â”‚                   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â•‘
â•‘                                                               â•‘
â•‘  QuÃ¡ trÃ¬nh xá»­ lÃ½ frame:                                      â•‘
â•‘                                                               â•‘
â•‘  Frame vÃ o port 1, Src MAC = AA:11, Dst MAC = BB:66         â•‘
â•‘                                                               â•‘
â•‘  â‘  LEARN: "MAC AA:11 á»Ÿ port 1" â†’ cáº­p nháº­t CAM table       â•‘
â•‘  â‘¡ LOOKUP: tÃ¬m BB:66 trong CAM table                        â•‘
â•‘     â†’ Found: port 3 â†’ FORWARD chá»‰ ra port 3               â•‘
â•‘     â†’ Not found: FLOOD ra Táº¤T Cáº¢ ports (trá»« port vÃ o!)   â•‘
â•‘  â‘¢ AGING: entries > 300s (default) â†’ xÃ³a                    â•‘
â•‘     â†’ Tá»± há»c láº¡i khi cÃ³ traffic má»›i                        â•‘
â•‘                                                               â•‘
â•‘  Flooding scenarios:                                          â•‘
â•‘  â†’ Unknown unicast: chÆ°a cÃ³ trong CAM â†’ flood              â•‘
â•‘  â†’ Broadcast (FF:FF:FF:FF:FF:FF): LUÃ”N flood               â•‘
â•‘  â†’ Multicast: flood (trá»« khi IGMP snooping enabled)        â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ MAC Flooding Attack:                                    â•‘
â•‘  â†’ Attacker gá»­i hÃ ng nghÃ¬n frame vá»›i random src MACs       â•‘
â•‘  â†’ CAM table FULL (typical: 8K-32K entries)                â•‘
â•‘  â†’ Switch chuyá»ƒn sang "fail-open" = flood má»i thá»©!        â•‘
â•‘  â†’ = Attacker tháº¥y Táº¤T Cáº¢ traffic! (hub behavior)         â•‘
â•‘  â†’ FIX: port security (limit MAC per port)                  â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Switch vs Hub vs Router â€” Layer nÃ o?

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   THIáº¾T Bá»Š Máº NG â€” SO SÃNH CHI TIáº¾T                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  HUB (Layer 1) â€” "Repeater ngu":                            â•‘
â•‘  â†’ Nháº­n signal â†’ copy ra Táº¤T Cáº¢ ports (ká»ƒ cáº£ port gá»­i!) â•‘
â•‘  â†’ KhÃ´ng biáº¿t MAC, khÃ´ng Ä‘á»c frame header                   â•‘
â•‘  â†’ Shared bandwidth: 100Mbps Ã· 10 ports = 10Mbps/port     â•‘
â•‘  â†’ Collision domain: Táº¤T Cáº¢ ports = 1 collision domain    â•‘
â•‘  â†’ Half-duplex only (CSMA/CD collision detection)           â•‘
â•‘  â†’ ÄÃƒ Lá»–I THá»œI! KhÃ´ng ai dÃ¹ng hub ná»¯a.                  â•‘
â•‘                                                               â•‘
â•‘  SWITCH (Layer 2) â€” "Hub thÃ´ng minh":                        â•‘
â•‘  â†’ Äá»c MAC header â†’ forward ÄÃšNG port                      â•‘
â•‘  â†’ MAC learning: tá»± xÃ¢y dá»±ng MAC address table             â•‘
â•‘  â†’ Dedicated bandwidth: má»—i port = full bandwidth!         â•‘
â•‘  â†’ Má»—i port = 1 collision domain riÃªng                     â•‘
â•‘  â†’ Full-duplex (no collision!)                               â•‘
â•‘  â†’ VLAN support: chia logic thÃ nh multiple networks         â•‘
â•‘  â†’ Store-and-forward: nháº­n toÃ n bá»™ frame, check CRC, rá»“i  â•‘
â•‘    má»›i forward â†’ an toÃ n hÆ¡n                               â•‘
â•‘  â†’ Cut-through: báº¯t Ä‘áº§u forward ngay khi Ä‘á»c Ä‘Æ°á»£c Dst    â•‘
â•‘    MAC â†’ nhanh hÆ¡n, nhÆ°ng khÃ´ng check CRC trÆ°á»›c            â•‘
â•‘                                                               â•‘
â•‘  L3 SWITCH (Layer 2+3) â€” "Switch biáº¿t route":               â•‘
â•‘  â†’ Switch + routing capabilities (ASIC hardware)            â•‘
â•‘  â†’ Route giá»¯a VLANs (inter-VLAN routing)                   â•‘
â•‘  â†’ Wire-speed routing: nhanh nhÆ° switching!                  â•‘
â•‘  â†’ DÃ¹ng trong data center: ToR switch thÆ°á»ng lÃ  L3 switch  â•‘
â•‘                                                               â•‘
â•‘  ROUTER (Layer 3) â€” "BÆ°u Ä‘iá»‡n":                             â•‘
â•‘  â†’ Káº¿t ná»‘i KHÃC máº¡ng (different subnets/networks)          â•‘
â•‘  â†’ Äá»c IP header â†’ quyáº¿t Ä‘á»‹nh next hop (routing table)    â•‘
â•‘  â†’ NAT: translate private IP â†” public IP                   â•‘
â•‘  â†’ Firewall: filter traffic dá»±a trÃªn IP/port              â•‘
â•‘  â†’ QoS: Æ°u tiÃªn traffic (voice > download)                 â•‘
â•‘  â†’ NhÃ  báº¡n: WiFi "router" = router + switch + AP + FW     â•‘
â•‘                                                               â•‘
â•‘  Traffic flow trong real network:                            â•‘
â•‘  App â†’ NIC â†’ Switch â†’ Router â†’ Internet â†’ Router â†’ Switch â•‘
â•‘  â†’ NIC â†’ App                                                 â•‘
â•‘  (Layer 7â†’1â†’2â†’3â†’...â†’3â†’2â†’1â†’7)                             â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### VLAN â€” Chia TÃ¡ch Logic TrÃªn CÃ¹ng Switch

**VLAN (Virtual LAN)** cho phÃ©p báº¡n chia 1 switch váº­t lÃ½ thÃ nh **nhiá»u máº¡ng LAN logic** â€” machines trong VLAN khÃ¡c nhau KHÃ”NG THá»‚ communicate trá»±c tiáº¿p (pháº£i qua router/L3 switch).

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   VLAN â€” VIRTUAL LAN (IEEE 802.1Q)                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Táº¡i sao cáº§n VLAN?                                           â•‘
â•‘  â†’ Security: isolate traffic (HR khÃ´ng tháº¥y R&D traffic)   â•‘
â•‘  â†’ Performance: giáº£m broadcast domain size                  â•‘
â•‘    â†’ 1000 hosts, 1 VLAN = 1000 hosts nháº­n má»—i broadcast   â•‘
â•‘    â†’ 10 VLANs Ã— 100 hosts = má»—i broadcast chá»‰ 100 hosts  â•‘
â•‘  â†’ Flexibility: move machines giá»¯a "networks" mÃ  khÃ´ng    â•‘
â•‘    cáº§n Ä‘á»•i dÃ¢y physical                                     â•‘
â•‘                                                               â•‘
â•‘  802.1Q Tag (4 bytes thÃªm vÃ o Ethernet frame):              â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚Preambleâ”‚Dst   â”‚Src   â”‚802.1Qâ”‚Type â”‚ Payload  â”‚FCS  â”‚    â•‘
â•‘  â”‚        â”‚MAC   â”‚MAC   â”‚ Tag  â”‚     â”‚          â”‚     â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                             â”‚                                 â•‘
â•‘                             â–¼                                 â•‘
â•‘                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â•‘
â•‘                    â”‚ TPID  â”‚Priorityâ”‚                         â•‘
â•‘                    â”‚0x8100 â”‚ (3bit) â”‚                         â•‘
â•‘                    â”‚       â”‚ DEI(1) â”‚                         â•‘
â•‘                    â”‚       â”‚VLAN ID â”‚                         â•‘
â•‘                    â”‚       â”‚(12bit) â”‚                         â•‘
â•‘                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â•‘
â•‘                                                               â•‘
â•‘  VLAN ID: 12 bits â†’ 0-4095 (4096 VLANs tá»‘i Ä‘a)            â•‘
â•‘  â†’ VLAN 0: priority tagging only                            â•‘
â•‘  â†’ VLAN 1: default VLAN (native, KHÃ”NG tag)                â•‘
â•‘  â†’ VLAN 2-4094: usable                                      â•‘
â•‘  â†’ VLAN 4095: reserved                                       â•‘
â•‘                                                               â•‘
â•‘  Port types:                                                  â•‘
â•‘  â†’ Access port: gáº¯n vÃ o 1 VLAN, KHÃ”NG cÃ³ tag               â•‘
â•‘    â†’ Endpoint devices (PC, server) cáº¯m vÃ o Ä‘Ã¢y            â•‘
â•‘  â†’ Trunk port: mang traffic NHIá»€U VLANs, CÃ“ tag            â•‘
â•‘    â†’ Switch-to-switch, switch-to-router links               â•‘
â•‘    â†’ Native VLAN: traffic KHÃ”NG tag Ä‘i trÃªn trunk          â•‘
â•‘                                                               â•‘
â•‘  Real-world analogy (K8s):                                   â•‘
â•‘  â†’ VLAN â‰ˆ Kubernetes Namespace                              â•‘
â•‘  â†’ Pods trong namespace khÃ¡c nhau KHÃ”NG auto-communicate    â•‘
â•‘  â†’ NetworkPolicy â‰ˆ inter-VLAN firewall rules               â•‘
â•‘  â†’ Service mesh (Istio) â‰ˆ managed L2/L3 routing            â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Double Tagging Attack (VLAN Hopping):                   â•‘
â•‘  â†’ Attacker gá»­i frame vá»›i 2 VLAN tags                      â•‘
â•‘  â†’ Switch strip tag ngoÃ i (native VLAN) â†’ forward          â•‘
â•‘  â†’ Frame váº«n cÃ²n tag trong â†’ Ä‘áº¿n VLAN khÃ¡c!               â•‘
â•‘  â†’ FIX: native VLAN â‰  any user VLAN, set native vlan 999  â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### STP â€” Spanning Tree Protocol: Chá»‘ng Loop

Khi báº¡n ná»‘i 2+ switches báº±ng nhiá»u Ä‘Æ°á»ng (redundancy), loops cÃ³ thá»ƒ xáº£y ra: frame Aâ†’Bâ†’Câ†’Aâ†’Bâ†’C... láº·p vÃ´ táº­n! **Broadcast storm** = máº¡ng sáº­p trong vÃ i giÃ¢y!

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   STP â€” SPANNING TREE PROTOCOL (IEEE 802.1D)                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Váº¥n Ä‘á» â€” Broadcast Storm:                                  â•‘
â•‘                                                               â•‘
â•‘  Switch A â†â”€â”€link1â”€â”€â†’ Switch B                               â•‘
â•‘     â†‘                    â†‘                                    â•‘
â•‘     â””â”€â”€â”€â”€â”€â”€ link2 â”€â”€â”€â”€â”€â”€â”€â”˜                                    â•‘
â•‘                                                               â•‘
â•‘  Broadcast frame tá»« PC1 (trÃªn Switch A):                    â•‘
â•‘  â†’ A forward qua link1 â†’ B                                  â•‘
â•‘  â†’ B forward qua link2 â†’ A                                  â•‘
â•‘  â†’ A forward qua link1 â†’ B  (Láº¶P VÃ” Táº¬N!)                â•‘
â•‘  â†’ CPU 100%, network DOWN trong giÃ¢y!                        â•‘
â•‘                                                               â•‘
â•‘  STP giáº£i quyáº¿t: BLOCK 1 link, giá»¯ 1 link active           â•‘
â•‘                                                               â•‘
â•‘  â‘  Báº§u Root Bridge (switch cÃ³ Bridge ID tháº¥p nháº¥t)         â•‘
â•‘  â‘¡ TÃ­nh shortest path tá»« má»—i switch Ä‘áº¿n Root               â•‘
â•‘  â‘¢ Port states:                                              â•‘
â•‘     â†’ Root port: path tá»‘t nháº¥t Ä‘áº¿n Root (FORWARDING)       â•‘
â•‘     â†’ Designated port: best port on segment (FORWARDING)    â•‘
â•‘     â†’ Blocked port: redundant path (BLOCKING)               â•‘
â•‘                                                               â•‘
â•‘  Switch A â†â”€â”€link1 (FORWARDING)â”€â”€â†’ Switch B                  â•‘
â•‘     â†‘                                  â†‘                      â•‘
â•‘     â””â”€â”€â”€â”€ link2 (BLOCKED) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â•‘
â•‘                                                               â•‘
â•‘  Náº¿u link1 down â†’ STP detect â†’ unblock link2 â†’ recover!  â•‘
â•‘  âš ï¸ STP convergence: 30-50 giÃ¢y (802.1D)                   â•‘
â•‘  â†’ 50 giÃ¢y network DOWN khi failover?! Ráº¤T LÃ‚U!          â•‘
â•‘                                                               â•‘
â•‘  RSTP (Rapid STP, 802.1w): convergence 1-3 giÃ¢y            â•‘
â•‘  â†’ Proposal/Agreement mechanism thay vÃ¬ timer-based        â•‘
â•‘  â†’ Modern switches dÃ¹ng RSTP (hoáº·c MSTP cho multiple VLANs)â•‘
â•‘                                                               â•‘
â•‘  Backend relevance:                                          â•‘
â•‘  â†’ Data center: STP/RSTP váº«n cháº¡y trÃªn L2 switches        â•‘
â•‘  â†’ Cloud: áº©n dÆ°á»›i AWS/GCP infra (báº¡n khÃ´ng config trá»±c tiáº¿p)â•‘
â•‘  â†’ NhÆ°ng: hiá»ƒu STP giÃºp debug "táº¡i sao failover cháº­m?"   â•‘
â•‘  â†’ Modern DC: dÃ¹ng L3 routing (ECMP) thay vÃ¬ STP           â•‘
â•‘    â†’ Má»—i ToR switch = 1 L3 domain â†’ khÃ´ng cáº§n STP!       â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### L2 Trong Cloud & Containers â€” Virtual Networking

Khi báº¡n cháº¡y Docker container hay K8s pod, **máº¡ng Layer 2 Ä‘Æ°á»£c áº£o hÃ³a**. Hiá»ƒu cÆ¡ cháº¿ nÃ y = debug network issues hiá»‡u quáº£ hÆ¡n 10x:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   L2 TRONG DOCKER & KUBERNETES                                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Docker Bridge Network:                                      â•‘
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ Host Machine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â•‘
â•‘  â”‚                                                â”‚           â•‘
â•‘  â”‚  â”Œâ”€Container Aâ”€â”    â”Œâ”€Container Bâ”€â”         â”‚           â•‘
â•‘  â”‚  â”‚  eth0       â”‚    â”‚  eth0       â”‚         â”‚           â•‘
â•‘  â”‚  â”‚  172.17.0.2 â”‚    â”‚  172.17.0.3 â”‚         â”‚           â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚           â•‘
â•‘  â”‚         â”‚ veth1            â”‚ veth2            â”‚           â•‘
â•‘  â”‚         â”‚                  â”‚                  â”‚           â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”          â”‚           â•‘
â•‘  â”‚  â”‚       docker0 (Linux bridge)    â”‚          â”‚           â•‘
â•‘  â”‚  â”‚       172.17.0.1                â”‚          â”‚           â•‘
â•‘  â”‚  â”‚       = SOFTWARE SWITCH!        â”‚          â”‚           â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚           â•‘
â•‘  â”‚                â”‚ NAT (iptables)               â”‚           â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚           â•‘
â•‘  â”‚  â”‚       eth0 (host NIC)           â”‚          â”‚           â•‘
â•‘  â”‚  â”‚       192.168.1.100             â”‚          â”‚           â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚           â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â•‘
â•‘                                                               â•‘
â•‘  Giáº£i thÃ­ch:                                                  â•‘
â•‘  â†’ veth pair = "virtual cable" káº¿t ná»‘i container â†” bridge  â•‘
â•‘  â†’ docker0 = Linux bridge = Layer 2 software switch!        â•‘
â•‘  â†’ MAC learning: bridge há»c MAC cá»§a má»—i container          â•‘
â•‘  â†’ Container â†’ Container (cÃ¹ng bridge): L2 forwarding      â•‘
â•‘  â†’ Container â†’ Internet: NAT qua host (iptables MASQUERADE)â•‘
â•‘                                                               â•‘
â•‘  Kubernetes CNI (Container Network Interface):               â•‘
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€ Node 1 â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€ Node 2 â”€â”€â”€â”€â”€â”               â•‘
â•‘  â”‚  Pod A    Pod B  â”‚    â”‚  Pod C    Pod D  â”‚               â•‘
â•‘  â”‚  10.1.1.2 10.1.1.3â”‚    â”‚ 10.1.2.2 10.1.2.3â”‚               â•‘
â•‘  â”‚      â”‚        â”‚   â”‚    â”‚     â”‚        â”‚   â”‚               â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â” â”‚    â”‚ â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â” â”‚               â•‘
â•‘  â”‚  â”‚ cbr0/cni0   â”‚ â”‚    â”‚ â”‚ cbr0/cni0   â”‚ â”‚               â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚               â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â•‘
â•‘            â”‚         VXLAN/        â”‚                          â•‘
â•‘            â””â”€â”€â”€ Geneve tunnel â”€â”€â”€â”€â”€â”˜                         â•‘
â•‘                  (L2 over L3!)                                â•‘
â•‘                                                               â•‘
â•‘  Overlay Networks (VXLAN/Geneve):                            â•‘
â•‘  â†’ Encapsulate L2 frame bÃªn trong UDP packet (L4)!         â•‘
â•‘  â†’ Pod A gá»­i frame â†’ wrap trong UDP â†’ gá»­i qua network    â•‘
â•‘  â†’ Node 2 unwrap â†’ deliver L2 frame cho Pod C             â•‘
â•‘  â†’ = "giáº£ láº­p" ráº±ng táº¥t cáº£ pods á»Ÿ cÃ¹ng 1 LAN!           â•‘
â•‘  â†’ VXLAN header thÃªm 50 bytes overhead!                     â•‘
â•‘    â†’ MTU issue: 1500 - 50 = 1450 bytes effective MTU       â•‘
â•‘    â†’ ÄÃ‚Y LÃ€ NGUYÃŠN NHÃ‚N #1 gÃ¢y network issues trong K8s! â•‘
â•‘                                                               â•‘
â•‘  Debug L2 trong container:                                   â•‘
â•‘  â†’ docker exec -it <container> ip link show                 â•‘
â•‘  â†’ kubectl exec -it <pod> -- ip addr                        â•‘
â•‘  â†’ brctl show (xem Linux bridge info)                       â•‘
â•‘  â†’ bridge fdb show (xem MAC forwarding database)            â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### MTU & Backend: Táº¡i Sao gRPC Streaming ÄÃ´i Khi Lá»—i?

**MTU (Maximum Transmission Unit)** = kÃ­ch thÆ°á»›c payload tá»‘i Ä‘a cá»§a 1 Ethernet frame, máº·c Ä‘á»‹nh **1500 bytes**. ÄÃ¢y lÃ  con sá»‘ quan trá»ng mÃ  nhiá»u Backend Engineer khÃ´ng biáº¿t, nhÆ°ng nÃ³ gÃ¢y ra **ráº¥t nhiá»u bugs bÃ­ áº©n**:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   MTU â€” MAXIMUM TRANSMISSION UNIT                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Payload trong Ethernet frame:                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â•‘
â•‘  â”‚       Ethernet Frame (max 1518 bytes)      â”‚              â•‘
â•‘  â”‚ ETH header(14B) + Payload(1500B) + FCS(4B) â”‚              â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â•‘
â•‘                                                               â•‘
â•‘  MSS (Maximum Segment Size) = MTU - IP header - TCP header  â•‘
â•‘  â†’ 1500 - 20 - 20 = 1460 bytes (typical TCP payload max)   â•‘
â•‘  â†’ Vá»›i TCP timestamps option: 1500 - 20 - 32 = 1448 bytes  â•‘
â•‘                                                               â•‘
â•‘  1MB gRPC message:                                           â•‘
â•‘  â†’ 1,048,576 / 1460 = 719 TCP segments!                     â•‘
â•‘  â†’ 719 Ã— 54B overhead = 38KB header overhead (3.6%)        â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Path MTU Discovery (PMTUD)** â€” táº¡i sao connection bá»‹ treo:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   PATH MTU DISCOVERY â€” BáºªY NGUY HIá»‚M                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Server (MTU=1500)                                           â•‘
â•‘    â”‚                                                          â•‘
â•‘    â”‚ packet size = 1500                                       â•‘
â•‘    â–¼                                                          â•‘
â•‘  Router A (MTU=1500) â†’ OK, forward                           â•‘
â•‘    â”‚                                                          â•‘
â•‘    â”‚ packet size = 1500                                       â•‘
â•‘    â–¼                                                          â•‘
â•‘  VPN/Tunnel (MTU=1400) â†’ PACKET TOO BIG!                    â•‘
â•‘    â”‚                                                          â•‘
â•‘    â”‚ DF flag set (Don't Fragment)                             â•‘
â•‘    â”‚ â†’ Send ICMP "Fragmentation Needed" back to sender      â•‘
â•‘    â”‚ â†’ Sender giáº£m packet size â†’ 1400                       â•‘
â•‘    â–¼                                                          â•‘
â•‘  Client (MTU=1500)                                           â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Náº¾U firewall BLOCK ICMP:                                â•‘
â•‘  â†’ Server KHÃ”NG nháº­n Ä‘Æ°á»£c "Packet Too Big"                  â•‘
â•‘  â†’ Tiáº¿p tá»¥c gá»­i 1500B packets                              â•‘
â•‘  â†’ Router DROP â†’ connection TREO!                           â•‘
â•‘  â†’ Gá»i lÃ  "PMTUD Black Hole"                               â•‘
â•‘  â†’ DEBUG: small requests OK, large responses HANG            â•‘
â•‘    (vÃ¬ small responses < 1400B = khÃ´ng bá»‹ drop!)            â•‘
â•‘                                                               â•‘
â•‘  FIX:                                                         â•‘
â•‘  â†’ KHÃ”NG BAO GIá»œ block ALL ICMP trÃªn firewall!             â•‘
â•‘  â†’ Allow ICMP Type 3 Code 4 (Fragmentation Needed)          â•‘
â•‘  â†’ TCP MSS clamping trÃªn router/VPN gateway                 â•‘
â•‘  â†’ Set MTU manually: ip link set dev eth0 mtu 1400          â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Jumbo Frames & K8s MTU issues:**

- **Jumbo Frames (MTU 9000)**: dÃ¹ng trong data center Ä‘á»ƒ giáº£m header overhead. Má»—i frame chá»©a 9000B thay vÃ¬ 1500B â†’ giáº£m 6x sá»‘ frames â†’ giáº£m CPU interrupt, tÄƒng throughput 10-20% cho big data transfers (Hadoop, Spark, DB replication).

- **Docker/Kubernetes MTU mismatch** â€” **nguyÃªn nhÃ¢n #1 cá»§a network bugs bÃ­ áº©n trong K8s:**
  - Host MTU = 1500, VXLAN overlay thÃªm 50 bytes â†’ effective MTU = 1450
  - Container MTU váº«n = 1500 â†’ packets lá»›n bá»‹ DROP!
  - **Symptom**: small requests work, large responses fail/timeout
  - **Debug**: `kubectl exec -it <pod> -- cat /sys/class/net/eth0/mtu` vs host `cat /sys/class/net/eth0/mtu`
  - **Fix**: Set container MTU = host MTU - overlay overhead (Calico: `mtu: 1440`, Flannel: `net-conf.json`)
  - **AWS EKS**: amazon-vpc-cni tá»± handle MTU, nhÆ°ng custom CNIs cáº§n manual config!

---

## Â§3. Layer 3 â€” Network: IP & Routing

### BÃ i toÃ¡n gá»‘c: Gá»­i data giá»¯a 2 mÃ¡y KHÃC máº¡ng

Layer 2 chá»‰ hoáº¡t Ä‘á»™ng trong LAN (cÃ¹ng switch/WiFi). Giá»‘ng nhÆ° gá»­i thÆ° trong cÃ¹ng má»™t tÃ²a nhÃ  â€” chá»‰ cáº§n biáº¿t sá»‘ phÃ²ng (MAC). NhÆ°ng náº¿u báº¡n muá»‘n gá»­i thÆ° Ä‘áº¿n **má»™t thÃ nh phá»‘ khÃ¡c**, báº¡n cáº§n **Ä‘á»‹a chá»‰** (IP address) vÃ  **há»‡ thá»‘ng bÆ°u Ä‘iá»‡n** (routing) Ä‘á»ƒ chuyá»ƒn thÆ° qua nhiá»u tráº¡m trung chuyá»ƒn.

Layer 3 chÃ­nh lÃ  **há»‡ thá»‘ng bÆ°u Ä‘iá»‡n** cá»§a Internet:

- **IP address** = Ä‘á»‹a chá»‰ nhÃ  (sá»‘ nhÃ , Ä‘Æ°á»ng, thÃ nh phá»‘)
- **Subnet** = khu phá»‘ (cÃ¹ng mÃ£ bÆ°u chÃ­nh)
- **Router** = tráº¡m bÆ°u Ä‘iá»‡n (nháº­n thÆ°, quyáº¿t Ä‘á»‹nh gá»­i tiáº¿p Ä‘áº¿n Ä‘Ã¢u)
- **Routing table** = báº£n Ä‘á»“ bÆ°u chÃ­nh (biáº¿t khu phá»‘ nÃ o thuá»™c tráº¡m nÃ o)

### IP Header â€” PhÃ¢n TÃ­ch Tá»«ng Field

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   IPv4 HEADER â€” 20 BYTES (CHI TIáº¾T Tá»ªNG FIELD)                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                       â•‘
â•‘  0                   1                   2                   3       â•‘
â•‘  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚Versionâ”‚  IHL  â”‚    DSCP/ECN   â”‚          Total Length          â”‚ â•‘
â•‘  â”‚  (4)  â”‚  (5)  â”‚   (QoS/Cong) â”‚        (max 65535 bytes)       â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚ Identification   â”‚Flagsâ”‚ Fragment Offset                      â”‚ â•‘
â•‘  â”‚ (fragment group) â”‚DF MFâ”‚ (náº¿u bá»‹ fragment)                    â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚       TTL        â”‚Protocolâ”‚       Header Checksum              â”‚ â•‘
â•‘  â”‚  (max 255 hops)  â”‚6=TCP   â”‚  (chá»‰ check header, khÃ´ng data)  â”‚ â•‘
â•‘  â”‚                  â”‚17=UDP  â”‚                                    â”‚ â•‘
â•‘  â”‚                  â”‚1=ICMP  â”‚                                    â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚                  Source IP Address (32 bits)                   â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚               Destination IP Address (32 bits)                â”‚ â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â•‘
â•‘  â”‚                  Options (náº¿u IHL > 5)                        â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘                                                                       â•‘
â•‘  Field-by-field giáº£i thÃ­ch:                                          â•‘
â•‘                                                                       â•‘
â•‘  Version (4 bits): 4 = IPv4, 6 = IPv6                                â•‘
â•‘  â†’ Router Ä‘á»c field nÃ y Äáº¦U TIÃŠN Ä‘á»ƒ biáº¿t parse tháº¿ nÃ o            â•‘
â•‘                                                                       â•‘
â•‘  IHL (4 bits): Internet Header Length, tÃ­nh báº±ng 32-bit words        â•‘
â•‘  â†’ 5 = 20 bytes (no options), max 15 = 60 bytes                     â•‘
â•‘                                                                       â•‘
â•‘  DSCP (6 bits): Differentiated Services Code Point                   â•‘
â•‘  â†’ QoS marking: voice traffic (EF=46) > video (AF41) > web         â•‘
â•‘  â†’ Cloud: AWS Transit Gateway há»— trá»£ DSCP marking                  â•‘
â•‘                                                                       â•‘
â•‘  ECN (2 bits): Explicit Congestion Notification                      â•‘
â•‘  â†’ Router BÃO cho sender "tÃ´i sáº¯p ngháº½n" TRÆ¯á»šC KHI drop packet   â•‘
â•‘  â†’ TCP sender giáº£m tá»‘c TRÆ¯á»šC khi packet loss xáº£y ra!              â•‘
â•‘  â†’ Quan trá»ng cho data center (DCTCP, BBR congestion control)       â•‘
â•‘                                                                       â•‘
â•‘  Total Length (16 bits): max 65,535 bytes                            â•‘
â•‘  â†’ NhÆ°ng thá»±c táº¿ bá»‹ giá»›i háº¡n bá»Ÿi MTU (1500)                      â•‘
â•‘                                                                       â•‘
â•‘  Identification + Flags + Fragment Offset: IP Fragmentation          â•‘
â•‘  â†’ Packet lá»›n hÆ¡n MTU â†’ chia fragments â†’ reassemble á»Ÿ receiver   â•‘
â•‘  â†’ DF (Don't Fragment) flag: "Äá»ªNG fragment tÃ´i!"                  â•‘
â•‘  â†’ MF (More Fragments) flag: "cÃ²n fragments ná»¯a Ä‘áº±ng sau"         â•‘
â•‘  â†’ âš ï¸ Fragmentation = BAD cho performance!                        â•‘
â•‘    â†’ Má»—i fragment pháº£i cÃ³ header riÃªng (overhead)                  â•‘
â•‘    â†’ 1 fragment máº¥t = toÃ n bá»™ packet pháº£i retransmit               â•‘
â•‘    â†’ Modern networks: Path MTU Discovery thay vÃ¬ fragment           â•‘
â•‘                                                                       â•‘
â•‘  TTL (8 bits): max 255, má»—i router giáº£m 1                          â•‘
â•‘  â†’ Linux default: 64, Windows: 128, Cisco: 255                      â•‘
â•‘  â†’ TTL=0 â†’ DROP + ICMP Time Exceeded                               â•‘
â•‘                                                                       â•‘
â•‘  Protocol (8 bits): payload lÃ  gÃ¬?                                   â•‘
â•‘  â†’ 1=ICMP, 6=TCP, 17=UDP, 47=GRE, 50=ESP(IPSec)                  â•‘
â•‘                                                                       â•‘
â•‘  Header Checksum: chá»‰ check HEADER, khÃ´ng check data               â•‘
â•‘  â†’ IPv6 Bá» field nÃ y! (Ä‘á»ƒ TCP/UDP lo)                              â•‘
â•‘  â†’ LÃ½ do: má»—i router thay TTL â†’ pháº£i recalculate checksum        â•‘
â•‘  â†’ = waste CPU! IPv6 loáº¡i bá» Ä‘á»ƒ tÄƒng performance                  â•‘
â•‘                                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### IPv4 vs IPv6 â€” CÃ¢u Chuyá»‡n Cáº¡n Kiá»‡t Äá»‹a Chá»‰

**IPv4** dÃ¹ng 32 bits â†’ 2^32 = **4.3 tá»·** Ä‘á»‹a chá»‰. Nghe cÃ³ váº» nhiá»u, nhÆ°ng nÄƒm 2011, **IANA Ä‘Ã£ phÃ¢n phá»‘i háº¿t toÃ n bá»™ block IPv4 cuá»‘i cÃ¹ng**. Tháº¿ giá»›i cÃ³ 8 tá»· ngÆ°á»i, má»—i ngÆ°á»i cÃ³ nhiá»u thiáº¿t bá»‹ â€” 4.3 tá»· khÃ´ng Ä‘á»§!

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   IPv4 vs IPv6 â€” SO SÃNH CHI TIáº¾T                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚ Feature     â”‚ IPv4             â”‚ IPv6                â”‚    â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â•‘
â•‘  â”‚ Address sizeâ”‚ 32 bits          â”‚ 128 bits            â”‚    â•‘
â•‘  â”‚ Total addrs â”‚ 4.3 billion      â”‚ 3.4 Ã— 10^38        â”‚    â•‘
â•‘  â”‚ Notation    â”‚ 192.168.1.1      â”‚ 2001:db8::1         â”‚    â•‘
â•‘  â”‚ Header size â”‚ 20-60 bytes      â”‚ 40 bytes (fixed!)   â”‚    â•‘
â•‘  â”‚ Checksum    â”‚ CÃ³ (in header)   â”‚ KHÃ”NG (bá» Ä‘i!)     â”‚    â•‘
â•‘  â”‚ Fragment    â”‚ Router + sender  â”‚ Sender only!        â”‚    â•‘
â•‘  â”‚ NAT         â”‚ Báº¯t buá»™c        â”‚ KhÃ´ng cáº§n           â”‚    â•‘
â•‘  â”‚ ARP         â”‚ ARP (broadcast)  â”‚ NDP (multicast)     â”‚    â•‘
â•‘  â”‚ Auto-config â”‚ DHCP             â”‚ SLAAC (tá»± cáº¥p IP!) â”‚    â•‘
â•‘  â”‚ IPSec       â”‚ Optional         â”‚ Mandated (built-in) â”‚    â•‘
â•‘  â”‚ Adoption    â”‚ ~55% (2024)      â”‚ ~45% (2024)         â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                               â•‘
â•‘  IPv6 header Ä‘Æ°á»£c thiáº¿t káº¿ ÄÆ N GIáº¢N HÆ N:                   â•‘
â•‘  â†’ Fixed 40 bytes (khÃ´ng cÃ³ IHL, Options nhÃºng trong header)â•‘
â•‘  â†’ Bá» checksum â†’ router khÃ´ng cáº§n recalculate má»—i hop     â•‘
â•‘  â†’ Bá» fragmentation at router â†’ chá»‰ sender fragment       â•‘
â•‘  â†’ Káº¿t quáº£: router xá»­ lÃ½ IPv6 NHANH HÆ N IPv4!            â•‘
â•‘                                                               â•‘
â•‘  Backend tip:                                                 â•‘
â•‘  â†’ Go: net.Listen("tcp", ":8080") tá»± Ä‘á»™ng dual-stack       â•‘
â•‘  â†’ Docker: enable IPv6 trong daemon.json                     â•‘
â•‘  â†’ K8s: dual-stack mode (1.23+ stable)                       â•‘
â•‘  â†’ AWS: VPC supports dual-stack, ALB supports IPv6           â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### NAT â€” Network Address Translation Deep Dive

**NAT** ra Ä‘á»i nhÆ° giáº£i phÃ¡p táº¡m thá»i cho IPv4 exhaustion: nhiá»u thiáº¿t bá»‹ **share 1 public IP**. NhÆ°ng NAT phá»©c táº¡p hÆ¡n báº¡n tÆ°á»Ÿng:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   NAT â€” CÃC LOáº I VÃ€ CÃCH HOáº T Äá»˜NG                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â‘  SNAT (Source NAT) â€” outbound traffic:                     â•‘
â•‘  â†’ Private IP â†’ Public IP khi gá»­i ra Internet              â•‘
â•‘  â†’ Home router, AWS NAT Gateway                              â•‘
â•‘                                                               â•‘
â•‘  Laptop (192.168.1.5:12345) â†’ Router NAT â†’                  â•‘
â•‘  Internet tháº¥y: 203.0.113.1:54321                            â•‘
â•‘                                                               â•‘
â•‘  â‘¡ DNAT (Destination NAT) â€” inbound traffic:                 â•‘
â•‘  â†’ Public IP â†’ Private IP khi nháº­n tá»« Internet             â•‘
â•‘  â†’ Port forwarding, Load Balancer                            â•‘
â•‘                                                               â•‘
â•‘  Internet gá»­i Ä‘áº¿n: 203.0.113.1:443 â†’ Router DNAT â†’         â•‘
â•‘  Forward Ä‘áº¿n: 192.168.1.10:8080 (web server)               â•‘
â•‘                                                               â•‘
â•‘  â‘¢ PAT (Port Address Translation) â€” phá»• biáº¿n nháº¥t:          â•‘
â•‘  â†’ NHIá»€U private IPs share 1 public IP (dÃ¹ng port phÃ¢n biá»‡t)â•‘
â•‘  â†’ = NAPT (Network Address Port Translation)                 â•‘
â•‘                                                               â•‘
â•‘  NAT Table:                                                   â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â•‘
â•‘  â”‚ Internal           â”‚ External               â”‚            â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â•‘
â•‘  â”‚ 192.168.1.5:12345  â”‚ 203.0.113.1:54321      â”‚            â•‘
â•‘  â”‚ 192.168.1.5:12346  â”‚ 203.0.113.1:54322      â”‚            â•‘
â•‘  â”‚ 192.168.1.10:8080  â”‚ 203.0.113.1:54323      â”‚            â•‘
â•‘  â”‚ 192.168.1.20:443   â”‚ 203.0.113.1:54324      â”‚            â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â•‘
â•‘                                                               â•‘
â•‘  Private IP ranges (RFC 1918):                               â•‘
â•‘  10.0.0.0/8      â†’ 16.7M addrs (data centers, cloud)       â•‘
â•‘  172.16.0.0/12   â†’ 1M addrs (corporate)                     â•‘
â•‘  192.168.0.0/16  â†’ 65K addrs (home networks)                â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ NAT problems cho Backend:                               â•‘
â•‘                                                               â•‘
â•‘  Port Exhaustion:                                             â•‘
â•‘  â†’ Ephemeral port range: 1024-65535 â‰ˆ 64K ports            â•‘
â•‘  â†’ 1 NAT IP = max ~64K concurrent connections to 1 dest!   â•‘
â•‘  â†’ Microservices calling same API? â†’ port exhaustion!      â•‘
â•‘  â†’ AWS NAT Gateway: 55K connections per destination         â•‘
â•‘  â†’ FIX: multiple NAT IPs, connection pooling                â•‘
â•‘                                                               â•‘
â•‘  Peer-to-Peer:                                               â•‘
â•‘  â†’ 2 machines behind NAT cannot connect directly!           â•‘
â•‘  â†’ NAT blocks unsolicited inbound connections               â•‘
â•‘  â†’ FIX: STUN/TURN (WebRTC), hole punching, relay server    â•‘
â•‘                                                               â•‘
â•‘  Conntrack Table Full:                                       â•‘
â•‘  â†’ Linux: nf_conntrack tracks NAT mappings                  â•‘
â•‘  â†’ Default: 65536 entries â†’ high-traffic = table full!     â•‘
â•‘  â†’ Symptom: "nf_conntrack: table full, dropping packet"     â•‘
â•‘  â†’ FIX: sysctl net.nf_conntrack_max = 1048576              â•‘
â•‘  â†’ K8s nodes gáº·p issue nÃ y thÆ°á»ng xuyÃªn!                   â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Routing â€” CÃ¡ch Router Quyáº¿t Äá»‹nh Next Hop

Má»—i router cÃ³ **routing table** â€” báº£ng tra cá»©u: "packet Ä‘i Ä‘áº¿n IP X thÃ¬ forward qua interface nÃ o?"

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ROUTING TABLE â€” CÆ  CHáº¾ HOáº T Äá»˜NG                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  $ ip route show  (Linux)                                    â•‘
â•‘  $ netstat -rn    (Mac/Linux)                                â•‘
â•‘                                                               â•‘
â•‘  Output vÃ­ dá»¥:                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚ default via 192.168.1.1 dev eth0                    â”‚    â•‘
â•‘  â”‚ 10.0.0.0/8 via 10.1.0.1 dev tun0                   â”‚    â•‘
â•‘  â”‚ 172.17.0.0/16 dev docker0 scope link                â”‚    â•‘
â•‘  â”‚ 192.168.1.0/24 dev eth0 scope link                  â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                               â•‘
â•‘  Quy trÃ¬nh lookup (Longest Prefix Match):                    â•‘
â•‘                                                               â•‘
â•‘  Packet Ä‘áº¿n: dst = 10.244.1.5                                â•‘
â•‘  â‘  Check 10.244.1.5 match 10.0.0.0/8? CÃ³! (8 bits match)  â•‘
â•‘  â‘¡ Check 10.244.1.5 match 172.17.0.0/16? KhÃ´ng.            â•‘
â•‘  â‘¢ Check 10.244.1.5 match 192.168.1.0/24? KhÃ´ng.           â•‘
â•‘  â‘£ Káº¿t quáº£: dÃ¹ng 10.0.0.0/8 â†’ forward qua tun0            â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Longest Prefix Match: náº¿u cÃ³ 10.244.0.0/16 VÃ€          â•‘
â•‘  10.0.0.0/8, thÃ¬ dÃ¹ng /16 (match nhiá»u bits hÆ¡n = cá»¥ thá»ƒ!) â•‘
â•‘                                                               â•‘
â•‘  Routing types:                                              â•‘
â•‘  â†’ Static route: admin cáº¥u hÃ¬nh tay (Ã­t, Ä‘Æ¡n giáº£n)        â•‘
â•‘  â†’ Dynamic route: router trao Ä‘á»•i thÃ´ng tin tá»± Ä‘á»™ng        â•‘
â•‘    â†’ OSPF: trong 1 tá»• chá»©c (intra-AS, link-state)         â•‘
â•‘    â†’ BGP: giá»¯a cÃ¡c tá»• chá»©c (inter-AS, path-vector)        â•‘
â•‘    â†’ RIP: cá»• Ä‘áº¡i, chá»‰ dÃ¹ng trong lab (distance-vector)    â•‘
â•‘                                                               â•‘
â•‘  Backend scenarios:                                          â•‘
â•‘  â†’ VPN (tun0): traffic cÃ´ng ty Ä‘i qua VPN tunnel           â•‘
â•‘  â†’ Docker (docker0): container traffic Ä‘i qua bridge       â•‘
â•‘  â†’ K8s: kube-proxy thÃªm iptables rules cho Service routing â•‘
â•‘  â†’ AWS VPC: route table per subnet (public â†’ IGW,          â•‘
â•‘    private â†’ NAT GW, peering â†’ PCX)                        â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### ICMP â€” "Há»‡ Thá»‘ng BÃ¡o Lá»—i" Cá»§a IP

**ICMP (Internet Control Message Protocol)** lÃ  giao thá»©c **cháº©n Ä‘oÃ¡n** â€” nÃ³ KHÃ”NG mang data, mÃ  mang **thÃ´ng Ä‘iá»‡p lá»—i vÃ  tráº¡ng thÃ¡i**. Quan trá»ng hÆ¡n báº¡n tÆ°á»Ÿng:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ICMP â€” CÃC LOáº I QUAN TRá»ŒNG                                 â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘  â”‚ Type â”‚ Code â”‚ Ã nghÄ©a                              â”‚     â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â•‘
â•‘  â”‚ 0    â”‚ 0    â”‚ Echo Reply (ping response)            â”‚     â•‘
â•‘  â”‚ 3    â”‚ 0    â”‚ Network Unreachable                   â”‚     â•‘
â•‘  â”‚ 3    â”‚ 1    â”‚ Host Unreachable                      â”‚     â•‘
â•‘  â”‚ 3    â”‚ 3    â”‚ Port Unreachable (UDP, no listener)  â”‚     â•‘
â•‘  â”‚ 3    â”‚ 4    â”‚ Fragmentation Needed (PMTUD!)        â”‚     â•‘
â•‘  â”‚ 8    â”‚ 0    â”‚ Echo Request (ping)                   â”‚     â•‘
â•‘  â”‚ 11   â”‚ 0    â”‚ TTL Exceeded (traceroute!)            â”‚     â•‘
â•‘  â”‚ 12   â”‚ 0    â”‚ Parameter Problem (bad header)        â”‚     â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Äá»ªNG BAO GIá»œ BLOCK Táº¤T Cáº¢ ICMP!                      â•‘
â•‘  â†’ Block ICMP = break PMTUD â†’ connection hangs            â•‘
â•‘  â†’ Block ICMP = break traceroute â†’ cannot debug           â•‘
â•‘  â†’ Block ICMP = break ping â†’ monitoring blind!            â•‘
â•‘                                                               â•‘
â•‘  Recommended firewall rules:                                 â•‘
â•‘  â†’ ALLOW: Type 0 (reply), 3 (unreachable), 8 (request),   â•‘
â•‘           11 (TTL exceeded)                                  â•‘
â•‘  â†’ Rate-limit: ping flood protection (100/sec)             â•‘
â•‘  â†’ BLOCK: ICMP redirect (Type 5) â€” security risk!         â•‘
â•‘                                                               â•‘
â•‘  Debug commands:                                             â•‘
â•‘  â†’ ping -c 5 google.com (basic reachability)               â•‘
â•‘  â†’ ping -s 1472 -M do google.com (test MTU, DF flag)      â•‘
â•‘  â†’ mtr google.com (continuous traceroute + ping stats)     â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### TTL â€” "Báº£o Hiá»ƒm" Chá»‘ng Routing Loops

HÃ£y tÆ°á»Ÿng tÆ°á»£ng 2 router cáº¥u hÃ¬nh sai: Router A nghÄ© "Ä‘Æ°á»ng Ä‘áº¿n X qua B", Router B nghÄ© "Ä‘Æ°á»ng Ä‘áº¿n X qua A". Packet cháº¡y vÃ²ng Aâ†’Bâ†’Aâ†’B... vÃ´ háº¡n, **tiÃªu tá»‘n bandwidth**. TTL giáº£i quyáº¿t: má»—i router giáº£m TTL Ä‘i 1. Khi TTL=0 â†’ **DROP packet** + gá»­i "ICMP Time Exceeded" vá» cho sender.

**TTL máº·c Ä‘á»‹nh theo OS** â€” há»¯u Ã­ch cho fingerprinting:

- **Linux**: 64
- **Windows**: 128
- **macOS**: 64
- **Cisco/Network devices**: 255

`traceroute` lá»£i dá»¥ng cÆ¡ cháº¿ nÃ y: gá»­i packets vá»›i TTL=1 (router Ä‘áº§u tiÃªn reply "tÃ´i á»Ÿ Ä‘Ã¢y!"), rá»“i TTL=2, TTL=3... cho Ä‘áº¿n khi Ä‘áº¿n Ä‘Ã­ch â†’ **map toÃ n bá»™ route path + latency má»—i hop**.

```bash
# traceroute thá»±c táº¿: SG â†’ Google DNS
$ traceroute 8.8.8.8
 1  192.168.1.1     1ms    â† home router
 2  10.1.0.1        5ms    â† ISP gateway
 3  203.0.113.50    8ms    â† ISP core router
 4  72.14.215.85   15ms    â† Google edge (Singapore POP)
 5  8.8.8.8        12ms    â† destination!
# â†’ 5 hops, 12ms total. Nhanh vÃ¬ Google cÃ³ POP á»Ÿ SG!

# traceroute Ä‘áº¿n server US:
$ traceroute us-east-server.com
 1  192.168.1.1     1ms
 ...
 8  submarine.cable 75ms   â† submarine fiber!
 ...
12  us-east.server 180ms   â† 12 hops, 180ms (váº­t lÃ½!)

# mtr â€” Modern traceroute (continuous + packet loss stats)
$ mtr --report google.com
HOST                  Loss%  Avg  Best  Wrst
1. gateway             0.0%  0.5   0.3   1.2
2. isp-core             0.0%  5.1   4.8   6.0
3. google-edge          0.5%  12.3  11.0  15.0  â† 0.5% loss!
# â†’ packet loss at hop 3 = ISP or peering issue

# Paris traceroute â€” detect load-balanced paths
$ paris-traceroute google.com
# â†’ khÃ¡c traceroute: phÃ¡t hiá»‡n ECMP (nhiá»u paths)
```

### Subnetting & CIDR â€” Chia Máº¡ng Cho Data Center

Backend Engineer cáº§n hiá»ƒu subnetting khi lÃ m viá»‡c vá»›i **Kubernetes networking**, **VPC configuration** trÃªn cloud, hoáº·c **on-premise data center**. ÄÃ¢y lÃ  ká»¹ nÄƒng **báº¯t buá»™c** cho Senior Backend.

**CÃ¡ch tÃ­nh subnet â€” vÃ­ dá»¥ step-by-step:**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   SUBNETTING â€” BINARY WALKTHROUGH                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  CIDR: 10.0.0.0/24                                          â•‘
â•‘                                                               â•‘
â•‘  IP:      10  .  0   .  0   .  0                             â•‘
â•‘  Binary:  00001010.00000000.00000000.00000000                â•‘
â•‘  Mask:    11111111.11111111.11111111.00000000  (/24)        â•‘
â•‘           â†â”€â”€ 24 bits network â”€â”€â†’â†8 hostâ†’                   â•‘
â•‘                                                               â•‘
â•‘  â†’ Network address: 10.0.0.0   (host bits = all 0)         â•‘
â•‘  â†’ Broadcast addr:  10.0.0.255 (host bits = all 1)         â•‘
â•‘  â†’ Usable range:    10.0.0.1 â€” 10.0.0.254                  â•‘
â•‘  â†’ Usable hosts:    2^8 - 2 = 254                           â•‘
â•‘                                                               â•‘
â•‘  Quick math (Cáº¦N THUá»˜C):                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â•‘
â•‘  â”‚ CIDR â”‚ # IPs   â”‚ Use case                          â”‚      â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â•‘
â•‘  â”‚ /32  â”‚ 1       â”‚ Single host (health check target) â”‚      â•‘
â•‘  â”‚ /28  â”‚ 16      â”‚ Small subnet (11 usable, AWS min) â”‚      â•‘
â•‘  â”‚ /24  â”‚ 256     â”‚ Standard subnet (254 usable)      â”‚      â•‘
â•‘  â”‚ /20  â”‚ 4,096   â”‚ Large subnet (K8s node pool)      â”‚      â•‘
â•‘  â”‚ /16  â”‚ 65,536  â”‚ VPC size (AWS default)            â”‚      â•‘
â•‘  â”‚ /8   â”‚ 16.7M   â”‚ Massive (entire 10.x.x.x)        â”‚      â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â•‘
â•‘                                                               â•‘
â•‘  AWS VPC Design Pattern (3-tier architecture):               â•‘
â•‘                                                               â•‘
â•‘  VPC: 10.0.0.0/16 (65,536 IPs)                              â•‘
â•‘  â”œâ”€â”€ AZ-a:                                                    â•‘
â•‘  â”‚   â”œâ”€â”€ Public:  10.0.1.0/24 (ALB, NAT GW, Bastion)       â•‘
â•‘  â”‚   â”œâ”€â”€ Private: 10.0.10.0/24 (App servers, ECS/EKS)      â•‘
â•‘  â”‚   â””â”€â”€ Data:    10.0.20.0/24 (RDS, ElastiCache)          â•‘
â•‘  â”œâ”€â”€ AZ-b:                                                    â•‘
â•‘  â”‚   â”œâ”€â”€ Public:  10.0.2.0/24                                â•‘
â•‘  â”‚   â”œâ”€â”€ Private: 10.0.11.0/24                               â•‘
â•‘  â”‚   â””â”€â”€ Data:    10.0.21.0/24                               â•‘
â•‘  â””â”€â”€ AZ-c: (same pattern)                                    â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Kubernetes CIDR planning:                                â•‘
â•‘  â†’ Pod CIDR: 10.244.0.0/16 (má»—i pod 1 IP unique!)         â•‘
â•‘  â†’ Service CIDR: 10.96.0.0/12 (ClusterIP range)            â•‘
â•‘  â†’ KHÃ”NG ÄÆ¯á»¢C overlap vá»›i VPC CIDR â†’ routing conflict!     â•‘
â•‘  â†’ /24 per node = max 254 pods/node (often limit ~110)      â•‘
â•‘  â†’ EKS: /28 per ENI â†’ secondary IP assignment              â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Common mistake:                                          â•‘
â•‘  â†’ VPC 10.0.0.0/16 + K8s pod CIDR 10.244.0.0/16 = OK      â•‘
â•‘  â†’ VPC 10.0.0.0/8 + K8s pod CIDR 10.244.0.0/16 = OVERLAP! â•‘
â•‘  â†’ VPC peering: 2 VPCs KHÃ”NG ÄÆ¯á»¢C cÃ³ overlapping CIDRs!   â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### BGP â€” Protocol Váº­n HÃ nh Internet

**BGP (Border Gateway Protocol)** lÃ  "routing protocol of the Internet" â€” nÃ³ quyáº¿t Ä‘á»‹nh data Ä‘i Ä‘Æ°á»ng nÃ o giá»¯a cÃ¡c **Autonomous Systems** (AS = máº¡ng cá»§a 1 tá»• chá»©c).

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   BGP â€” BORDER GATEWAY PROTOCOL                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  AS (Autonomous System) = máº¡ng cá»§a 1 tá»• chá»©c:              â•‘
â•‘  â†’ AS13414 = Twitter     â”‚ AS15169 = Google                 â•‘
â•‘  â†’ AS32934 = Facebook    â”‚ AS16509 = Amazon AWS             â•‘
â•‘  â†’ AS714   = Apple       â”‚ AS8075  = Microsoft              â•‘
â•‘                                                               â•‘
â•‘  BGP relationships:                                          â•‘
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Transit ($$$)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â•‘
â•‘  â”‚ Tier-1   â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Tier-1   â”‚                 â•‘
â•‘  â”‚ ISP (NTT)â”‚  Free peering   â”‚ ISP(Lumen)â”‚                 â•‘
â•‘  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â•‘
â•‘       â”‚ Transit ($)                   â”‚ Transit ($)          â•‘
â•‘  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   Peering (free)  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”               â•‘
â•‘  â”‚ Tier-2   â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Tier-2   â”‚               â•‘
â•‘  â”‚ ISP(VNPT)â”‚   (táº¡i IXP)       â”‚ISP(Viettel)â”‚               â•‘
â•‘  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â•‘
â•‘       â”‚ Transit ($)                   â”‚                       â•‘
â•‘  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                                                â•‘
â•‘  â”‚ Customer â”‚ (your company's AS)                            â•‘
â•‘  â”‚ AS       â”‚                                                 â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â•‘
â•‘                                                               â•‘
â•‘  IXP (Internet Exchange Point):                              â•‘
â•‘  â†’ NÆ¡i cÃ¡c ISPs káº¿t ná»‘i TRá»°C TIáº¾P (peering)               â•‘
â•‘  â†’ VNIX (Vietnam), SGIX (Singapore), DE-CIX (Frankfurt)    â•‘
â•‘  â†’ Traffic trong nÆ°á»›c Ä‘i qua IXP = khÃ´ng tá»‘n transit fee!  â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ BGP Incidents ná»•i tiáº¿ng:                                â•‘
â•‘                                                               â•‘
â•‘  Facebook Outage (4/10/2021):                                â•‘
â•‘  â†’ BGP config update lá»—i â†’ xÃ³a Táº¤T Cáº¢ routes            â•‘
â•‘  â†’ Internet khÃ´ng biáº¿t Ä‘Æ°á»ng Ä‘áº¿n Facebook!                 â•‘
â•‘  â†’ DNS servers cÅ©ng unreachable â†’ cascade failure          â•‘
â•‘  â†’ 6 giá» down, $100M+ revenue loss                         â•‘
â•‘  â†’ Engineers khÃ´ng vÃ o Ä‘Æ°á»£c building (badge = internal net) â•‘
â•‘                                                               â•‘
â•‘  Pakistan YouTube Block (2008):                              â•‘
â•‘  â†’ Pakistan Telecom announce YouTube's prefix /24           â•‘
â•‘  â†’ BGP propagate globally â†’ YouTube DOWN 2 giá»            â•‘
â•‘  â†’ = BGP Hijacking (dÃ¹ vÃ´ tÃ¬nh)                            â•‘
â•‘                                                               â•‘
â•‘  BGP Security:                                               â•‘
â•‘  â†’ RPKI (Resource Public Key Infrastructure):               â•‘
â•‘    â†’ KÃ½ cryptographic prefix â†’ verify ownership           â•‘
â•‘  â†’ BGP-SEC: kÃ½ cáº£ path, nhÆ°ng adoption cháº­m               â•‘
â•‘  â†’ Cloudflare, Google Ä‘Ã£ deploy RPKI validation            â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### DNS â€” Há»‡ Thá»‘ng PhÃ¢n Giáº£i TÃªn Miá»n

DNS (Domain Name System) Ä‘Æ°á»£c gá»i lÃ  **"danh báº¡ Ä‘iá»‡n thoáº¡i cá»§a Internet"**, nhÆ°ng thá»±c táº¿ nÃ³ phá»©c táº¡p hÆ¡n nhiá»u. DNS lÃ  **há»‡ thá»‘ng phÃ¢n tÃ¡n lá»›n nháº¥t tháº¿ giá»›i** â€” má»™t hierarchical, globally distributed database Ä‘Æ°á»£c query **hÃ ng nghÃ¬n tá»· láº§n/ngÃ y**.

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   DNS â€” Tá»ª TÃŠN MIá»€N Äáº¾N IP ADDRESS                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  HÃ nh trÃ¬nh resolve "api.example.com":                      â•‘
â•‘                                                               â•‘
â•‘  â‘  Check /etc/hosts (local override)                        â•‘
â•‘     â†’ Dev hay dÃ¹ng: 127.0.0.1 api.local                    â•‘
â•‘  â‘¡ Check OS DNS cache (nscd, systemd-resolved)              â•‘
â•‘     â†’ ÄÃ£ resolve gáº§n Ä‘Ã¢y? â†’ dÃ¹ng cache!                   â•‘
â•‘  â‘¢ Query Recursive Resolver (ISP / 8.8.8.8 / 1.1.1.1)     â•‘
â•‘     â†’ Resolver LÃ€M Há»˜ táº¥t cáº£ bÆ°á»›c tiáº¿p theo              â•‘
â•‘  â‘£ Resolver â†’ Root DNS (13 clusters, ~1500 instances)      â•‘
â•‘     â†’ ".com" â†’ Ä‘i há»i TLD server                          â•‘
â•‘  â‘¤ Root â†’ TLD DNS (com â†’ Verisign quáº£n lÃ½)                â•‘
â•‘     â†’ "example.com" â†’ Ä‘i há»i Authoritative server          â•‘
â•‘  â‘¥ TLD â†’ Authoritative DNS (Cloudflare/AWS Route53)       â•‘
â•‘     â†’ "api.example.com = 93.184.216.34" â†’ DONE!           â•‘
â•‘                                                               â•‘
â•‘  Total time: 50-200ms (uncached) vs <1ms (cached)           â•‘
â•‘                                                               â•‘
â•‘  DNS Record Types:                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚ Type â”‚ Ã nghÄ©a + Use case                            â”‚   â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â•‘
â•‘  â”‚ A    â”‚ domain â†’ IPv4 (api.example.com â†’ 93.184...)  â”‚   â•‘
â•‘  â”‚ AAAA â”‚ domain â†’ IPv6                                 â”‚   â•‘
â•‘  â”‚ CNAMEâ”‚ alias (www â†’ example.com). âš ï¸ CNAME â‰  A!    â”‚   â•‘
â•‘  â”‚      â”‚ CNAME táº¡i zone apex (example.com) bá»‹ cáº¥m!    â”‚   â•‘
â•‘  â”‚      â”‚ â†’ DÃ¹ng ALIAS/ANAME (Route53, Cloudflare)     â”‚   â•‘
â•‘  â”‚ MX   â”‚ mail server (priority 10 mail.example.com)    â”‚   â•‘
â•‘  â”‚ NS   â”‚ nameserver delegation                          â”‚   â•‘
â•‘  â”‚ TXT  â”‚ text (SPF, DKIM, domain verification)         â”‚   â•‘
â•‘  â”‚ SRV  â”‚ service discovery (_grpc._tcp.api â†’ host:port)â”‚   â•‘
â•‘  â”‚ PTR  â”‚ reverse DNS (IP â†’ domain, anti-spam check)   â”‚   â•‘
â•‘  â”‚ CAA  â”‚ Certificate Authority Authorization           â”‚   â•‘
â•‘  â”‚      â”‚ â†’ chá»‰ CA nÃ o Ä‘Æ°á»£c cáº¥p cert cho domain       â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### DNS Caching & TTL â€” BÃ i Há»c Äau ThÆ°Æ¡ng

**TTL (Time To Live)** = thá»i gian DNS record Ä‘Æ°á»£c cache. ÄÃ¢y lÃ  trade-off kinh Ä‘iá»ƒn:

- **TTL cao (86400s = 1 ngÃ y)**: giáº£m DNS load, nhÆ°ng khi báº¡n Ä‘á»•i IP, users váº«n truy cáº­p IP cÅ© suá»‘t 24h!
- **TTL tháº¥p (60s = 1 phÃºt)**: cáº­p nháº­t nhanh, nhÆ°ng DNS queries tÄƒng 1440x â†’ tá»‘n $ vÃ  tÄƒng latency.

**War story:** Báº¡n Ä‘ang migrate server tá»« cloud A sang cloud B. Báº¡n Ä‘á»•i DNS record, nhÆ°ng quÃªn giáº£m TTL trÆ°á»›c Ä‘Ã³. Users váº«n truy cáº­p server cÅ© (Ä‘Ã£ táº¯t) suá»‘t 24h â†’ **outage**!

**Best practice cho migration:**

1. **2-3 ngÃ y trÆ°á»›c**: giáº£m TTL tá»« 86400 â†’ 60 (chá» cache cÅ© háº¿t háº¡n)
2. **Äá»•i record**: point Ä‘áº¿n server má»›i
3. **Verify**: `dig +trace api.example.com` â€” confirm IP má»›i
4. **Sau 1 ngÃ y**: tÄƒng TTL láº¡i vá» 3600-86400

### DNS Security â€” Threats & Solutions

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   DNS SECURITY â€” Má»I ÄE Dá»ŒA VÃ€ GIáº¢I PHÃP                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â‘  DNS Cache Poisoning (Kaminsky Attack, 2008):              â•‘
â•‘  â†’ Attacker inject fake DNS response vÃ o resolver cache     â•‘
â•‘  â†’ User query "bank.com" â†’ nháº­n IP cá»§a attacker!           â•‘
â•‘  â†’ FIX: DNSSEC (cryptographic signatures trÃªn records)     â•‘
â•‘  â†’ FIX: Source port randomization (khÃ´ng dÃ¹ng fixed port)  â•‘
â•‘                                                               â•‘
â•‘  â‘¡ DNS Amplification DDoS:                                   â•‘
â•‘  â†’ Attacker spoof source IP = victim IP                     â•‘
â•‘  â†’ Send small query (60B) â†’ DNS reply lá»›n (3000B+)        â•‘
â•‘  â†’ Amplification factor: 50x-70x!                           â•‘
â•‘  â†’ FIX: Rate limiting, BCP38 (anti-spoofing)               â•‘
â•‘                                                               â•‘
â•‘  â‘¢ DNS Tunneling:                                            â•‘
â•‘  â†’ Encode data trong DNS queries (base64 in subdomain)     â•‘
â•‘  â†’ Bypass firewall! (háº§u háº¿t FW allow DNS port 53)        â•‘
â•‘  â†’ DÃ¹ng cho: data exfiltration, C2 communication           â•‘
â•‘  â†’ FIX: Monitor unusual DNS query patterns                  â•‘
â•‘                                                               â•‘
â•‘  Modern DNS encryption:                                      â•‘
â•‘  â†’ DoH (DNS over HTTPS): port 443, láº«n vá»›i web traffic    â•‘
â•‘  â†’ DoT (DNS over TLS): port 853, dedicated                  â•‘
â•‘  â†’ ISP KHÃ”NG THá»‚ snoop DNS queries ná»¯a!                    â•‘
â•‘  â†’ Browsers máº·c Ä‘á»‹nh báº­t DoH (Firefox, Chrome)             â•‘
â•‘  â†’ âš ï¸ Problem: bypass enterprise DNS filtering/monitoring  â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### DNS Patterns Cho Backend

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   DNS PATTERNS CHO BACKEND                                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â‘  Service Discovery (Kubernetes / Consul):                  â•‘
â•‘  â†’ my-service.default.svc.cluster.local â†’ ClusterIP        â•‘
â•‘  â†’ CoreDNS: DNS server cháº¡y trong K8s cluster              â•‘
â•‘  â†’ Má»—i Service = 1 DNS record (auto-registered!)           â•‘
â•‘  â†’ Headless Service: tráº£ vá» Táº¤T Cáº¢ pod IPs (khÃ´ng LB)    â•‘
â•‘    â†’ gRPC client-side load balancing dÃ¹ng headless DNS!    â•‘
â•‘                                                               â•‘
â•‘  â‘¡ Blue-Green Deployment:                                    â•‘
â•‘  â†’ Blue (v1) Ä‘ang serve: api.example.com â†’ IP_BLUE        â•‘
â•‘  â†’ Deploy Green (v2) â†’ test â†’ healthy                      â•‘
â•‘  â†’ Switch DNS: api.example.com â†’ IP_GREEN                  â•‘
â•‘  â†’ Rollback: switch láº¡i DNS â†’ IP_BLUE (nhanh 60s!)       â•‘
â•‘                                                               â•‘
â•‘  â‘¢ GeoDNS / Latency-based routing:                          â•‘
â•‘  â†’ AWS Route53: user VN â†’ resolve Ä‘áº¿n SG server           â•‘
â•‘  â†’ User US â†’ resolve Ä‘áº¿n US server                         â•‘
â•‘  â†’ Giáº£m latency báº±ng cÃ¡ch tráº£ IP Gáº¦N user nháº¥t           â•‘
â•‘                                                               â•‘
â•‘  â‘£ Health Check + Failover:                                  â•‘
â•‘  â†’ Route53 health check: ping server má»—i 10s              â•‘
â•‘  â†’ Server down â†’ auto switch DNS Ä‘áº¿n backup server        â•‘
â•‘  â†’ RTO (Recovery Time Objective) ~ TTL + check interval    â•‘
â•‘                                                               â•‘
â•‘  â‘¤ Split-Horizon DNS:                                        â•‘
â•‘  â†’ Internal: api.example.com â†’ 10.0.1.5 (private IP)     â•‘
â•‘  â†’ External: api.example.com â†’ 203.0.113.5 (public IP)   â•‘
â•‘  â†’ Server trong VPC gá»i nhau qua private IP = nhanh hÆ¡n! â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**DNS Debug Commands:**

```bash
# Resolve domain (basic)
dig api.example.com
# â†’ ANSWER SECTION: api.example.com. 300 IN A 93.184.216.34
#                                     â†‘ TTL = 300 giÃ¢y

# Trace full resolution path (root â†’ TLD â†’ auth)
dig +trace api.example.com

# Query specific DNS server
dig @8.8.8.8 api.example.com    # Google DNS
dig @1.1.1.1 api.example.com    # Cloudflare DNS

# Check all record types
dig ANY example.com

# Reverse DNS lookup
dig -x 93.184.216.34

# Check nameservers
dig NS example.com

# K8s DNS debug (tá»« bÃªn trong pod)
kubectl run dnsutils --image=gcr.io/kubernetes-e2e-test-images/dnsutils -- sleep 3600
kubectl exec -it dnsutils -- nslookup my-service.default.svc.cluster.local
kubectl exec -it dnsutils -- dig +search my-service

# Check CoreDNS logs
kubectl logs -n kube-system -l k8s-app=kube-dns
```

---

## Â§4. Layer 4 â€” Transport: TCP & UDP

### BÃ i toÃ¡n gá»‘c: Äáº£m báº£o data Äáº¾N ÄÃšNG & Äáº¦Y Äá»¦

IP (Layer 3) gá»­i packets nhÆ°ng nÃ³ giá»‘ng **dá»‹ch vá»¥ bÆ°u pháº©m giÃ¡ ráº»**: gá»­i Ä‘i rá»“i, nhÆ°ng **khÃ´ng Ä‘áº£m báº£o** thÆ° Ä‘áº¿n, khÃ´ng Ä‘áº£m báº£o **Ä‘áº¿n Ä‘Ãºng thá»© tá»±** (thÆ° gá»­i trÆ°á»›c cÃ³ thá»ƒ Ä‘áº¿n sau), vÃ  thÆ° cÃ³ thá»ƒ bá»‹ **trÃ¹ng láº·p** (bÆ°u Ä‘iá»‡n vÃ´ tÃ¬nh gá»­i 2 báº£n). Tháº­m chÃ­ thÆ° cÃ³ thá»ƒ bá»‹ **hÆ° há»ng** trÃªn Ä‘Æ°á»ng (tÃ­n hiá»‡u nhiá»…u).

Layer 4 giáº£i quyáº¿t báº±ng **hai triáº¿t lÃ½ Ä‘á»‘i láº­p**:

- **TCP** = dá»‹ch vá»¥ gá»­i báº£o Ä‘áº£m (cÃ³ tracking number, khu vá»±c nháº­n, kÃ½ nháº­n)
- **UDP** = dá»‹ch vá»¥ tháº£ thÆ° vÃ o hÃ²m (nhanh, ráº», nhÆ°ng máº¥t thÃ¬ thÃ´i)

### TCP Header â€” BÃªn Trong "Há»£p Äá»“ng" TCP

Má»—i TCP segment mang theo **20-60 bytes header** chá»©a má»i thÃ´ng tin cáº§n thiáº¿t cho reliability:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TCP HEADER (20 bytes minimum)                               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  0                   1                   2                   3â•‘
â•‘  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â•‘
â•‘  â”‚   Source Port    â”‚ Destination Port â”‚  â† 4 bytes          â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â•‘
â•‘  â”‚         Sequence Number            â”‚  â† 4 bytes          â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â•‘
â•‘  â”‚      Acknowledgment Number         â”‚  â† 4 bytes          â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â•‘
â•‘  â”‚Offsetâ”‚Flags  â”‚     Window Size     â”‚  â† 4 bytes          â•‘
â•‘  â”‚(4b)  â”‚URG    â”‚  (flow control!)    â”‚                      â•‘
â•‘  â”‚      â”‚ACK    â”‚  = bao nhiÃªu bytes  â”‚                      â•‘
â•‘  â”‚      â”‚PSH    â”‚  receiver sáºµn sÃ ng â”‚                      â•‘
â•‘  â”‚      â”‚RST    â”‚  nháº­n thÃªm          â”‚                      â•‘
â•‘  â”‚      â”‚SYN    â”‚                     â”‚                      â•‘
â•‘  â”‚      â”‚FIN    â”‚                     â”‚                      â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â•‘
â•‘  â”‚   Checksum    â”‚  Urgent Pointer    â”‚  â† 4 bytes          â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â•‘
â•‘  â”‚   Options (MSS, Window Scale,      â”‚  â† 0-40 bytes      â•‘
â•‘  â”‚    Timestamps, SACK...)            â”‚                      â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â•‘
â•‘                                                               â•‘
â•‘  CÃ¡c fields QUAN TRá»ŒNG cho Backend:                          â•‘
â•‘                                                               â•‘
â•‘  Sequence Number: Ä‘Ã¡nh sá»‘ tá»«ng byte â†’ receiver xáº¿p láº¡i    â•‘
â•‘  â†’ Náº¿u received: 1-1000, 2001-3000 â†’ biáº¿t Máº¤T 1001-2000  â•‘
â•‘  â†’ Sender retransmit chá»‰ pháº§n bá»‹ máº¥t (Selective ACK/SACK) â•‘
â•‘                                                               â•‘
â•‘  Window Size: flow control                                   â•‘
â•‘  â†’ "TÃ´i cÃ²n 16KB buffer free" â†’ sender khÃ´ng gá»­i quÃ¡!    â•‘
â•‘  â†’ Window = 0 â†’ STOP SENDING! (receiver Ä‘ang xá»­ lÃ½)      â•‘
â•‘  â†’ Window Scale option: tÄƒng lÃªn 1GB+ cho high-speed net  â•‘
â•‘                                                               â•‘
â•‘  Flags: Ä‘iá»u khiá»ƒn connection lifecycle                      â•‘
â•‘  â†’ SYN: má»Ÿ connection       â”‚ FIN: Ä‘Ã³ng connection        â•‘
â•‘  â†’ ACK: xÃ¡c nháº­n received   â”‚ RST: force close (abort!)   â•‘
â•‘  â†’ PSH: gá»­i ngay (no buffer)â”‚ URG: data urgent (hiáº¿m dÃ¹ng)â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Port Numbers â€” "Sá»‘ PhÃ²ng" Trong TÃ²a NhÃ 

Náº¿u **IP address** lÃ  Ä‘á»‹a chá»‰ tÃ²a nhÃ  (server/mÃ¡y tÃ­nh), thÃ¬ **port number** lÃ  **sá»‘ phÃ²ng** trong tÃ²a nhÃ  Ä‘Ã³. Má»™t server cháº¡y nhiá»u services: web (port 80/443), SSH (port 22), database (port 5432). Port cho phÃ©p Layer 4 deliver data Ä‘áº¿n **Ä‘Ãºng á»©ng dá»¥ng**.

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   PORT NUMBERS                                                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Well-known (0-1023): system services, cáº§n root Ä‘á»ƒ bind     â•‘
â•‘  â†’ 22: SSH      â”‚ 53: DNS     â”‚ 80: HTTP     â”‚ 443: HTTPS  â•‘
â•‘  â†’ 25: SMTP     â”‚ 110: POP3   â”‚ 143: IMAP    â”‚ 3306: MySQL â•‘
â•‘  â†’ 5432: PostgreSQL  â”‚ 6379: Redis  â”‚ 27017: MongoDB       â•‘
â•‘                                                               â•‘
â•‘  Registered (1024-49151): applications                       â•‘
â•‘  â†’ 3000: dev servers â”‚ 8080: alt HTTP â”‚ 9090: Prometheus   â•‘
â•‘                                                               â•‘
â•‘  Ephemeral (49152-65535): OS auto-assign cho client          â•‘
â•‘  â†’ Browser má»Ÿ tab â†’ OS gÃ¡n port 49152                      â•‘
â•‘  â†’ Má»Ÿ thÃªm tab â†’ 49153, 49154...                           â•‘
â•‘  â†’ Giá»›i háº¡n: ~16K ports ephemeral = max concurrent conns    â•‘
â•‘                                                               â•‘
â•‘  Socket = (IP:Port, IP:Port) = unique connection identifier  â•‘
â•‘  â†’ VÃ­ dá»¥: (192.168.1.5:49152, 93.184.216.34:443)          â•‘
â•‘  â†’ 1 server port 443 phá»¥c vá»¥ HÃ€NG TRIá»†U connections       â•‘
â•‘    (vÃ¬ má»—i connection cÃ³ src IP:port KHÃC nhau!)            â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ "Port already in use" khi restart server:               â•‘
â•‘  â†’ NguyÃªn nhÃ¢n: TIME_WAIT giá»¯ port (xem pháº§n TCP States)  â•‘
â•‘  â†’ FIX: SO_REUSEADDR trÆ°á»›c khi bind()                     â•‘
â•‘  â†’ Go net.ListenConfig{Control: setReuseAddr}              â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### TCP vs UDP â€” Hai Triáº¿t LÃ½ Äá»‘i Láº­p

**TCP (Transmission Control Protocol)** giá»‘ng **cuá»™c gá»i Ä‘iá»‡n thoáº¡i**: pháº£i káº¿t ná»‘i trÆ°á»›c (handshake), nÃ³i chuyá»‡n (data), rá»“i táº¡m biá»‡t (teardown). Náº¿u báº¡n nÃ³i gÃ¬ mÃ  Ä‘á»‘i phÆ°Æ¡ng khÃ´ng nghe rÃµ â†’ báº¡n nháº¯c láº¡i (retransmission).

**UDP (User Datagram Protocol)** giá»‘ng **báº¯n phÃ¡o hoa**: báº¯n lÃªn trá»i, ai xem thÃ¬ xem. Nhanh, khÃ´ng cáº§n kiá»ƒm tra ai Ä‘ang xem, nhÆ°ng náº¿u ngÆ°á»i xem quay Ä‘i 1 giÃ¢y â†’ bá» lá»¡!

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TCP vs UDP â€” HAI TRIáº¾T LÃ Äá»I Láº¬P                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  TCP (Transmission Control Protocol):                        â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚ âœ… Reliable: data Äáº¢M Báº¢O Ä‘áº¿n                      â”‚    â•‘
â•‘  â”‚ âœ… Ordered: packets Ä‘Ãºng THá»¨ Tá»°                     â”‚    â•‘
â•‘  â”‚ âœ… Error-checked: phÃ¡t hiá»‡n data bá»‹ há»ng            â”‚    â•‘
â•‘  â”‚ âœ… Flow control: khÃ´ng gá»­i quÃ¡ nhanh                â”‚    â•‘
â•‘  â”‚ âœ… Congestion control: tá»± giáº£m tá»‘c khi máº¡ng ngháº½n  â”‚    â•‘
â•‘  â”‚ âŒ Overhead cao: header 20-60 bytes                  â”‚    â•‘
â•‘  â”‚ âŒ Latency: handshake + ACK + retransmit             â”‚    â•‘
â•‘  â”‚ DÃ¹ng cho: HTTP, gRPC, DB connections, SSH, email     â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                               â•‘
â•‘  UDP (User Datagram Protocol):                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚ âœ… Nhanh: khÃ´ng handshake, khÃ´ng chá» ACK            â”‚    â•‘
â•‘  â”‚ âœ… Nháº¹: header chá»‰ 8 bytes (src port, dst port,    â”‚    â•‘
â•‘  â”‚         length, checksum â€” that's it!)               â”‚    â•‘
â•‘  â”‚ âœ… Broadcast/Multicast support                       â”‚    â•‘
â•‘  â”‚ âœ… No HOL blocking (má»—i packet Ä‘á»™c láº­p)             â”‚    â•‘
â•‘  â”‚ âŒ Unreliable: packet cÃ³ thá»ƒ máº¥t                    â”‚    â•‘
â•‘  â”‚ âŒ Unordered: packets cÃ³ thá»ƒ Ä‘áº¿n lá»™n xá»™n           â”‚    â•‘
â•‘  â”‚ âŒ KhÃ´ng congestion control (floods the network!)    â”‚    â•‘
â•‘  â”‚ DÃ¹ng cho: DNS, streaming, gaming, VoIP, QUIC/HTTP3  â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                               â•‘
â•‘  UDP Header (chá»‰ 8 bytes!):                                 â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â•‘
â•‘  â”‚ Src Port â”‚ Dst Port â”‚ Length   â”‚ Checksum â”‚              â•‘
â•‘  â”‚ (2B)     â”‚ (2B)     â”‚ (2B)    â”‚ (2B)     â”‚              â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â•‘
â•‘  â†’ So sÃ¡nh: TCP header 20-60B vs UDP header 8B!            â•‘
â•‘  â†’ 12B trá»Ÿ lÃªn overhead = significant cho small messages   â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

> **Táº¡i sao QUIC chá»n build trÃªn UDP thay vÃ¬ táº¡o protocol má»›i?** VÃ¬ Internet Ä‘Ã£ **ossified** â€” routers, firewalls, NAT boxes chá»‰ biáº¿t TCP vÃ  UDP. Náº¿u báº¡n táº¡o protocol má»›i (vÃ­ dá»¥: Protocol 142), háº§u háº¿t firewall sáº½ DROP nÃ³ vÃ¬ "khÃ´ng nháº­n ra". UDP lÃ  **"blank canvas"** mÃ  firewall KHÃ”NG block â†’ QUIC build reliability lÃªn trÃªn UDP á»Ÿ application layer (userspace) â†’ triá»ƒn khai nhanh hÆ¡n (app update) thay vÃ¬ pháº£i chá» OS kernel update (TCP).

### TCP Three-Way Handshake â€” Táº¡i sao cáº§n 3 bÆ°á»›c?

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TCP 3-WAY HANDSHAKE                                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Client                          Server                       â•‘
â•‘    â”‚                               â”‚                          â•‘
â•‘    â”‚â”€â”€â”€ SYN (seq=100) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â‘  "TÃ´i muá»‘n káº¿t ná»‘i"  â•‘
â•‘    â”‚                               â”‚                          â•‘
â•‘    â”‚â—„â”€â”€ SYN-ACK (seq=300,ack=101)â”‚  â‘¡ "OK, tÃ´i cÅ©ng sáºµn   â•‘
â•‘    â”‚                               â”‚     sÃ ng"               â•‘
â•‘    â”‚                               â”‚                          â•‘
â•‘    â”‚â”€â”€â”€ ACK (ack=301) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â‘¢ "XÃ¡c nháº­n, báº¯t Ä‘áº§u!"â•‘
â•‘    â”‚                               â”‚                          â•‘
â•‘    â”‚â—„â•â•â•â•â•â•â• DATA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–ºâ”‚  Connection established  â•‘
â•‘                                                               â•‘
â•‘  5 WHYS: Táº¡i sao Cáº¦N 3 bÆ°á»›c?                               â•‘
â•‘                                                               â•‘
â•‘  WHY 1: Táº¡i sao khÃ´ng 1 bÆ°á»›c (chá»‰ SYN)?                    â•‘
â•‘  â†’ Server khÃ´ng biáº¿t Client cÃ³ nháº­n Ä‘Æ°á»£c response khÃ´ng!    â•‘
â•‘                                                               â•‘
â•‘  WHY 2: Táº¡i sao khÃ´ng 2 bÆ°á»›c (SYN + SYN-ACK)?              â•‘
â•‘  â†’ Client xÃ¡c nháº­n Server sáºµn sÃ ng, nhÆ°ng Server CHÆ¯A     â•‘
â•‘    biáº¿t Client nháº­n Ä‘Æ°á»£c SYN-ACK! â†’ half-open connection   â•‘
â•‘  â†’ SYN Flood attack: gá»­i hÃ ng triá»‡u SYN, khÃ´ng ACK       â•‘
â•‘    â†’ Server giá»¯ hÃ ng triá»‡u half-open = crash!             â•‘
â•‘                                                               â•‘
â•‘  WHY 3: Táº¡i sao sequence numbers ngáº«u nhiÃªn (ISN)?         â•‘
â•‘  â†’ Náº¿u seq luÃ´n = 0: attacker dá»… giáº£ máº¡o packets          â•‘
â•‘  â†’ Random ISN: attacker pháº£i Ä‘oÃ¡n Ä‘Ãºng seq number         â•‘
â•‘                                                               â•‘
â•‘  WHY 4: Chi phÃ­ handshake?                                   â•‘
â•‘  â†’ 1 RTT (Round Trip Time) trÆ°á»›c khi gá»­i data              â•‘
â•‘  â†’ Vá»›i TLS: thÃªm 1-2 RTT ná»¯a! (TLS handshake)            â•‘
â•‘  â†’ SG â†’ US: 1 RTT â‰ˆ 150ms â†’ total â‰ˆ 300-450ms!          â•‘
â•‘  â†’ FIX: TCP Fast Open, TLS 1.3 (0-RTT), HTTP/3 (QUIC)    â•‘
â•‘                                                               â•‘
â•‘  WHY 5: Connection Pooling vÃ¬ overhead:                      â•‘
â•‘  â†’ Má»—i HTTP request táº¡o TCP má»›i = 150ms overhead          â•‘
â•‘  â†’ Connection pool: reuse connections â†’ 0ms overhead!      â•‘
â•‘  â†’ Go http.Client máº·c Ä‘á»‹nh pool connections                â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

```go
// Go TCP â€” Báº¡n PHáº¢I biáº¿t viáº¿t TCP server/client cÆ¡ báº£n

package main

import (
    "bufio"
    "fmt"
    "net"
)

// TCP Server
func server() {
    listener, _ := net.Listen("tcp", ":8080")
    defer listener.Close()

    for {
        conn, _ := listener.Accept() // blocking: chá» client connect
        go handleConn(conn)          // goroutine per connection
    }
}

func handleConn(conn net.Conn) {
    defer conn.Close()
    scanner := bufio.NewScanner(conn)
    for scanner.Scan() {
        msg := scanner.Text()
        fmt.Fprintf(conn, "Echo: %s\n", msg)
    }
}

// TCP Client
func client() {
    conn, _ := net.Dial("tcp", "localhost:8080")
    defer conn.Close()
    fmt.Fprintf(conn, "Hello TCP\n")

    response, _ := bufio.NewReader(conn).ReadString('\n')
    fmt.Println(response) // "Echo: Hello TCP"
}

// âš ï¸ Production: dÃ¹ng context, timeout, error handling!
// conn, _ := net.DialTimeout("tcp", addr, 5*time.Second)
// conn.SetDeadline(time.Now().Add(10*time.Second))
```

### TCP Congestion Control â€” Táº¡i Sao Internet KhÃ´ng Sá»¥p?

HÃ£y tÆ°á»Ÿng tÆ°á»£ng máº¡ng Internet lÃ  há»‡ thá»‘ng Ä‘Æ°á»ng cao tá»‘c. Náº¿u táº¥t cáº£ xe cÃ¹ng Ä‘á»• ra Ä‘Æ°á»ng mÃ  khÃ´ng ai nhÆ°á»ng â†’ **táº¯c Ä‘Æ°á»ng** â†’ khÃ´ng ai Ä‘i Ä‘Æ°á»£c. TCP Congestion Control chÃ­nh lÃ  **há»‡ thá»‘ng Ä‘Ã¨n giao thÃ´ng tá»± Ä‘á»™ng** â€” má»—i "xe" (TCP connection) tá»± giáº£m tá»‘c khi phÃ¡t hiá»‡n Ä‘Æ°á»ng Ä‘Ã´ng.

**Táº¡i sao Ä‘iá»u nÃ y QUAN TRá»ŒNG cho Backend?** VÃ¬ congestion control áº£nh hÆ°á»Ÿng trá»±c tiáº¿p Ä‘áº¿n **throughput** vÃ  **latency** cá»§a má»i API call:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TCP CONGESTION CONTROL                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â‘  Slow Start (khá»Ÿi Ä‘áº§u cháº­m):                              â•‘
â•‘  â†’ Báº¯t Ä‘áº§u gá»­i ÃT (cwnd=1 segment), tÄƒng Gáº¤P ÄÃ”I/RTT    â•‘
â•‘  â†’ 1 â†’ 2 â†’ 4 â†’ 8 â†’ 16 â†’ 32 segments                     â•‘
â•‘  â†’ Giai Ä‘oáº¡n "dÃ² Ä‘Æ°á»ng" â†’ biáº¿t máº¡ng chá»‹u Ä‘Æ°á»£c bao nhiÃªu   â•‘
â•‘  â†’ âš ï¸ Impact: file 10MB trÃªn connection má»›i = CHáº¬M         â•‘
â•‘    vÃ¬ pháº£i ramp up tá»« slow start!                            â•‘
â•‘                                                               â•‘
â•‘  Throughput vs. Time:                                        â•‘
â•‘  â”‚                                                            â•‘
â•‘  â”‚         â”Œâ”€â”€â”€â”€ Packet loss! cwnd giáº£m 50%                 â•‘
â•‘  â”‚        â•±â”‚                                                  â•‘
â•‘  â”‚       â•± â”‚     â•±â”€â”€â”€ Congestion avoidance (tÄƒng cháº­m)      â•‘
â•‘  â”‚      â•±  â”‚    â•±                                             â•‘
â•‘  â”‚     â•±   â”‚   â•±                                              â•‘
â•‘  â”‚    â•±    â”‚  â•±                                               â•‘
â•‘  â”‚   â•±     â”‚ â•±                                                â•‘
â•‘  â”‚  â•±      â”‚â•±                                                 â•‘
â•‘  â”‚ â•±  Slow â”‚  AIMD: Additive Increase,                       â•‘
â•‘  â”‚â•±  Start â”‚       Multiplicative Decrease                    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ time                     â•‘
â•‘                                                               â•‘
â•‘  â‘¡ Congestion Avoidance (sau threshold):                     â•‘
â•‘  â†’ TÄƒng cwnd cháº­m: +1 segment/RTT (linear)                 â•‘
â•‘  â†’ Packet loss â†’ giáº£m cwnd 50% (multiplicative decrease)   â•‘
â•‘  â†’ "AIMD" = Additive Increase, Multiplicative Decrease      â•‘
â•‘                                                               â•‘
â•‘  â‘¢ Modern: CUBIC (Linux default) & BBR (Google):            â•‘
â•‘  â†’ CUBIC: tá»‘i Æ°u cho high-bandwidth, high-latency networks â•‘
â•‘  â†’ BBR: Ä‘o bandwidth thá»±c táº¿, khÃ´ng dá»±a vÃ o packet loss    â•‘
â•‘  â†’ BBR tá»‘t hÆ¡n cho long-distance (cloud â†’ user)           â•‘
â•‘                                                               â•‘
â•‘  Backend Impact:                                             â•‘
â•‘  â†’ Connection má»›i = slow start = cháº­m âŒ                    â•‘
â•‘  â†’ Connection reuse (pool) = Ä‘Ã£ ramp up = nhanh âœ…          â•‘
â•‘  â†’ File lá»›n: throughput tÄƒng dáº§n, khÃ´ng instant full speed  â•‘
â•‘  â†’ gRPC streaming: 1 long-lived connection = Ä‘Ã£ "warm"     â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### TCP Connection States & TIME_WAIT â€” Báº«y Nguy Hiá»ƒm

TCP connection cÃ³ **lifecycle** vá»›i nhiá»u states. Backend Engineer PHáº¢I hiá»ƒu 2 states quan trá»ng nháº¥t: **ESTABLISHED** (Ä‘ang truyá»n data) vÃ  **TIME_WAIT** (sau khi Ä‘Ã³ng connection).

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TCP 4-WAY TEARDOWN & TIME_WAIT                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  ÄÃ³ng connection = 4-way handshake:                          â•‘
â•‘                                                               â•‘
â•‘  Client                          Server                       â•‘
â•‘    â”‚                               â”‚                          â•‘
â•‘    â”‚â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  "TÃ´i muá»‘n Ä‘Ã³ng"        â•‘
â•‘    â”‚â—„â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  "OK, nháº­n Ä‘Æ°á»£c"          â•‘
â•‘    â”‚                               â”‚  (server gá»­i ná»‘t data) â•‘
â•‘    â”‚â—„â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  "TÃ´i cÅ©ng Ä‘Ã³ng"         â•‘
â•‘    â”‚â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  "OK, táº¡m biá»‡t"         â•‘
â•‘    â”‚                               â”‚                          â•‘
â•‘    â”‚â”€â”€ TIME_WAIT (2Ã—MSL) â”€â”€â”€â”€â”€â”€â”‚  â† ÄÃ‚Y LÃ€ BáºªY!         â•‘
â•‘    â”‚   (Linux: 60 giÃ¢y)         â”‚                            â•‘
â•‘                                                               â•‘
â•‘  TIME_WAIT: táº¡i sao tá»“n táº¡i?                                â•‘
â•‘  â†’ Äáº£m báº£o packet "láº¡c" cuá»‘i cÃ¹ng (delayed segments)      â•‘
â•‘    khÃ´ng bá»‹ nháº§m sang connection Má»šI cÃ¹ng (src:port, dst:port)â•‘
â•‘  â†’ 2Ã—MSL = Maximum Segment Lifetime = 60s (Linux)          â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ TIME_WAIT problem:                                      â•‘
â•‘  â†’ Server Ä‘Ã³ng 10,000 connections/giÃ¢y                      â•‘
â•‘  â†’ Má»—i connection giá»¯ TIME_WAIT 60s                        â•‘
â•‘  â†’ = 600,000 sockets á»Ÿ TIME_WAIT!                           â•‘
â•‘  â†’ Port exhaustion: chá»‰ cÃ³ ~28,000 ephemeral ports         â•‘
â•‘  â†’ Server KHÃ”NG THá»‚ táº¡o connection má»›i = OUTAGE!          â•‘
â•‘                                                               â•‘
â•‘  FIX:                                                         â•‘
â•‘  â†’ SO_REUSEADDR: cho phÃ©p bind port Ä‘ang TIME_WAIT        â•‘
â•‘  â†’ tcp_tw_reuse: reuse TIME_WAIT sockets (Linux)           â•‘
â•‘  â†’ Connection pooling: KHÃ”NG Ä‘Ã³ng connection = no TIME_WAITâ•‘
â•‘  â†’ Go: http.Client máº·c Ä‘á»‹nh connection pooling âœ…          â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

> **War story: TIME_WAIT Storm.** Má»™t service Go má»›i deploy xá»­ lÃ½ 5,000 req/s, má»—i request gá»i Ä‘áº¿n 3 downstream services (táº¡o 3 TCP connections). Sau vÃ i phÃºt, error rate tÄƒng vá»t. `ss -s` cho tháº¥y **900,000 sockets á»Ÿ TIME_WAIT**! NguyÃªn nhÃ¢n: developer táº¡o `http.Client` má»›i cho má»—i request (khÃ´ng reuse). Má»—i client táº¡o connection má»›i rá»“i Ä‘Ã³ng â†’ TIME_WAIT 60s. Fix: dÃ¹ng **1 http.Client global** vá»›i `Transport.MaxIdleConnsPerHost = 100`.

```go
// âŒ SAI: táº¡o client má»›i má»—i request â†’ TIME_WAIT storm!
func badHandler(w http.ResponseWriter, r *http.Request) {
    client := &http.Client{}  // NEW client má»—i láº§n!
    resp, _ := client.Get("http://downstream-service/api")
    defer resp.Body.Close()
    io.Copy(w, resp.Body)
}

// âœ… ÄÃšNG: reuse global client â†’ connection pooling
var httpClient = &http.Client{
    Transport: &http.Transport{
        MaxIdleConns:        100,             // tá»•ng max idle
        MaxIdleConnsPerHost: 10,              // max idle per host
        IdleConnTimeout:     90 * time.Second,
    },
    Timeout: 10 * time.Second,
}

func goodHandler(w http.ResponseWriter, r *http.Request) {
    resp, _ := httpClient.Get("http://downstream-service/api")
    defer resp.Body.Close()
    // âš ï¸ PHáº¢I Ä‘á»c háº¿t body + close Ä‘á»ƒ connection quay láº¡i pool!
    io.Copy(w, resp.Body)
}
```

### TCP Flow Control vs Congestion Control â€” Hai CÆ¡ Cháº¿ KhÃ¡c Nhau

Nhiá»u ngÆ°á»i nháº§m láº«n 2 cÆ¡ cháº¿ nÃ y. ChÃºng giáº£i quyáº¿t **2 bÃ i toÃ¡n khÃ¡c nhau**:

|                    | Flow Control                                         | Congestion Control                 |
| ------------------ | ---------------------------------------------------- | ---------------------------------- |
| **BÃ i toÃ¡n**       | Receiver quÃ¡ cháº­m                                    | Máº¡ng quÃ¡ táº£i                       |
| **Ai quyáº¿t Ä‘á»‹nh?** | Receiver (rwnd)                                      | Sender (cwnd)                      |
| **CÆ¡ cháº¿**         | Sliding Window                                       | Slow Start + AIMD                  |
| **TÃ­n hiá»‡u**       | TCP Window Size header                               | Packet loss / delay                |
| **Analogy**        | "TÃ´i chá»‰ Ä‘á»c Ä‘Æ°á»£c 10 trang/giá», Ä‘á»«ng gá»­i nhiá»u hÆ¡n!" | "ÄÆ°á»ng Ä‘ang táº¯c, táº¥t cáº£ giáº£m tá»‘c!" |

**Sender gá»­i tá»‘i Ä‘a = min(rwnd, cwnd)** â€” giÃ¡ trá»‹ NHá» HÆ N tháº¯ng. Náº¿u receiver máº¡nh nhÆ°ng máº¡ng yáº¿u â†’ cwnd giá»›i háº¡n. Náº¿u máº¡ng máº¡nh nhÆ°ng receiver yáº¿u â†’ rwnd giá»›i háº¡n.

### TCP Retransmission â€” Khi Packet Bá»‹ Máº¥t

ÄÃ¢y lÃ  cÆ¡ cháº¿ **quan trá»ng nháº¥t** Ä‘á»ƒ TCP Ä‘Ã¡ng tin cáº­y. Khi sender gá»­i data mÃ  khÃ´ng nháº­n Ä‘Æ°á»£c ACK, nÃ³ pháº£i **gá»­i láº¡i**:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TCP RETRANSMISSION MECHANISMS                               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â‘  RTO (Retransmission Timeout):                             â•‘
â•‘  â†’ Gá»­i segment â†’ start timer â†’ khÃ´ng nháº­n ACK â†’ TIMEOUT  â•‘
â•‘  â†’ Retransmit segment + DOUBLE timeout (exponential backoff)â•‘
â•‘  â†’ RTO = SRTT + 4 Ã— RTTVAR (dynamic, dá»±a trÃªn RTT Ä‘o Ä‘Æ°á»£c)â•‘
â•‘  â†’ Initial RTO: 1 giÃ¢y (RFC 6298)                          â•‘
â•‘  â†’ Max RTO: 120 giÃ¢y (Linux net.ipv4.tcp_retries2 = 15)   â•‘
â•‘  â†’ 15 retries = ~15 phÃºt trÆ°á»›c khi TCP tá»« bá» connection!  â•‘
â•‘                                                               â•‘
â•‘  â‘¡ Fast Retransmit (khÃ´ng cáº§n chá» timeout!):                â•‘
â•‘                                                               â•‘
â•‘  Sender gá»­i:    seg 1  seg 2  seg 3  seg 4  seg 5           â•‘
â•‘  Receiver nháº­n: seg 1  seg 2  âœ—(máº¥t) seg 4  seg 5           â•‘
â•‘  Receiver ACK:  ACK 2  ACK 3  ACK 3  ACK 3  ACK 3           â•‘
â•‘                                â†‘dup   â†‘dup   â†‘dup            â•‘
â•‘                                                               â•‘
â•‘  â†’ 3 Duplicate ACKs (cÃ¹ng ACK number) = packet loss!       â•‘
â•‘  â†’ Sender retransmit seg 3 NGAY Láº¬P Tá»¨C (khÃ´ng chá» RTO!)  â•‘
â•‘  â†’ Nhanh hÆ¡n RTO timeout hÃ ng trÄƒm milliseconds!           â•‘
â•‘                                                               â•‘
â•‘  â‘¢ SACK (Selective ACK) â€” trÃ¡nh retransmit thá»«a:           â•‘
â•‘                                                               â•‘
â•‘  KhÃ´ng cÃ³ SACK:                                              â•‘
â•‘  â†’ Receiver nháº­n: 1,2,_,4,5,_,7 â†’ ACK 3                  â•‘
â•‘  â†’ Sender retransmit 3,4,5,6,7 (Cáº¢ ÄÃM! dÃ¹ 4,5,7 Ä‘Ã£ cÃ³) â•‘
â•‘                                                               â•‘
â•‘  CÃ³ SACK:                                                     â•‘
â•‘  â†’ Receiver nháº­n: 1,2,_,4,5,_,7 â†’ ACK 3, SACK [4-5,7-7]  â•‘
â•‘  â†’ Sender biáº¿t: CHá»ˆ Cáº¦N retransmit 3 vÃ  6!                â•‘
â•‘  â†’ Tiáº¿t kiá»‡m bandwidth Ä‘Ã¡ng ká»ƒ!                            â•‘
â•‘                                                               â•‘
â•‘  Backend impact:                                             â•‘
â•‘  â†’ Packet loss 0.1% nghe Ã­t, nhÆ°ng:                        â•‘
â•‘    â†’ 1 API response 100 segments, P(máº¥t â‰¥1) = 9.5%!      â•‘
â•‘    â†’ Má»—i retransmit thÃªm â‰¥1 RTT delay                    â•‘
â•‘    â†’ p99 latency tÄƒng vá»t do retransmit                    â•‘
â•‘  â†’ Monitor packet loss: netstat -s | grep retransmit       â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### TCP Options â€” ÄÃ m PhÃ¡n Khi Handshake

TCP options Ä‘Æ°á»£c trao Ä‘á»•i trong **SYN/SYN-ACK** (handshake) vÃ  áº£nh hÆ°á»Ÿng TOÃ€N Bá»˜ connection:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TCP OPTIONS â€” NEGOTIATED DURING HANDSHAKE                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â‘  MSS (Maximum Segment Size):                               â•‘
â•‘  â†’ "Segment lá»›n nháº¥t tÃ´i cháº¥p nháº­n"                        â•‘
â•‘  â†’ Typical: 1460 bytes (1500 MTU - 20 IP - 20 TCP)         â•‘
â•‘  â†’ Náº¿u khÃ´ng negotiate: default 536 bytes (ráº¥t nhá»!)      â•‘
â•‘  â†’ VPN/overlay: MSS tháº¥p hÆ¡n (1360-1400)                   â•‘
â•‘                                                               â•‘
â•‘  â‘¡ Window Scale (RFC 7323):                                   â•‘
â•‘  â†’ Window Size field chá»‰ 16 bits = max 64KB                â•‘
â•‘  â†’ Vá»›i high-bandwidth link: 64KB quÃ¡ nhá»!                  â•‘
â•‘  â†’ Window Scale: nhÃ¢n thÃªm 2^n (scale factor 0-14)         â•‘
â•‘  â†’ Max: 64KB Ã— 2^14 = 1GB window!                         â•‘
â•‘  â†’ Báº¯t buá»™c cho high-speed networks (10Gbps+)              â•‘
â•‘                                                               â•‘
â•‘  â‘¢ Timestamps (RFC 7323):                                     â•‘
â•‘  â†’ TSval/TSecr: Ä‘o RTT chÃ­nh xÃ¡c hÆ¡n                       â•‘
â•‘  â†’ PAWS (Protection Against Wrapped Sequences):             â•‘
â•‘    â†’ Sequence number chá»‰ 32 bits = wrap sau 4GB            â•‘
â•‘    â†’ 10Gbps link: wrap trong 3.4 giÃ¢y!                     â•‘
â•‘    â†’ Timestamps giÃºp detect old duplicated segments        â•‘
â•‘  â†’ ThÃªm 12 bytes má»—i segment                               â•‘
â•‘                                                               â•‘
â•‘  â‘£ SACK Permitted + SACK Blocks:                              â•‘
â•‘  â†’ Permit: thá»a thuáº­n trong SYN â†’ "tÃ´i há»— trá»£ SACK"     â•‘
â•‘  â†’ Blocks: trong data transfer â†’ "tÃ´i ÄÃƒ nháº­n [4-5,7-7]"â•‘
â•‘  â†’ Háº§u háº¿t OS modern Ä‘á»u enable SACK by default            â•‘
â•‘                                                               â•‘
â•‘  â‘¤ TCP Fast Open (TFO):                                       â•‘
â•‘  â†’ Gá»­i data NGAY TRONG SYN packet! (0-RTT for repeat)     â•‘
â•‘  â†’ Láº§n Ä‘áº§u: váº«n 3-way, server tráº£ TFO cookie              â•‘
â•‘  â†’ Láº§n sau: SYN + cookie + data â†’ server xá»­ lÃ½ ngay!     â•‘
â•‘  â†’ Giáº£m 1 RTT cho repeated connections                     â•‘
â•‘  â†’ Linux: sysctl net.ipv4.tcp_fastopen = 3                  â•‘
â•‘  â†’ âš ï¸ Security concern: replay attacks possible            â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Nagle's Algorithm & TCP_NODELAY â€” Latency Killer

**Nagle's Algorithm** gom cÃ¡c TCP segments NHá» láº¡i thÃ nh 1 segment Lá»šN trÆ°á»›c khi gá»­i â€” tiáº¿t kiá»‡m bandwidth nhÆ°ng **tÄƒng latency**:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   NAGLE'S ALGORITHM vs TCP_NODELAY                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Nagle ON (default):                                          â•‘
â•‘  â†’ App write("H") â†’ buffer, chá»...                         â•‘
â•‘  â†’ App write("e") â†’ buffer, chá»...                         â•‘
â•‘  â†’ App write("l") â†’ buffer, chá»...                         â•‘
â•‘  â†’ ACK from previous segment arrives â†’ gá»­i "Hel"           â•‘
â•‘  â†’ Giáº£m overhead: 3 segments â†’ 1 segment!                  â•‘
â•‘  â†’ NhÆ°ng: thÃªm DELAY (chá» ACK hoáº·c buffer Ä‘áº§y)            â•‘
â•‘                                                               â•‘
â•‘  Nagle OFF (TCP_NODELAY):                                     â•‘
â•‘  â†’ App write("H") â†’ Gá»¬I NGAY!                              â•‘
â•‘  â†’ App write("e") â†’ Gá»¬I NGAY!                              â•‘
â•‘  â†’ App write("l") â†’ Gá»¬I NGAY!                              â•‘
â•‘  â†’ 3 segments riÃªng (3 Ã— 54B header = 162B cho 3 chars!)  â•‘
â•‘  â†’ NhÆ°ng: LOW LATENCY!                                      â•‘
â•‘                                                               â•‘
â•‘  BáºªY: Nagle + Delayed ACK = 200ms delay!                    â•‘
â•‘  â†’ Nagle: chá» ACK trÆ°á»›c khi gá»­i tiáº¿p                      â•‘
â•‘  â†’ Delayed ACK: receiver chá» 200ms trÆ°á»›c khi gá»­i ACK     â•‘
â•‘  â†’ = Deadlock 200ms! (cáº£ 2 bÃªn Ä‘á»u chá» nhau!)              â•‘
â•‘                                                               â•‘
â•‘  Khi nÃ o TCP_NODELAY?                                         â•‘
â•‘  â†’ âœ… Real-time: chat, gaming, trading, mouse events        â•‘
â•‘  â†’ âœ… Request-response: HTTP, gRPC, database queries        â•‘
â•‘  â†’ âœ… Interactive SSH sessions                               â•‘
â•‘  â†’ âŒ Bulk transfer: file upload, streaming data             â•‘
â•‘                                                               â•‘
â•‘  Háº§u háº¿t frameworks Ä‘Ã£ set TCP_NODELAY:                      â•‘
â•‘  â†’ Go net/http: TCP_NODELAY = true (default)                â•‘
â•‘  â†’ Node.js: socket.setNoDelay(true)                         â•‘
â•‘  â†’ Nginx: tcp_nodelay on (default)                           â•‘
â•‘  â†’ Redis, PostgreSQL: TCP_NODELAY = true                    â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### TCP Keep-Alive â€” Connection Health Check

**TCP Keep-Alive** â‰  **HTTP Keep-Alive**! ÄÃ¢y lÃ  2 cÆ¡ cháº¿ hoÃ n toÃ n khÃ¡c nhau:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TCP KEEP-ALIVE vs HTTP KEEP-ALIVE                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  TCP Keep-Alive (OS level):                                  â•‘
â•‘  â†’ Connection idle â†’ OS gá»­i probe packet Ä‘á»‹nh ká»³          â•‘
â•‘  â†’ Náº¿u peer reply â†’ connection váº«n sá»‘ng                   â•‘
â•‘  â†’ Náº¿u peer khÃ´ng reply â†’ connection DEAD â†’ close!        â•‘
â•‘                                                               â•‘
â•‘  Linux defaults (quÃ¡ cháº­m cho production!):                  â•‘
â•‘  â†’ tcp_keepalive_time = 7200 (2 TIáº¾NG má»›i probe Ä‘áº§u tiÃªn!)â•‘
â•‘  â†’ tcp_keepalive_intvl = 75  (75 giÃ¢y giá»¯a má»—i probe)     â•‘
â•‘  â†’ tcp_keepalive_probes = 9  (9 probes trÆ°á»›c khi dead)     â•‘
â•‘  â†’ = 2 tiáº¿ng + 11 phÃºt trÆ°á»›c khi detect dead connection!  â•‘
â•‘                                                               â•‘
â•‘  Recommended cho production:                                  â•‘
â•‘  â†’ tcp_keepalive_time = 60   (probe sau 60s idle)           â•‘
â•‘  â†’ tcp_keepalive_intvl = 10  (má»—i 10s)                     â•‘
â•‘  â†’ tcp_keepalive_probes = 6  (6 probes = 60s detect dead)  â•‘
â•‘  â†’ Total: 60s + 60s = 2 phÃºt detect dead (vs 2 tiáº¿ng!)    â•‘
â•‘                                                               â•‘
â•‘  HTTP Keep-Alive (Application level):                        â•‘
â•‘  â†’ Connection: keep-alive header                             â•‘
â•‘  â†’ Reuse TCP connection cho nhiá»u HTTP requests             â•‘
â•‘  â†’ HTTP/1.1: default keep-alive                              â•‘
â•‘  â†’ HTTP/2: multiplexed (nhiá»u requests trÃªn 1 connection)  â•‘
â•‘  â†’ KHÃC TCP keep-alive! ÄÃ¢y chá»‰ lÃ  "Ä‘á»«ng Ä‘Ã³ng connection" â•‘
â•‘                                                               â•‘
â•‘  Go setup:                                                    â•‘
â•‘  â†’ net.Dialer{KeepAlive: 30 * time.Second}                 â•‘
â•‘  â†’ gRPC: keepalive.ClientParameters{Time: 10*time.Second}  â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Cloud/LB timeout:                                        â•‘
â•‘  â†’ AWS ALB idle timeout: 60s (default)                      â•‘
â•‘  â†’ AWS NLB: 350s                                             â•‘
â•‘  â†’ Connection idle hÆ¡n LB timeout â†’ LB drop silently!     â•‘
â•‘  â†’ App gá»­i data trÃªn dead connection â†’ RST â†’ error!       â•‘
â•‘  â†’ FIX: keep-alive interval < LB idle timeout!             â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Socket Tuning Cho Production

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   LINUX TCP TUNING â€” PRODUCTION SERVER                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  # Buffer sizes (throughput)                                  â•‘
â•‘  net.core.rmem_max = 16777216      # 16MB receive buffer    â•‘
â•‘  net.core.wmem_max = 16777216      # 16MB send buffer       â•‘
â•‘  net.ipv4.tcp_rmem = 4096 87380 16777216  # min/default/max â•‘
â•‘  net.ipv4.tcp_wmem = 4096 65536 16777216                     â•‘
â•‘                                                               â•‘
â•‘  # Connection handling (high traffic)                        â•‘
â•‘  net.core.somaxconn = 65535           # listen() backlog     â•‘
â•‘  net.ipv4.tcp_max_syn_backlog = 65535 # SYN queue size      â•‘
â•‘  net.core.netdev_max_backlog = 65535  # NIC â†’ kernel queue  â•‘
â•‘                                                               â•‘
â•‘  # TIME_WAIT handling                                         â•‘
â•‘  net.ipv4.tcp_tw_reuse = 1           # reuse TIME_WAIT      â•‘
â•‘  net.ipv4.ip_local_port_range = 1024 65535  # more ports    â•‘
â•‘                                                               â•‘
â•‘  # Congestion control                                        â•‘
â•‘  net.ipv4.tcp_congestion_control = bbr  # Google BBR        â•‘
â•‘  net.core.default_qdisc = fq            # fair queuing      â•‘
â•‘                                                               â•‘
â•‘  # Keep-alive                                                â•‘
â•‘  net.ipv4.tcp_keepalive_time = 60                            â•‘
â•‘  net.ipv4.tcp_keepalive_intvl = 10                           â•‘
â•‘  net.ipv4.tcp_keepalive_probes = 6                           â•‘
â•‘                                                               â•‘
â•‘  # Conntrack (NAT/Docker/K8s)                                â•‘
â•‘  net.nf_conntrack_max = 1048576                              â•‘
â•‘  net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30      â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Apply: sysctl -p /etc/sysctl.d/99-tcp-tuning.conf     â•‘
â•‘  âš ï¸ K8s: pháº£i set trÃªn HOST node, khÃ´ng pháº£i trong pod!   â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### TCP & UDP Debug Commands

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  TCP/UDP DEBUGGING TOOLKIT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Socket statistics (modern replacement for netstat)
ss -tlnp                    # TCP listening sockets + PID
ss -tunap                   # All TCP/UDP sockets + PID
ss -s                       # Socket summary (total, TIME_WAIT count)
# Output: TCP: 12543 (estab 234, closed 11000, timewait 11000)
#         â†‘ quÃ¡ nhiá»u TIME_WAIT = problem!

# Count connections by state
ss -tan | awk '{print $1}' | sort | uniq -c | sort -rn
# Output:
#  11234 TIME-WAIT
#    456 ESTAB
#    123 FIN-WAIT-2
#     12 SYN-SENT      â† nhiá»u SYN-SENT = server cháº­m/down

# TCP retransmission stats
netstat -s | grep -i retransmit
# "12345 segments retransmitted"
# So sÃ¡nh vá»›i total segments: > 1% = network problem!

# Capture TCP handshake + data
sudo tcpdump -i eth0 'tcp port 443' -nn -c 20
# Output: SYN, SYN-ACK, ACK, [PSH,ACK], [FIN,ACK]

# Capture specific host
sudo tcpdump -i any host 10.0.1.5 and port 8080 -w capture.pcap
# â†’ Open in Wireshark for deep analysis

# Test TCP connectivity
nc -zv hostname 8080         # TCP connect test
nc -zvu hostname 53          # UDP connect test (DNS)

# Check ephemeral port range
cat /proc/sys/net/ipv4/ip_local_port_range
# "32768   60999" â†’ ~28K ports available

# Monitor TCP connection in real-time
watch -n 1 'ss -s'           # refresh every second

# gRPC/HTTP2 specific
curl -v --http2 https://api.example.com  # see TLS + HTTP2 negotiation
grpcurl -plaintext localhost:50051 list  # gRPC service discovery
```

---

## Â§5. Layer 5 â€” Session: Quáº£n LÃ½ PhiÃªn Káº¿t Ná»‘i

### BÃ i toÃ¡n gá»‘c: Duy trÃ¬ "cuá»™c há»™i thoáº¡i" giá»¯a 2 bÃªn

Trong thá»±c táº¿, Layer 5 lÃ  layer "vÃ´ hÃ¬nh" nháº¥t â€” nÃ³ khÃ´ng cÃ³ protocol riÃªng mÃ  **hÃ²a vÃ o Layer 4 vÃ  Layer 7**. NhÆ°ng concept "session" cá»±c ká»³ quan trá»ng cho Backend Engineer.

HÃ£y nghÄ© vá» **cuá»™c gá»i Ä‘iá»‡n thoáº¡i**: Layer 4 (TCP) giá»‘ng nhÆ° Ä‘Æ°á»ng dÃ¢y â€” káº¿t ná»‘i 2 Ä‘áº§u. NhÆ°ng **ai quáº£n lÃ½ cuá»™c gá»i?** Ai quyáº¿t Ä‘á»‹nh "cuá»™c gá»i báº¯t Ä‘áº§u", "táº¡m giá»¯" (hold), "ná»‘i láº¡i" (resume), "káº¿t thÃºc"? ÄÃ³ lÃ  Layer 5.

**5 Whys â€” Táº¡i sao cáº§n Session?**

1. **Táº¡i sao cáº§n session?** â†’ VÃ¬ HTTP lÃ  **stateless** â€” server khÃ´ng biáº¿t 2 requests liÃªn tiáº¿p lÃ  cÃ¹ng 1 user
2. **Táº¡i sao HTTP stateless?** â†’ Äá»ƒ Ä‘Æ¡n giáº£n, dá»… scale (báº¥t ká»³ server nÃ o cÅ©ng handle Ä‘Æ°á»£c báº¥t ká»³ request nÃ o)
3. **Táº¡i sao stateless láº¡i gÃ¢y váº¥n Ä‘á»?** â†’ VÃ¬ háº§u háº¿t á»©ng dá»¥ng Cáº¦N state (login, giá» hÃ ng, preferences)
4. **Táº¡i sao khÃ´ng lÃ m HTTP stateful?** â†’ Sáº½ coupling request-server, khÃ´ng thá»ƒ load balance
5. **Váº­y giáº£i phÃ¡p?** â†’ "Giáº£ láº­p" state báº±ng session: cookie, token, hoáº·c server-side storage

### HTTP Session Management â€” Cookies, JWT, Server-Side Sessions

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   SESSION MANAGEMENT â€” 3 APPROACHES                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â‘  Cookie-based Sessions (Traditional):                      â•‘
â•‘                                                               â•‘
â•‘  Browser â”€â”€â”€â”€ POST /login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Server         â•‘
â•‘  Browser â—„â”€â”€â”€ Set-Cookie: sid=abc123 â”€â”€â”€â”€â”€â”€ Server          â•‘
â•‘  Browser â”€â”€â”€â”€ GET /profile (Cookie: sid=abc)â–º Server         â•‘
â•‘                                    sid=abc â†’ lookup Redis   â•‘
â•‘                                    â†’ user_id=42, role=admin â•‘
â•‘                                                               â•‘
â•‘  â†’ Session data lÆ°u SERVER-SIDE (Redis/Memcached/DB)       â•‘
â•‘  â†’ Cookie chá»‰ chá»©a session ID (opaque string)              â•‘
â•‘  â†’ âœ… Revocable: xÃ³a session khá»i Redis = logout ngay!    â•‘
â•‘  â†’ âœ… Small cookie size (session ID = ~32 bytes)            â•‘
â•‘  â†’ âŒ Server-side storage (Redis = thÃªm dependency)        â•‘
â•‘  â†’ âŒ Sticky session náº¿u khÃ´ng dÃ¹ng shared store           â•‘
â•‘                                                               â•‘
â•‘  â‘¡ JWT (JSON Web Token) â€” Stateless:                         â•‘
â•‘                                                               â•‘
â•‘  Browser â”€â”€â”€â”€ POST /login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Server         â•‘
â•‘  Browser â—„â”€â”€â”€ {token: "eyJhbGci..."} â”€â”€â”€â”€â”€â”€â”€ Server        â•‘
â•‘  Browser â”€â”€â”€â”€ GET /profile                   â–º Server        â•‘
â•‘               Authorization: Bearer eyJhbGci..               â•‘
â•‘                                    â†’ verify signature       â•‘
â•‘                                    â†’ decode payload         â•‘
â•‘                                    â†’ {user_id:42, exp:...}  â•‘
â•‘                                                               â•‘
â•‘  JWT structure: header.payload.signature                      â•‘
â•‘  â†’ Header:  {"alg":"RS256","typ":"JWT"}                     â•‘
â•‘  â†’ Payload: {"sub":"42","role":"admin","exp":1735689600}    â•‘
â•‘  â†’ Signature: HMAC-SHA256(header+payload, secret)           â•‘
â•‘                                                               â•‘
â•‘  â†’ âœ… Stateless: khÃ´ng cáº§n Redis, báº¥t ká»³ server nÃ o verify â•‘
â•‘  â†’ âœ… Cross-service: microservice A â†’ B â†’ C (forward JWT) â•‘
â•‘  â†’ âŒ Cannot revoke! (chá»‰ chá» expire hoáº·c dÃ¹ng blacklist)  â•‘
â•‘  â†’ âŒ Large size (~800 bytes vs 32 bytes session ID)        â•‘
â•‘  â†’ âŒ Payload unencrypted (base64 â‰  encryption!)           â•‘
â•‘                                                               â•‘
â•‘  â‘¢ Hybrid (Production best practice):                        â•‘
â•‘  â†’ Short-lived Access Token (JWT, 15 min)                   â•‘
â•‘  â†’ Long-lived Refresh Token (opaque, in Redis, 7 days)     â•‘
â•‘  â†’ Rotate refresh token má»—i láº§n dÃ¹ng                      â•‘
â•‘  â†’ Revoke: xÃ³a refresh token khá»i Redis                   â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

|                   | Cookie Session     | JWT                    | Hybrid                     |
| ----------------- | ------------------ | ---------------------- | -------------------------- |
| **State storage** | Server (Redis)     | Client (token)         | Access=client, Refresh=srv |
| **Revocation**    | Instant âœ…         | Impossible âŒ          | Via refresh token âœ…       |
| **Scale**         | Need shared store  | Stateless âœ…           | Best of both âœ…            |
| **Size**          | 32 bytes           | ~800 bytes             | ~800B + 32B                |
| **Cross-service** | Hard (share Redis) | Easy âœ…                | Easy âœ…                    |
| **Security risk** | Session hijacking  | Token theft, no revoke | Shorter exposure window    |

### TLS Session Resumption â€” Giáº£m Handshake Overhead

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   TLS SESSION RESUMPTION                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Full TLS 1.2 Handshake (2 RTT):                            â•‘
â•‘  Client  â”€â”€â”€ ClientHello â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Server         â•‘
â•‘  Client  â—„â”€â”€ ServerHello + Cert + KeyExchange  Server       â•‘
â•‘  Client  â”€â”€â”€ ClientKeyExchange + Finished â”€â”€â–º Server        â•‘
â•‘  Client  â—„â”€â”€ Finished â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Server         â•‘
â•‘  Client  â—„â•â• Application Data â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º Server        â•‘
â•‘  = 2 RTT trÆ°á»›c khi gá»­i data! (SGâ†’US: 300ms overhead!)     â•‘
â•‘                                                               â•‘
â•‘  â‘  Session ID (TLS 1.2):                                     â•‘
â•‘  â†’ Server cache session params + gÃ¡n ID                     â•‘
â•‘  â†’ Client gá»­i láº¡i Session ID â†’ server lookup â†’ 1 RTT!    â•‘
â•‘  â†’ âŒ Server pháº£i cache HÃ€NG TRIá»†U sessions                â•‘
â•‘  â†’ âŒ Multi-server: cáº§n shared cache hoáº·c sticky sessions  â•‘
â•‘                                                               â•‘
â•‘  â‘¡ Session Ticket (TLS 1.2):                                  â•‘
â•‘  â†’ Server encrypt session state â†’ gá»­i cho client           â•‘
â•‘  â†’ Client gá»­i láº¡i ticket â†’ server decrypt â†’ 1 RTT!       â•‘
â•‘  â†’ âœ… Stateless! Server khÃ´ng cáº§n cache                    â•‘
â•‘  â†’ âŒ Ticket key PHáº¢I rotate Ä‘á»‹nh ká»³ (security!)          â•‘
â•‘                                                               â•‘
â•‘  â‘¢ PSK (TLS 1.3) â€” 0-RTT Resumption:                        â•‘
â•‘  â†’ Client gá»­i PSK + early data NGAY trong ClientHello!    â•‘
â•‘  â†’ Server decrypt + process â†’ DATA mÃ  KHÃ”NG Cáº¦N chá»!      â•‘
â•‘  â†’ = 0 RTT! Gá»­i data ngay láº­p tá»©c!                        â•‘
â•‘  â†’ âš ï¸ 0-RTT replay risk:                                   â•‘
â•‘    â†’ Attacker capture + replay 0-RTT data                   â•‘
â•‘    â†’ Äá»ªNG cho phÃ©p 0-RTT vá»›i mutations (POST, PUT, DELETE)â•‘
â•‘    â†’ Chá»‰ an toÃ n cho idempotent requests (GET)             â•‘
â•‘                                                               â•‘
â•‘  TLS 1.3 Full Handshake = 1 RTT (vs TLS 1.2 = 2 RTT):     â•‘
â•‘  â†’ Fewer round trips + stronger cipher suites              â•‘
â•‘  â†’ LUÃ”N dÃ¹ng TLS 1.3 khi cÃ³ thá»ƒ!                          â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### WebSocket â€” Deep Dive

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   WEBSOCKET UPGRADE FLOW                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Client                              Server                  â•‘
â•‘    â”‚                                   â”‚                      â•‘
â•‘    â”‚â”€â”€ HTTP GET /ws â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â•‘
â•‘    â”‚   Upgrade: websocket              â”‚                      â•‘
â•‘    â”‚   Connection: Upgrade             â”‚                      â•‘
â•‘    â”‚   Sec-WebSocket-Key: abc123       â”‚                      â•‘
â•‘    â”‚   Sec-WebSocket-Version: 13       â”‚                      â•‘
â•‘    â”‚                                   â”‚                      â•‘
â•‘    â”‚â—„â”€ HTTP 101 Switching Protocols â”€â”€â”‚                      â•‘
â•‘    â”‚   Upgrade: websocket              â”‚                      â•‘
â•‘    â”‚   Sec-WebSocket-Accept: xyz789    â”‚                      â•‘
â•‘    â”‚                                   â”‚                      â•‘
â•‘    â”‚â—„â•â•â•â•â•â•â• Full-Duplex Frames â•â•â•â•â•â–ºâ”‚                      â•‘
â•‘    â”‚   (text frames, binary frames)    â”‚                      â•‘
â•‘    â”‚                                   â”‚                      â•‘
â•‘    â”‚â—„â”€â”€ PING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Heartbeat            â•‘
â•‘    â”‚â”€â”€ PONG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â•‘
â•‘                                                               â•‘
â•‘  WebSocket Frame Format:                                      â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘  â”‚FIN(1)â”‚Opcodeâ”‚MASK(1) â”‚Payload  â”‚ Masking Key (4B) â”‚     â•‘
â•‘  â”‚      â”‚(4b)  â”‚        â”‚Length   â”‚ (client â†’ server)â”‚     â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘                                                               â•‘
â•‘  Opcodes:                                                     â•‘
â•‘  â†’ 0x1 = Text frame    â”‚ 0x2 = Binary frame                â•‘
â•‘  â†’ 0x8 = Close         â”‚ 0x9 = Ping  â”‚ 0xA = Pong         â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Masking: clientâ†’server frames PHáº¢I masked               â•‘
â•‘  â†’ Táº¡i sao? NgÄƒn cache poisoning attacks trÃªn proxy!       â•‘
â•‘  â†’ Serverâ†’client: KHÃ”NG mask (tiáº¿t kiá»‡m CPU)              â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**WebSocket Scaling â€” Triá»‡u Connections:**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   WEBSOCKET SCALING â€” 1M CONNECTIONS                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Challenge: má»—i WS connection = 1 goroutine + buffers       â•‘
â•‘  â†’ 10K connections (gorilla/websocket):                      â•‘
â•‘    â†’ 10K goroutines Ã— 8KB stack = 80MB                     â•‘
â•‘    â†’ 10K read buffers Ã— 4KB = 40MB                         â•‘
â•‘    â†’ Total: ~120MB (cháº¥p nháº­n Ä‘Æ°á»£c)                        â•‘
â•‘  â†’ 1M connections:                                            â•‘
â•‘    â†’ 1M goroutines = 8GB stack alone!                       â•‘
â•‘    â†’ + buffers = 12GB+ RAM â†’ KHÃ”NG THá»‚!                   â•‘
â•‘                                                               â•‘
â•‘  Solutions:                                                   â•‘
â•‘                                                               â•‘
â•‘  â‘  gobwas/ws (Go, zero-alloc):                               â•‘
â•‘  â†’ KhÃ´ng táº¡o goroutine per connection                       â•‘
â•‘  â†’ DÃ¹ng epoll/kqueue Ä‘á»ƒ multiplex I/O                      â•‘
â•‘  â†’ 1M connections â‰ˆ 1-2GB RAM!                             â•‘
â•‘                                                               â•‘
â•‘  â‘¡ Event-driven architecture:                                 â•‘
â•‘  â†’ epoll (Linux): monitor hÃ ng triá»‡u FDs efficiently       â•‘
â•‘  â†’ io_uring (Linux 5.1+): async I/O, even faster           â•‘
â•‘  â†’ kqueue (macOS/BSD)                                        â•‘
â•‘                                                               â•‘
â•‘  â‘¢ Horizontal scaling:                                        â•‘
â•‘  â†’ Redis Pub/Sub: broadcast messages across servers         â•‘
â•‘  â†’ NATS / Kafka: message bus giá»¯a WS servers               â•‘
â•‘  â†’ Client â†’ LB â†’ WS Server 1 â”€â”                          â•‘
â•‘  â†’ Client â†’ LB â†’ WS Server 2 â”€â”œâ”€â”€ Redis Pub/Sub          â•‘
â•‘  â†’ Client â†’ LB â†’ WS Server 3 â”€â”˜                          â•‘
â•‘  â†’ Message to user X: publish â†’ all servers check          â•‘
â•‘  â†’ Server cÃ³ connection cá»§a user X: forward message        â•‘
â•‘                                                               â•‘
â•‘  â‘£ Reconnection strategies:                                   â•‘
â•‘  â†’ Client PHáº¢I handle reconnect (network hiccup, deploy)   â•‘
â•‘  â†’ Exponential backoff: 1s, 2s, 4s, 8s... max 30s         â•‘
â•‘  â†’ Jitter: randomize delay Ä‘á»ƒ trÃ¡nh thundering herd        â•‘
â•‘  â†’ Last-Event-ID: resume from last known position          â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### SSE vs WebSocket vs Long Polling

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   REAL-TIME COMMUNICATION â€” SO SÃNH                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚ Feature      â”‚ Long Poll â”‚ SSE       â”‚ WebSocket    â”‚    â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â•‘
â•‘  â”‚ Direction    â”‚ Pull      â”‚ Serverâ†’   â”‚ Bi-directionalâ”‚   â•‘
â•‘  â”‚              â”‚ (client)  â”‚ Client    â”‚ (both ways)   â”‚   â•‘
â•‘  â”‚ Protocol     â”‚ HTTP      â”‚ HTTP      â”‚ WS (upgrade)  â”‚   â•‘
â•‘  â”‚ Connection   â”‚ Re-create â”‚ Persistentâ”‚ Persistent    â”‚   â•‘
â•‘  â”‚ Text/Binary  â”‚ Both      â”‚ Text only â”‚ Both          â”‚   â•‘
â•‘  â”‚ Auto-reconnectâ”‚ Manual   â”‚ Built-in! â”‚ Manual        â”‚   â•‘
â•‘  â”‚ HTTP/2 compatâ”‚ Yes       â”‚ Yes âœ…    â”‚ Separate conn â”‚   â•‘
â•‘  â”‚ Proxy/FW     â”‚ Easy      â”‚ Easy      â”‚ May be blockedâ”‚   â•‘
â•‘  â”‚ Browser API  â”‚ fetch()   â”‚ EventSourceâ”‚ WebSocket    â”‚   â•‘
â•‘  â”‚ Complexity   â”‚ Low       â”‚ Low       â”‚ High          â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                               â•‘
â•‘  Khi nÃ o dÃ¹ng gÃ¬?                                            â•‘
â•‘                                                               â•‘
â•‘  Long Polling:                                                â•‘
â•‘  â†’ Legacy browsers, Ä‘Æ¡n giáº£n                                â•‘
â•‘  â†’ Comet pattern (outdated)                                  â•‘
â•‘                                                               â•‘
â•‘  SSE (Server-Sent Events):                                   â•‘
â•‘  â†’ âœ… Notifications, live feeds, stock prices               â•‘
â•‘  â†’ âœ… ChatGPT-style streaming responses!                    â•‘
â•‘  â†’ âœ… Auto-reconnect + Last-Event-ID built-in              â•‘
â•‘  â†’ âœ… Multiplexed trÃªn HTTP/2 (share connection!)          â•‘
â•‘  â†’ âŒ Serverâ†’Client only (client gá»­i qua regular HTTP)    â•‘
â•‘                                                               â•‘
â•‘  WebSocket:                                                   â•‘
â•‘  â†’ âœ… Chat, gaming, collaborative editing                   â•‘
â•‘  â†’ âœ… Binary data (file chunks, audio/video)               â•‘
â•‘  â†’ âœ… True bi-directional (cáº£ 2 bÃªn gá»­i báº¥t cá»© lÃºc nÃ o) â•‘
â•‘  â†’ âŒ Complexity: reconnect, auth, heartbeat, scaling      â•‘
â•‘  â†’ âŒ Cannot be multiplexed trÃªn HTTP/2 connection         â•‘
â•‘                                                               â•‘
â•‘  ğŸ“Œ Rule of thumb:                                           â•‘
â•‘  â†’ Server push only? â†’ SSE (Ä‘Æ¡n giáº£n hÆ¡n, auto-reconnect)â•‘
â•‘  â†’ Bi-directional? â†’ WebSocket                              â•‘
â•‘  â†’ Äá»«ng dÃ¹ng WebSocket khi SSE Ä‘á»§! (over-engineering)     â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### gRPC Streaming â€” 4 Communication Patterns

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   gRPC STREAMING PATTERNS                                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â‘  Unary RPC (request â†’ response):                          â•‘
â•‘  Client â”€â”€â”€â”€ GetUser(id:42) â”€â”€â”€â”€â”€â”€â”€â”€â–º Server                â•‘
â•‘  Client â—„â”€â”€â”€ {name:"Jun", age:30} â”€â”€â”€ Server               â•‘
â•‘  â†’ Giá»‘ng HTTP request/response                              â•‘
â•‘                                                               â•‘
â•‘  â‘¡ Server Streaming (1 request â†’ N responses):              â•‘
â•‘  Client â”€â”€â”€â”€ ListOrders(user:42) â”€â”€â–º Server                 â•‘
â•‘  Client â—„â”€â”€â”€ {order: #1} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Server                â•‘
â•‘  Client â—„â”€â”€â”€ {order: #2} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Server                â•‘
â•‘  Client â—„â”€â”€â”€ {order: #3} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Server                â•‘
â•‘  Client â—„â”€â”€â”€ EOF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  Server                 â•‘
â•‘  â†’ Use case: dashboards, log streaming, large result sets  â•‘
â•‘                                                               â•‘
â•‘  â‘¢ Client Streaming (N requests â†’ 1 response):              â•‘
â•‘  Client â”€â”€â”€â”€ {chunk: 1/3} â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Server                 â•‘
â•‘  Client â”€â”€â”€â”€ {chunk: 2/3} â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Server                â•‘
â•‘  Client â”€â”€â”€â”€ {chunk: 3/3} â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Server                â•‘
â•‘  Client â—„â”€â”€â”€ {status: "uploaded"} â”€â”€ Server                â•‘
â•‘  â†’ Use case: file upload, batch insert, sensor data        â•‘
â•‘                                                               â•‘
â•‘  â‘£ Bidirectional Streaming (N â†â†’ N):                        â•‘
â•‘  Client â”€â”€â”€â”€ {msg: "hello"} â”€â”€â”€â”€â”€â”€â”€â–º Server                 â•‘
â•‘  Client â—„â”€â”€â”€ {msg: "hi!"} â”€â”€â”€â”€â”€â”€â”€â”€â”€  Server                â•‘
â•‘  Client â”€â”€â”€â”€ {msg: "how r u"} â”€â”€â”€â”€â”€â–º Server                â•‘
â•‘  Client â—„â”€â”€â”€ {msg: "typing..."} â”€â”€â”€  Server                â•‘
â•‘  â†’ Use case: chat, real-time sync, collaborative editing   â•‘
â•‘                                                               â•‘
â•‘  gRPC Session Best Practices:                                â•‘
â•‘  â†’ Connection pooling: reuse HTTP/2 connections             â•‘
â•‘  â†’ Keep-alive: grpc.KeepaliveParams{Time: 10s}             â•‘
â•‘  â†’ Max connection age: force reconnect cho load balancing   â•‘
â•‘  â†’ Deadline/Timeout: LUÃ”N set! (trÃ¡nh hung connection)     â•‘
â•‘  â†’ Flow control: per-stream + per-connection                â•‘
â•‘  â†’ âš ï¸ L4 LB (NLB): sticky connection â†’ uneven load       â•‘
â•‘    â†’ FIX: client-side LB hoáº·c max connection age           â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Connection Pooling â€” Pattern Thiáº¿t Yáº¿u

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   CONNECTION POOLING â€” Táº I SAO VÃ€ CÃCH LÃ€M                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Táº¡i sao cáº§n pool?                                           â•‘
â•‘  â†’ TCP handshake: 1 RTT (50-200ms)                         â•‘
â•‘  â†’ TLS handshake: 1-2 RTT (100-400ms)                      â•‘
â•‘  â†’ Auth (DB login): 50-100ms                                â•‘
â•‘  â†’ Total: 200-700ms cho Má»–I connection má»›i!                â•‘
â•‘  â†’ Pool: táº¡o sáºµn connections â†’ reuse â†’ 0ms overhead!      â•‘
â•‘                                                               â•‘
â•‘  Database Connection Pool:                                   â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â•‘
â•‘  â”‚ App â”€â”€â–º Pool (10 idle conns) â”€â”€â–º PostgreSQL   â”‚         â•‘
â•‘  â”‚                                                â”‚         â•‘
â•‘  â”‚ Request 1 â†’ borrow conn #3 â†’ query â†’ return  â”‚         â•‘
â•‘  â”‚ Request 2 â†’ borrow conn #7 â†’ query â†’ return  â”‚         â•‘
â•‘  â”‚ Request 3 â†’ borrow conn #3 â†’ query â†’ return  â”‚         â•‘
â•‘  â”‚             (conn #3 Ä‘Ã£ tráº£ láº¡i!)             â”‚         â•‘
â•‘  â”‚                                                â”‚         â•‘
â•‘  â”‚ Pool settings (critical!):                     â”‚         â•‘
â•‘  â”‚ â†’ MaxOpenConns: 25     (max concurrent)        â”‚         â•‘
â•‘  â”‚ â†’ MaxIdleConns: 10     (keep warm)             â”‚         â•‘
â•‘  â”‚ â†’ ConnMaxLifetime: 5m  (force reconnect)       â”‚         â•‘
â•‘  â”‚ â†’ ConnMaxIdleTime: 1m  (close idle)            â”‚         â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ Pool sizing (Little's Law):                              â•‘
â•‘  â†’ Pool size = Throughput Ã— Latency                         â•‘
â•‘  â†’ 1000 req/s Ã— 10ms/query = 10 connections!              â•‘
â•‘  â†’ QuÃ¡ nhiá»u connections = DB overhead (context switching)  â•‘
â•‘  â†’ PostgreSQL: max_connections thÆ°á»ng 100-200               â•‘
â•‘  â†’ 5 app instances Ã— 25 pool = 125 â†’ sÃ¡t limit!           â•‘
â•‘                                                               â•‘
â•‘  HTTP Connection Pool (outbound):                            â•‘
â•‘  â†’ Go http.Transport: MaxIdleConnsPerHost = 100            â•‘
â•‘  â†’ âš ï¸ PHáº¢I Ä‘á»c háº¿t resp.Body + Close Ä‘á»ƒ tráº£ vá» pool!    â•‘
â•‘  â†’ Leak: khÃ´ng close body = connection stuck = pool empty! â•‘
â•‘                                                               â•‘
â•‘  gRPC Connection Pool:                                       â•‘
â•‘  â†’ HTTP/2: multiplexed, 1 connection handle nhiá»u streams  â•‘
â•‘  â†’ ThÆ°á»ng KHÃ”NG cáº§n pool! (1 conn = Ä‘á»§ cho ~100 streams) â•‘
â•‘  â†’ âš ï¸ NhÆ°ng: L4 LB â†’ 1 conn = 1 backend = uneven load  â•‘
â•‘  â†’ FIX: grpc.WithDefaultServiceConfig (round-robin)       â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Session Affinity & Sticky Sessions

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   SESSION AFFINITY â€” KHI NÃ€O VÃ€ Táº I SAO                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  Problem: User login á»Ÿ Server A, request tiáº¿p Ä‘áº¿n Server B â•‘
â•‘  â†’ Server B khÃ´ng biáº¿t user Ä‘Ã£ login! (session máº¥t)        â•‘
â•‘                                                               â•‘
â•‘  Solution 1: Shared Session Store (recommended)              â•‘
â•‘  â†’ Redis/Memcached cluster                                   â•‘
â•‘  â†’ Má»i server Ä‘á»u access cÃ¹ng session store                â•‘
â•‘  â†’ âœ… Servers stateless â†’ scale thoáº£i mÃ¡i                 â•‘
â•‘  â†’ âŒ ThÃªm dependency (Redis), latency (+1ms)              â•‘
â•‘                                                               â•‘
â•‘  Solution 2: Sticky Sessions (fallback)                      â•‘
â•‘  â†’ Load balancer route user X luÃ´n Ä‘áº¿n Server A            â•‘
â•‘  â†’ Methods:                                                  â•‘
â•‘    â†’ Cookie-based: LB set SERVERID cookie                  â•‘
â•‘    â†’ IP hash: hash(client IP) â†’ server                     â•‘
â•‘    â†’ Consistent hashing: Ã­t disruption khi add/remove srv â•‘
â•‘  â†’ âœ… ÄÆ¡n giáº£n, khÃ´ng cáº§n shared store                    â•‘
â•‘  â†’ âŒ Uneven load (1 user heavy = 1 server overloaded)    â•‘
â•‘  â†’ âŒ Server down = táº¥t cáº£ sessions máº¥t!                  â•‘
â•‘  â†’ âŒ Cannot scale down gracefully                         â•‘
â•‘                                                               â•‘
â•‘  Solution 3: Client-Side State (JWT)                         â•‘
â•‘  â†’ Session data trong token â†’ khÃ´ng cáº§n server state      â•‘
â•‘  â†’ Xem pháº§n JWT á»Ÿ trÃªn                                     â•‘
â•‘                                                               â•‘
â•‘  âš ï¸ WebSocket + LB:                                          â•‘
â•‘  â†’ WS = persistent connection â†’ PHáº¢I sticky!              â•‘
â•‘  â†’ Hoáº·c: connection ID â†’ map to server in Redis           â•‘
â•‘  â†’ AWS ALB: há»— trá»£ WS sticky sessions natively            â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Â§6. Layer 6 â€” Presentation: TLS & Encoding

### BÃ i toÃ¡n gá»‘c: Data pháº£i AN TOÃ€N vÃ  ÄÃšNG FORMAT

NÄƒm 2013, Edward Snowden tiáº¿t lá»™ ráº±ng NSA Ä‘ang **thu tháº­p toÃ n bá»™ traffic Internet khÃ´ng mÃ£ hÃ³a**. Sá»± kiá»‡n nÃ y thÃºc Ä‘áº©y phong trÃ o "HTTPS Everywhere" â€” tá»« 30% web traffic cÃ³ TLS (2013) lÃªn **95%** (2024). Layer 6 giáº£i quyáº¿t bÃ i toÃ¡n: **lÃ m sao Ä‘á»ƒ chá»‰ sender vÃ  receiver Ä‘á»c Ä‘Æ°á»£c data?**

TLS (Transport Layer Security) dÃ¹ng 2 loáº¡i cryptography:

- **Asymmetric** (RSA/ECDHE): cháº­m, chá»‰ dÃ¹ng lÃºc handshake Ä‘á»ƒ trao Ä‘á»•i khÃ³a
- **Symmetric** (AES-256-GCM): nhanh gáº¥p 1000x, dÃ¹ng cho toÃ n bá»™ data

Giá»‘ng nhÆ° báº¡n gá»­i **há»™p khÃ³a** (public key) cho Ä‘á»‘i tÃ¡c â†’ Ä‘á»‘i tÃ¡c bá» **chÃ¬a khÃ³a chung** (symmetric key) vÃ o há»™p â†’ khÃ³a há»™p â†’ gá»­i láº¡i â†’ chá»‰ báº¡n má»Ÿ Ä‘Æ°á»£c â†’ tá»« Ä‘Ã³ cáº£ hai dÃ¹ng chÃ¬a khÃ³a chung!

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   LAYER 6 â€” PRESENTATION (TLS/SSL)                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  TLS 1.3 Handshake (hiá»‡n Ä‘áº¡i nháº¥t):                         â•‘
â•‘                                                               â•‘
â•‘  Client                              Server                  â•‘
â•‘    â”‚                                   â”‚                      â•‘
â•‘    â”‚â”€â”€ ClientHello â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â•‘
â•‘    â”‚   (supported ciphers, key share) â”‚                      â•‘
â•‘    â”‚                                   â”‚                      â•‘
â•‘    â”‚â—„â”€ ServerHello + Certificate â”€â”€â”€â”€â”‚                      â•‘
â•‘    â”‚   (chosen cipher, key share,     â”‚                      â•‘
â•‘    â”‚    server cert, Finished)         â”‚                      â•‘
â•‘    â”‚                                   â”‚                      â•‘
â•‘    â”‚â”€â”€ Finished â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â•‘
â•‘    â”‚                                   â”‚                      â•‘
â•‘    â”‚â—„â•â•â• Encrypted Application Data â•â–ºâ”‚  â† chá»‰ 1 RTT!     â•‘
â•‘                                                               â•‘
â•‘  So sÃ¡nh:                                                    â•‘
â•‘  TLS 1.2: 2 RTT (handshake) â†’ cháº­m hÆ¡n                    â•‘
â•‘  TLS 1.3: 1 RTT (handshake) + 0-RTT (resumption)          â•‘
â•‘                                                               â•‘
â•‘  Certificate Chain of Trust:                                 â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â•‘
â•‘  â”‚ Root CA (DigiCert)  â”‚ â† browser/OS trust store          â•‘
â•‘  â”‚ Self-signed cert    â”‚                                     â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â•‘
â•‘            â”‚ signs                                            â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â•‘
â•‘  â”‚ Intermediate CA     â”‚ â† cháº·n gá»‘c bá»‹ compromise         â•‘
â•‘  â”‚ Issued by Root      â”‚                                     â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â•‘
â•‘            â”‚ signs                                            â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â•‘
â•‘  â”‚ Server Certificate  â”‚ â† Let's Encrypt (free!)           â•‘
â•‘  â”‚ api.example.com     â”‚   AWS ACM (managed)                â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â•‘
â•‘                                                               â•‘
â•‘  mTLS (Mutual TLS):                                          â•‘
â•‘  â†’ Server verifies CLIENT certificate too!                  â•‘
â•‘  â†’ DÃ¹ng trong: microservices, service mesh (Istio/Linkerd) â•‘
â•‘  â†’ Zero-trust networking: KHÃ”NG tin báº¥t ká»³ ai trong networkâ•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Encoding & Serialization â€” JSON vs Protobuf vs MessagePack

Layer 6 cÅ©ng lo viá»‡c **format data** â€” lÃ m sao 2 service nÃ³i chuyá»‡n Ä‘Æ°á»£c vá»›i nhau? ÄÃ¢y lÃ  bÃ i toÃ¡n **serialization**:

| Format      | Size        | Speed (encode) | Human Readable | Schema               | Use Case          |
| ----------- | ----------- | -------------- | -------------- | -------------------- | ----------------- |
| JSON        | Lá»›n (~2x)   | Cháº­m           | âœ… CÃ³          | âŒ Optional          | REST APIs, config |
| Protobuf    | Nhá» (1x)    | Nhanh (5-10x)  | âŒ KhÃ´ng       | âœ… Required (.proto) | gRPC, internal    |
| MessagePack | Nhá» (~1.3x) | Nhanh (3-5x)   | âŒ KhÃ´ng       | âŒ No                | Cache, Redis      |
| CBOR        | Nhá» (~1.3x) | Nhanh          | âŒ KhÃ´ng       | âŒ Optional          | IoT, COSE/JWT     |

> **Trade-off Analysis:** JSON tháº¯ng vÃ¬ **human readable + browser native**. Protobuf tháº¯ng khi cáº§n **performance + type safety** (gRPC). Trong microservices: external API dÃ¹ng JSON, internal service-to-service dÃ¹ng Protobuf/gRPC. Cache (Redis): MessagePack tiáº¿t kiá»‡m memory hÆ¡n JSON 30-50%.

```go
// Go TLS â€” HTTPS server chá»‰ vÃ i dÃ²ng!
package main

import (
    "crypto/tls"
    "net/http"
)

func main() {
    // Simplest HTTPS server
    http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
        w.Write([]byte("Hello TLS!"))
    })
    http.ListenAndServeTLS(":443", "cert.pem", "key.pem", nil)
}

// Custom TLS config (production)
func productionTLSConfig() *tls.Config {
    return &tls.Config{
        MinVersion: tls.VersionTLS13,  // âŒ KHÃ”NG cho phÃ©p TLS 1.2!
        CipherSuites: nil,             // TLS 1.3 auto-selects (best!)
        // mTLS: verify client certificate
        // ClientAuth: tls.RequireAndVerifyClientCert,
        // ClientCAs:  certPool,
    }
}

// Kiá»ƒm tra TLS version cá»§a connection
func tlsHandler(w http.ResponseWriter, r *http.Request) {
    if r.TLS != nil {
        switch r.TLS.Version {
        case tls.VersionTLS13:
            w.Write([]byte("TLS 1.3 âœ…"))
        case tls.VersionTLS12:
            w.Write([]byte("TLS 1.2 âš ï¸ (should upgrade)"))
        default:
            w.Write([]byte("Old TLS âŒ (security risk!)"))
        }
    }
}
```

### Compression â€” gzip vs Brotli vs zstd

HTTP compression giáº£m bandwidth 60-80%. Backend Engineer cáº§n biáº¿t chá»n Ä‘Ãºng:

| Algorithm        | Ratio          | Speed         | Browser Support    | Best For              |
| ---------------- | -------------- | ------------- | ------------------ | --------------------- |
| gzip             | Tá»‘t            | Nhanh         | âœ… Universal       | API responses         |
| Brotli (br)      | Tá»‘t hÆ¡n 15-25% | Cháº­m hÆ¡n 2-3x | âœ… Modern browsers | Static assets         |
| Zstandard (zstd) | Tá»‘t nháº¥t       | Nhanh nháº¥t    | âš ï¸ Limited         | Log shipping, backups |

> Go `net/http` máº·c Ä‘á»‹nh **khÃ´ng compress**. DÃ¹ng middleware: `github.com/klauspost/compress`. Nginx: `gzip on; gzip_types application/json;`. Brotli cho static files (build time), gzip cho dynamic API responses (runtime compress).

---

## Â§7. Layer 7 â€” Application: HTTP, gRPC, WebSocket

### BÃ i toÃ¡n gá»‘c: á»¨ng dá»¥ng giao tiáº¿p vá»›i nhau

Táº¥t cáº£ layers dÆ°á»›i lo viá»‡c truyá»n data tin cáº­y. Layer 7 lo: **data cÃ³ NGHÄ¨A GÃŒ?** ÄÃ¢y lÃ  layer mÃ  Backend Engineer dÃ nh 90% thá»i gian â€” viáº¿t HTTP endpoints, thiáº¿t káº¿ gRPC services, implement WebSocket handlers.

HTTP lÃ  protocol thá»‘ng trá»‹ Layer 7. NhÆ°ng nÃ³ Ä‘Ã£ **tiáº¿n hÃ³a** qua 3 tháº¿ há»‡, má»—i tháº¿ há»‡ giáº£i quyáº¿t **bottleneck** cá»§a tháº¿ há»‡ trÆ°á»›c:

**HTTP/1.1 (1997)**: Text-based, 1 request/connection hoáº·c pipelining (nhÆ°ng server pháº£i tráº£ response ÄÃšNG THá»¨ Tá»° â†’ Head-of-Line blocking). Má»Ÿ 6 connections song song per domain (browser limit) â†’ hack, khÃ´ng elegant.

**HTTP/2 (2015)**: Binary framing â†’ multiplexing NHIá»€U requests trÃªn 1 TCP connection. Header compression (HPACK) giáº£m overhead. Server Push cho phÃ©p server "Ä‘oÃ¡n" client cáº§n gÃ¬. **NhÆ°ng**: váº«n dÃ¹ng TCP â†’ 1 packet loss â†’ Táº¤T Cáº¢ streams bá»‹ block (TCP-level HOL blocking)!

**HTTP/3 (2022)**: Chuyá»ƒn sang **QUIC** (cháº¡y trÃªn UDP). Má»—i stream Äá»˜C Láº¬P â†’ 1 stream máº¥t packet, cÃ¡c stream khÃ¡c KHÃ”NG bá»‹ áº£nh hÆ°á»Ÿng. Built-in TLS 1.3 â†’ 0-RTT connection. Connection migration: Ä‘á»•i WiFiâ†’4G khÃ´ng máº¥t connection (dÃ¹ng Connection ID thay vÃ¬ 4-tuple)!

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   LAYER 7 â€” HTTP EVOLUTION                                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚          â”‚ HTTP/1.1     â”‚ HTTP/2       â”‚ HTTP/3      â”‚   â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â•‘
â•‘  â”‚ Transportâ”‚ TCP          â”‚ TCP          â”‚ QUIC (UDP!) â”‚   â•‘
â•‘  â”‚ Format   â”‚ Text         â”‚ Binary       â”‚ Binary      â”‚   â•‘
â•‘  â”‚ Multiplexâ”‚ âŒ (1 req/  â”‚ âœ… (streams) â”‚ âœ… (streams)â”‚   â•‘
â•‘  â”‚          â”‚  connection) â”‚              â”‚             â”‚   â•‘
â•‘  â”‚ Header   â”‚ Uncompressed â”‚ HPACK        â”‚ QPACK       â”‚   â•‘
â•‘  â”‚ HOL      â”‚ âœ… (blocked)â”‚ TCP-level âœ…â”‚ âŒ (fixed!) â”‚   â•‘
â•‘  â”‚ 0-RTT   â”‚ âŒ           â”‚ âŒ          â”‚ âœ… (QUIC)  â”‚   â•‘
â•‘  â”‚ Conn     â”‚ âŒ           â”‚ âŒ          â”‚ âœ… (connID)â”‚   â•‘
â•‘  â”‚ Migrationâ”‚              â”‚              â”‚             â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                               â•‘
â•‘  5 WHYS: Táº¡i sao HTTP/3 dÃ¹ng UDP thay TCP?                 â•‘
â•‘                                                               â•‘
â•‘  WHY 1: TCP HOL blocking áº£nh hÆ°á»Ÿng multiplexing            â•‘
â•‘  WHY 2: KhÃ´ng thá»ƒ sá»­a TCP (vÃ¬ embedded trong OS kernel)    â•‘
â•‘  WHY 3: UDP = "blank canvas" â†’ build reliability á»Ÿ userspaceâ•‘
â•‘  WHY 4: QUIC = UDP + reliability + TLS + multiplexing       â•‘
â•‘  WHY 5: Deploy nhanh hÆ¡n: QUIC update = app update,         â•‘
â•‘         TCP update = OS kernel update (years!)               â•‘
â•‘                                                               â•‘
â•‘  CÃ¡c protocol Layer 7 khÃ¡c:                                  â•‘
â•‘  â†’ gRPC: HTTP/2 + Protobuf (microservices, streaming)       â•‘
â•‘  â†’ WebSocket: full-duplex (chat, real-time)                  â•‘
â•‘  â†’ GraphQL: query language over HTTP (flexible querying)     â•‘
â•‘  â†’ MQTT: lightweight pub/sub (IoT, sensor networks)         â•‘
â•‘  â†’ AMQP: message queue protocol (RabbitMQ)                   â•‘
â•‘  â†’ Server-Sent Events: HTTP-based server push (simpler WS)  â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Go HTTP Server â€” Production Patterns

```go
package main

import (
    "context"
    "log"
    "net/http"
    "os"
    "os/signal"
    "syscall"
    "time"
)

func main() {
    mux := http.NewServeMux()
    mux.HandleFunc("/api/health", healthHandler)
    mux.HandleFunc("/api/users", usersHandler)

    // âš ï¸ Production: LUÃ”N set timeouts!
    server := &http.Server{
        Addr:         ":8080",
        Handler:      loggingMiddleware(mux), // middleware chain
        ReadTimeout:  5 * time.Second,   // max time Ä‘á»c request
        WriteTimeout: 10 * time.Second,  // max time ghi response
        IdleTimeout:  120 * time.Second, // keep-alive timeout
        // ReadHeaderTimeout cÅ©ng nÃªn set Ä‘á»ƒ chá»‘ng Slowloris attack
        ReadHeaderTimeout: 2 * time.Second,
    }

    // Graceful shutdown: Ä‘á»£i requests Ä‘ang xá»­ lÃ½ hoÃ n thÃ nh
    go func() {
        log.Printf("Server starting on %s", server.Addr)
        if err := server.ListenAndServe(); err != http.ErrServerClosed {
            log.Fatal(err)
        }
    }()

    // Chá» SIGINT/SIGTERM
    quit := make(chan os.Signal, 1)
    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
    <-quit

    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()
    server.Shutdown(ctx) // graceful: khÃ´ng nháº­n request má»›i, Ä‘á»£i cÅ© xong
    log.Println("Server stopped gracefully")
}

// Middleware pattern = Layer 7 "mini-layers"!
func loggingMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        start := time.Now()
        next.ServeHTTP(w, r)
        log.Printf("%s %s %v", r.Method, r.URL.Path, time.Since(start))
    })
}
```

---

## 5 Whys: ToÃ n Bá»™ MÃ´ HÃ¬nh OSI

ÄÃ¢y lÃ  bÃ i táº­p **5 Whys** Ã¡p dá»¥ng cho toÃ n bá»™ mÃ´ hÃ¬nh OSI â€” khÃ´ng pháº£i chá»‰ tráº£ lá»i ngáº¯n mÃ  pháº£i **truy váº¿t Ä‘áº¿n táº­n gá»‘c rá»…** cá»§a má»—i quyáº¿t Ä‘á»‹nh thiáº¿t káº¿.

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   5 WHYS: Táº I SAO Cáº¦N CHIA LAYERS?                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  WHY 1: Táº¡i sao networking pháº£i chia thÃ nh layers?          â•‘
â•‘  â†’ VÃ¬ há»‡ thá»‘ng quÃ¡ phá»©c táº¡p! Tá»« tÃ­n hiá»‡u Ä‘iá»‡n Ä‘áº¿n HTTP  â•‘
â•‘  â†’ Chia nhá» â†’ má»—i layer giáº£i quyáº¿t 1 bÃ i toÃ¡n             â•‘
â•‘  â†’ Thay Ä‘á»•i 1 layer KHÃ”NG áº£nh hÆ°á»Ÿng layers khÃ¡c            â•‘
â•‘                                                               â•‘
â•‘  WHY 2: Táº¡i sao Ä‘iá»u Ä‘Ã³ quan trá»ng?                         â•‘
â•‘  â†’ WiFi thay tháº¿ Ethernet (Layer 1-2) nhÆ°ng HTTP (Layer 7) â•‘
â•‘    KHÃ”NG cáº§n thay Ä‘á»•i!                                       â•‘
â•‘  â†’ TLS 1.3 thay TLS 1.2 (Layer 6) nhÆ°ng TCP (Layer 4)     â•‘
â•‘    KHÃ”NG thay Ä‘á»•i!                                           â•‘
â•‘  â†’ ÄÃ¢y lÃ  Sá»¨C Máº NH cá»§a abstraction layers                  â•‘
â•‘                                                               â•‘
â•‘  WHY 3: Táº¡i sao Backend Engineer cáº§n hiá»ƒu Táº¤T Cáº¢ layers?  â•‘
â•‘  â†’ VÃ¬ bugs cÃ³ thá»ƒ á»Ÿ Báº¤T Ká»² layer nÃ o!                     â•‘
â•‘  â†’ "API cháº­m" â†’ Layer 7? 4? 3? 1?                         â•‘
â•‘  â†’ Debug = loáº¡i trá»« tá»«ng layer:                             â•‘
â•‘    ping (L3) â†’ telnet (L4) â†’ curl (L7)                    â•‘
â•‘                                                               â•‘
â•‘  WHY 4: Táº¡i sao khÃ´ng merge táº¥t cáº£ thÃ nh 1 layer?          â•‘
â•‘  â†’ VÃ¬ SEPARATION OF CONCERNS = nguyÃªn táº¯c SW Engineering  â•‘
â•‘  â†’ Giá»‘ng Clean Architecture: handler â†’ service â†’ repo     â•‘
â•‘  â†’ Má»—i layer cÃ³ interface rÃµ rÃ ng â†’ dá»… thay tháº¿           â•‘
â•‘                                                               â•‘
â•‘  WHY 5: Ãp dá»¥ng gÃ¬ cho code?                                â•‘
â•‘  â†’ Thiáº¿t káº¿ API: tÃ¡ch transport (HTTP/gRPC) khá»i logic    â•‘
â•‘  â†’ Middleware pattern = layers cho HTTP requests            â•‘
â•‘  â†’ Docker networking: bridge, overlay = virtual L2/L3      â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Má»Ÿ Rá»™ng: Layers Trong Software Architecture

MÃ´ hÃ¬nh OSI khÃ´ng chá»‰ lÃ  networking theory â€” nÃ³ lÃ  **blueprint cho software design**. Má»—i khi báº¡n thiáº¿t káº¿ há»‡ thá»‘ng, báº¡n Ä‘ang (cÃ³ Ã½ thá»©c hoáº·c khÃ´ng) Ã¡p dá»¥ng layered architecture:

| OSI Layer Concept      | Software Architecture Counterpart                  |
| ---------------------- | -------------------------------------------------- |
| Layer 1 (Physical)     | Infrastructure: Docker, K8s, cloud VMs             |
| Layer 2-3 (Network)    | Service mesh: Istio, Linkerd (network abstraction) |
| Layer 4 (Transport)    | Connection management: pool, timeout, retry        |
| Layer 5 (Session)      | Authentication/session middleware                  |
| Layer 6 (Presentation) | Serialization: JSON â†” struct, Protobuf codec       |
| Layer 7 (Application)  | Business logic: handlers, services, use cases      |

**Real-world example:** Khi báº¡n viáº¿t Go middleware chain:

```go
// Má»—i middleware = 1 "layer" trong request processing!
handler := chainMiddleware(
    rateLimitMiddleware,     // â†’ giá»‘ng Layer 4 (flow control)
    authMiddleware,          // â†’ giá»‘ng Layer 5 (session)
    corsMiddleware,          // â†’ giá»‘ng Layer 6 (presentation)
    loggingMiddleware,       // â†’ cross-cutting concern
    businessHandler,         // â†’ Layer 7 (application logic)
)
```

Náº¿u middleware chain bá»‹ lá»™n xá»™n (auth check á»Ÿ chá»— nÃ y, logging á»Ÿ chá»— kia), há»‡ thá»‘ng sáº½ nhÆ° máº¡ng khÃ´ng cÃ³ layers: **há»—n loáº¡n, khÃ³ debug, khÃ³ báº£o trÃ¬**. OSI dáº¡y chÃºng ta: **má»—i layer cÃ³ 1 trÃ¡ch nhiá»‡m rÃµ rÃ ng, giao tiáº¿p qua interface chuáº©n**.

---

## Trade-off Analysis

### Transport Layer: TCP vs UDP vs QUIC â€” Khi NÃ o DÃ¹ng GÃ¬?

ÄÃ¢y khÃ´ng pháº£i cÃ¢u há»i "cÃ¡i nÃ o tá»‘t hÆ¡n" mÃ  lÃ  "**cÃ¡i nÃ o phÃ¹ há»£p cho use case cá»§a báº¡n**". Má»—i protocol tá»‘i Æ°u cho má»™t gÃ³c pháº§n tÆ° khÃ¡c nhau trong ma tráº­n reliability Ã— latency:

| TiÃªu chÃ­             | TCP              | UDP                    | QUIC (HTTP/3)      |
| -------------------- | ---------------- | ---------------------- | ------------------ |
| Reliability          | âœ… Guaranteed    | âŒ Best-effort         | âœ… Per-stream      |
| Ordering             | âœ… In-order      | âŒ Any order           | âœ… Per-stream      |
| Latency              | 1-2 RTT setup    | 0 RTT                  | 0-1 RTT            |
| HOL blocking         | âœ… Yes (toÃ n bá»™) | âŒ No                  | âŒ No (per-stream) |
| Congestion ctrl      | âœ… Built-in      | âŒ No                  | âœ… Per-stream      |
| NAT traversal        | Moderate         | Hard                   | Better (conn ID)   |
| Connection migration | âŒ (4-tuple)     | âŒ                     | âœ… (connection ID) |
| Kernel dependency    | âœ… (OS kernel)   | âœ…                     | âŒ (userspace!)    |
| **Khi nÃ o dÃ¹ng**     | HTTP, DB, email  | DNS, gaming, streaming | Modern web, mobile |

**Decision Framework â€” Chá»n Protocol Cho Tá»«ng Scenario:**

- **REST/GraphQL API** â†’ TCP + HTTP/1.1 hoáº·c HTTP/2. Reliability quan trá»ng hÆ¡n latency.
- **Microservices internal** â†’ gRPC (HTTP/2 + Protobuf). Type-safe, streaming, ~10x faster serialization.
- **Real-time game server** â†’ UDP + custom reliability. Cáº§n low latency, cháº¥p nháº­n máº¥t vÃ i packets (vá»‹ trÃ­ cÅ© khÃ´ng quan trá»ng báº±ng vá»‹ trÃ­ má»›i).
- **Video streaming** â†’ UDP/RTP hoáº·c QUIC. Máº¥t 1 frame â†’ hÆ¡i giáº­t. Chá» retransmit 1 frame â†’ giáº­t NHIá»€U HÆ N! â†’ UDP tháº¯ng.
- **Mobile app** â†’ QUIC/HTTP3. User chuyá»ƒn WiFiâ†’4G thÆ°á»ng xuyÃªn, connection migration crucial.
- **IoT sensor data** â†’ MQTT over TCP (reliability) hoáº·c CoAP over UDP (battery saving).

### Application Layer: HTTP/1.1 vs HTTP/2 vs gRPC vs WebSocket â€” Ma Tráº­n Quyáº¿t Äá»‹nh

| TiÃªu chÃ­            | HTTP/1.1                   | HTTP/2               | gRPC                       | WebSocket                   |
| ------------------- | -------------------------- | -------------------- | -------------------------- | --------------------------- |
| **Use case**        | Simple APIs, legacy        | Modern web, SPAs     | Service-to-service         | Real-time bidirectional     |
| **Data format**     | Text/JSON                  | Binary frames + JSON | Protobuf (binary)          | Any (text/binary frames)    |
| **Multiplexing**    | âŒ 1 req/conn              | âœ… Many streams/conn | âœ… HTTP/2 streams          | âŒ Single full-duplex       |
| **Streaming**       | âŒ (chunked transfer only) | âœ… Server push       | âœ… All 4 patterns          | âœ… Full-duplex              |
| **Browser support** | âœ… Universal               | âœ… Universal (auto)  | âŒ (grpc-web proxy)        | âœ… Universal                |
| **Caching**         | âœ… Easy (CDN, browser)     | âœ… HTTP caching      | âŒ Complex (no HTTP cache) | âŒ N/A                      |
| **Code generation** | âŒ Manual                  | âŒ Manual            | âœ… Auto from .proto        | âŒ Manual                   |
| **Debugging**       | âœ… curl, browser           | âœ… (appears as HTTP) | âš ï¸ grpcurl, grpcui         | âš ï¸ wscat, browser dev tools |
| **Latency**         | High (new conn/req)        | Low (multiplex)      | Very low (binary + stream) | Very low (persistent)       |

**Khi nÃ o dÃ¹ng gÃ¬? Decision tree:**

```
Báº¡n cáº§n gÃ¬?
â”œâ”€â”€ Public API cho browser/mobile?
â”‚   â”œâ”€â”€ Simple CRUD â†’ HTTP/1.1 + JSON (Ä‘Æ¡n giáº£n, compatible)
â”‚   â”œâ”€â”€ High-perf SPA â†’ HTTP/2 + JSON (multiplex, transparent)
â”‚   â””â”€â”€ Real-time updates â†’ WebSocket hoáº·c SSE
â”œâ”€â”€ Internal microservices?
â”‚   â”œâ”€â”€ Request-Response â†’ gRPC (type-safe, fast, streaming)
â”‚   â”œâ”€â”€ Event-driven â†’ gRPC streaming hoáº·c message queue
â”‚   â””â”€â”€ Cáº§n cáº£ 2 â†’ gRPC internal + REST gateway external
â””â”€â”€ Cáº§n cáº£ internal láº«n external?
    â†’ gRPC + grpc-gateway (auto-generate REST from .proto)
    â†’ Hoáº·c: GraphQL as API gateway
```

---

## Reverse Engineering â€” Debug Network Layer by Layer

### Approach: Bottom-Up Elimination

Khi cÃ³ network issue, nhiá»u engineer nháº£y ngay vÃ o Layer 7 (curl, check API logs). NhÆ°ng náº¿u váº¥n Ä‘á» á»Ÿ Layer 3 (routing) hay Layer 4 (connection timeout), báº¡n sáº½ tá»‘n hÃ ng giá» **sai hÆ°á»›ng**!

**PhÆ°Æ¡ng phÃ¡p Ä‘Ãºng: kiá»ƒm tra tá»« DÆ¯á»šI LÃŠN (bottom-up)**. Má»—i layer "OK" = loáº¡i trá»« Ä‘Æ°á»£c, tiáº¿n lÃªn layer tiáº¿p theo. Náº¿u layer nÃ o "FAIL" = táº­p trung debug layer Ä‘Ã³.

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LAYER 1: Káº¿t ná»‘i váº­t lÃ½ cÃ³ OK khÃ´ng?
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ip link show                    # interface up/down?
# â†’ "state UP" = OK. "state DOWN" = cÃ¡p rÃºt/há»ng!
ethtool eth0                    # speed, duplex, link detected?
# â†’ "Link detected: no" = Layer 1 FAIL!

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LAYER 2: MAC/ARP cÃ³ OK khÃ´ng?
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
arp -n                          # ARP cache
ip neigh show                   # neighbor table
# â†’ Gateway MAC hiá»‡n "INCOMPLETE"? = ARP fail = L2 issue

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LAYER 3: IP connectivity + DNS cÃ³ OK khÃ´ng?
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ping 8.8.8.8                    # ICMP echo â†’ IP connectivity
# â†’ "Reply from 8.8.8.8" = L3 OK
# â†’ "Network unreachable" = routing issue!
# â†’ "Request timed out" = firewall block ICMP hoáº·c L3 fail

traceroute api.example.com      # route path, hop latency
# â†’ Xem packet "dá»«ng" á»Ÿ hop nÃ o = router Ä‘Ã³ cÃ³ issue

ip route show                   # routing table
# â†’ Default route cÃ³ Ä‘Ãºng khÃ´ng? Gateway IP Ä‘Ãºng khÃ´ng?

dig api.example.com             # DNS resolution
dig +trace api.example.com      # full DNS delegation chain
nslookup api.example.com 8.8.8.8  # query specific DNS server
# â†’ "NXDOMAIN" = tÃªn miá»n khÃ´ng tá»“n táº¡i
# â†’ "SERVFAIL" = DNS server lá»—i
# â†’ "connection timed out" = DNS server unreachable

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LAYER 4: TCP connection cÃ³ OK khÃ´ng?
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
telnet api.example.com 443      # TCP connection test
nc -zv api.example.com 443      # netcat port scan (-z: scan only)
# â†’ "Connected" = L4 OK, port open
# â†’ "Connection refused" = port closed (service not running)
# â†’ "Connection timed out" = firewall DROP, hoáº·c L3 issue

ss -tlnp                        # listening TCP sockets trÃªn server
# â†’ Port 443 cÃ³ LISTEN khÃ´ng?
ss -s                           # socket statistics (xem TIME_WAIT!)
# â†’ "timewait: 50000" = problem! (xem pháº§n TIME_WAIT)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LAYER 6-7: TLS + HTTP cÃ³ OK khÃ´ng?
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TLS handshake test:
openssl s_client -connect api.example.com:443
# â†’ Certificate chain, TLS version, cipher suite
# â†’ "Verify return code: 0 (ok)" = cert valid

# HTTP request vá»›i timing breakdown:
curl -w "DNS: %{time_namelookup}s\nTCP: %{time_connect}s\nTLS: %{time_appconnect}s\nFirst Byte: %{time_starttransfer}s\nTotal: %{time_total}s\n" -o /dev/null -s https://api.example.com
# â†’ VÃ­ dá»¥ output:
# DNS: 0.010s       â† Layer 3 (DNS resolve)
# TCP: 0.030s       â† Layer 4 (TCP handshake = 1 RTT)
# TLS: 0.090s       â† Layer 6 (TLS 1.3 handshake = 1 RTT)
# First Byte: 0.120s â† Layer 7 (server processing)
# Total: 0.150s
# â†’ Náº¿u TCP high (>100ms) = distance/routing issue
# â†’ Náº¿u TLS high (>200ms) = cert chain or TLS 1.2 fallback
# â†’ Náº¿u First Byte high (>500ms) = server slow (DB? code?)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PACKET CAPTURE: xem Táº¤T Cáº¢ layers (nuclear option)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
sudo tcpdump -i eth0 -n host api.example.com
# â†’ Xem tá»«ng packet: SYN, SYN-ACK, ACK, data, FIN...
sudo tcpdump -i eth0 port 443 -w capture.pcap
# â†’ Save to file â†’ má»Ÿ báº±ng Wireshark (GUI analysis)
# â†’ Wireshark: filter "tcp.analysis.retransmission" = packet loss!
```

### Go: Diagnostic Tool â€” Äo Latency Tá»«ng Layer

```go
// Go: Ä‘o latency tá»«ng layer â€” production diagnostic tool
package main

import (
    "crypto/tls"
    "fmt"
    "net/http"
    "net/http/httptrace"
    "os"
    "time"
)

func traceRequest(url string) {
    var dnsStart, dnsDone, connStart, connDone, tlsDone, firstByte time.Time

    trace := &httptrace.ClientTrace{
        DNSStart:          func(_ httptrace.DNSStartInfo) { dnsStart = time.Now() },
        DNSDone:           func(_ httptrace.DNSDoneInfo) { dnsDone = time.Now() },
        ConnectStart:      func(_, _ string) { connStart = time.Now() },
        ConnectDone:       func(_, _ string, _ error) { connDone = time.Now() },
        TLSHandshakeDone:  func(_ tls.ConnectionState, _ error) { tlsDone = time.Now() },
        GotFirstResponseByte: func() { firstByte = time.Now() },
    }

    req, _ := http.NewRequest("GET", url, nil)
    req = req.WithContext(httptrace.WithClientTrace(req.Context(), trace))

    // DÃ¹ng NEW client (khÃ´ng pool) Ä‘á»ƒ Ä‘o connection má»›i
    client := &http.Client{Transport: &http.Transport{}}
    resp, err := client.Do(req)
    if err != nil {
        fmt.Fprintf(os.Stderr, "Error: %v\n", err)
        return
    }
    defer resp.Body.Close()

    fmt.Printf("=== Network Latency Breakdown for %s ===\n", url)
    fmt.Printf("DNS Resolve:   %6v  (Layer 3)\n", dnsDone.Sub(dnsStart))
    fmt.Printf("TCP Connect:   %6v  (Layer 4 â€” 1 RTT)\n", connDone.Sub(connStart))
    fmt.Printf("TLS Handshake: %6v  (Layer 6 â€” TLS version: %x)\n",
        tlsDone.Sub(connDone), resp.TLS.Version)
    fmt.Printf("TTFB:          %6v  (Layer 7 â€” server processing)\n",
        firstByte.Sub(tlsDone))
    fmt.Printf("Total:         %6v\n", firstByte.Sub(dnsStart))
    fmt.Printf("HTTP Status:   %d\n", resp.StatusCode)
}

func main() {
    if len(os.Args) < 2 {
        fmt.Println("Usage: go run trace.go https://api.example.com")
        return
    }
    traceRequest(os.Args[1])
}

// Output example:
// === Network Latency Breakdown for https://api.example.com ===
// DNS Resolve:    10ms  (Layer 3)
// TCP Connect:    30ms  (Layer 4 â€” 1 RTT)
// TLS Handshake:  60ms  (Layer 6 â€” TLS version: 304)
// TTFB:           20ms  (Layer 7 â€” server processing)
// Total:         120ms
// HTTP Status:   200
```

### Debug Scenarios Thá»±c Táº¿

**Scenario 1: "API timeout intermittent"**

- `ping` OK â†’ L3 OK
- `telnet port 443` OK â†’ L4 OK
- `curl` OK 90% thá»i gian â†’ L7 intermittent
- `ss -s` â†’ **50,000 TIME_WAIT** sockets!
- **Root cause:** connection pool exhaustion. Fix: increase `MaxIdleConnsPerHost`, ensure body is read & closed.

**Scenario 2: "Service unreachable sau deploy K8s"**

- `ping pod-IP` FAIL from another pod
- `kubectl get svc` â†’ ClusterIP exists
- `kubectl logs coredns` â†’ DNS OK
- `ip route` bÃªn trong pod â†’ **missing route to pod CIDR**
- **Root cause:** CNI plugin (Calico/Cilium) chÆ°a ready. Fix: wait for DaemonSet rollout, check CNI config.

**Scenario 3: "TLS handshake fails to specific clients"**

- `openssl s_client` OK tá»« server
- `openssl s_client -tls1_2` â†’ **handshake failure!**
- Check server config: `MinVersion: tls.VersionTLS13`
- Client cÅ© (Android 6) chá»‰ support TLS 1.2
- **Root cause:** Server quÃ¡ strict. Fix: allow TLS 1.2 with safe cipher suites, hoáº·c force client upgrade.

---

## Tá»•ng Káº¿t â€” Cheat Sheet

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   OSI/TCP-IP CHEAT SHEET CHO BACKEND ENGINEER                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚ Layer â”‚ TÃªn          â”‚ Protocol       â”‚ Debug tool               â”‚    â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â•‘
â•‘  â”‚  L7   â”‚ Application â”‚ HTTP,gRPC,WS   â”‚ curl, grpcurl, wscat    â”‚    â•‘
â•‘  â”‚  L6   â”‚ Presentationâ”‚ TLS, JSON, PB  â”‚ openssl s_client        â”‚    â•‘
â•‘  â”‚  L5   â”‚ Session     â”‚ TLS session    â”‚ (merged into L6/L7)     â”‚    â•‘
â•‘  â”‚  L4   â”‚ Transport   â”‚ TCP, UDP       â”‚ telnet, nc, ss          â”‚    â•‘
â•‘  â”‚  L3   â”‚ Network     â”‚ IP, ICMP, DNS  â”‚ ping, traceroute, dig   â”‚    â•‘
â•‘  â”‚  L2   â”‚ Data Link   â”‚ Ethernet, ARP  â”‚ arp, ip link            â”‚    â•‘
â•‘  â”‚  L1   â”‚ Physical    â”‚ Cables, WiFi   â”‚ ethtool, iwconfig       â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                                                           â•‘
â•‘  DEBUG FLOW: "API cháº­m/lá»—i" â†’ kiá»ƒm tra tá»« DÆ¯á»šI LÃŠN:                   â•‘
â•‘  â‘  ping (L3 OK?) â†’ â‘¡ telnet port (L4 OK?) â†’ â‘¢ curl (L7 OK?)         â•‘
â•‘                                                                           â•‘
â•‘  LATENCY BUDGET (SG â†’ US):                                              â•‘
â•‘  Light speed:   75ms  â”‚ KhÃ´ng thá»ƒ giáº£m (váº­t lÃ½!)                       â•‘
â•‘  TCP handshake: 150ms â”‚ FIX: connection pooling                          â•‘
â•‘  TLS handshake: 150ms â”‚ FIX: TLS 1.3 (1 RTT), session resumption       â•‘
â•‘  DNS lookup:    50ms  â”‚ FIX: DNS caching, /etc/hosts                     â•‘
â•‘  Server process: 20ms â”‚ FIX: optimize code, caching                      â•‘
â•‘  TOTAL:        ~445ms â”‚ Optimized: ~150ms (pool + TLS 1.3 + cache)      â•‘
â•‘                                                                           â•‘
â•‘  BACKEND ENGINEER: Táº¬P TRUNG VÃ€O                                        â•‘
â•‘  â˜…â˜…â˜…â˜…â˜… HTTP/gRPC (L7) â†’ API design, performance                        â•‘
â•‘  â˜…â˜…â˜…â˜…â˜… TCP (L4) â†’ connection pooling, timeouts, keep-alive             â•‘
â•‘  â˜…â˜…â˜…â˜…  TLS (L6) â†’ HTTPS, mTLS, certificate management                 â•‘
â•‘  â˜…â˜…â˜…   DNS/IP (L3) â†’ service discovery, load balancing                  â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Interview Prep â€” CÃ¢u Há»i Phá»ng Váº¥n Senior Backend

Khi phá»ng váº¥n Senior Backend, networking knowledge KHÃ”NG pháº£i "nice to have" â€” nÃ³ lÃ  **core competency**. ÄÃ¢y lÃ  nhá»¯ng cÃ¢u há»i thá»±c táº¿:

**Level 1 â€” Fundamental Understanding:**

1. "Giáº£i thÃ­ch TCP 3-way handshake. Táº¡i sao cáº§n 3 bÆ°á»›c thay vÃ¬ 2?"
2. "Sá»± khÃ¡c nhau giá»¯a TCP vÃ  UDP? Khi nÃ o báº¡n chá»n UDP?"
3. "HTTP/2 khÃ¡c HTTP/1.1 á»Ÿ Ä‘iá»ƒm nÃ o? Táº¡i sao multiplexing quan trá»ng?"

**Level 2 â€” Practical Debugging:** 4. "API response cháº­m 3 giÃ¢y. Báº¡n debug tháº¿ nÃ o?" â†’ Latency breakdown: DNS? TCP? TLS? Server? DB? 5. "Server bÃ¡o 'too many open files'. NguyÃªn nhÃ¢n? Fix tháº¿ nÃ o?" â†’ File descriptor limit = socket limit. Check `ulimit -n`, check TIME_WAIT accumulation. 6. "gRPC connection giá»¯a 2 services bá»‹ drop intermittent. Báº¡n kiá»ƒm tra gÃ¬?" â†’ Check MTU, check health check config, check L4 load balancer idle timeout vs gRPC keepalive.

**Level 3 â€” System Design:** 7. "Thiáº¿t káº¿ há»‡ thá»‘ng chat real-time cho 1M concurrent users. Chá»n protocol nÃ o?" â†’ WebSocket cho clientâ†”server, gRPC/message queue cho internal. Discuss sticky sessions, connection count per server (~100K/server), need ~10 servers minimum. 8. "Báº¡n deploy multi-region. LÃ m sao Ä‘áº£m báº£o latency tháº¥p cho users toÃ n cáº§u?" â†’ GeoDNS (Route53), CDN (CloudFront), edge computing, data replication strategy (eventual vs strong consistency). 9. "Giáº£i thÃ­ch táº¡i sao HTTP/3 dÃ¹ng UDP. Liá»‡u TCP cÃ³ thá»ƒ 'sá»­a' Ä‘Æ°á»£c khÃ´ng?" â†’ Protocol ossification, kernel update cycle, QUIC as userspace protocol. TCP CAN'T be fixed easily because middleboxes (firewalls, NAT) expect specific TCP behavior.

### Common Pitfalls â€” Sai Láº§m Phá»• Biáº¿n

| Sai láº§m                              | Háº­u quáº£                                      | Fix                                              |
| ------------------------------------ | -------------------------------------------- | ------------------------------------------------ |
| Táº¡o `http.Client` má»›i má»—i request    | TIME_WAIT storm, port exhaustion             | Global client vá»›i connection pool                |
| KhÃ´ng set HTTP server timeouts       | Slowloris attack, goroutine leak             | `ReadTimeout`, `WriteTimeout`, `IdleTimeout`     |
| KhÃ´ng Ä‘á»c háº¿t response body          | Connection khÃ´ng quay láº¡i pool               | `io.Copy(io.Discard, resp.Body)` trÆ°á»›c `Close()` |
| DNS TTL quÃ¡ cao khi migration        | Users truy cáº­p server cÅ© hÃ ng giá»            | Giáº£m TTL 2 ngÃ y trÆ°á»›c migration                  |
| DÃ¹ng TLS 1.2 máº·c Ä‘á»‹nh                | Cháº­m hÆ¡n 1 RTT, less secure cipher           | Force `MinVersion: tls.VersionTLS13`             |
| Ignore MTU trong K8s                 | Connection timeout bÃ­ áº©n                     | Check MTU consistency: host vs container         |
| KhÃ´ng dÃ¹ng connection pooling cho DB | Má»—i query = new TCP + TLS = ~300ms overhead! | `sql.DB` tá»± pool, set `MaxOpenConns`             |

---

## TÃ i Liá»‡u Tham Kháº£o

**SÃ¡ch â€” "Must Read" cho Senior Backend:**

- [Computer Networking: A Top-Down Approach](https://gaia.cs.umass.edu/kurose_ross/) â€” Kurose & Ross, "Bible" cá»§a Networking
- [TCP/IP Illustrated, Vol. 1](https://www.pearson.com/en-us/subject-catalog/p/tcpip-illustrated-volume-1-the-protocols/P200000003300) â€” W. Richard Stevens, deep dive into protocol internals
- [High Performance Browser Networking](https://hpbn.co/) â€” Ilya Grigorik (FREE online!) â€” HTTP/2, QUIC, TLS, latency optimization

**RFCs â€” Nguá»“n Gá»‘c ChÃ­nh Thá»©c:**

- [RFC 9293](https://www.rfc-editor.org/rfc/rfc9293) â€” TCP specification (2022 update, supersedes RFC 793)
- [RFC 9000](https://www.rfc-editor.org/rfc/rfc9000) â€” QUIC Transport Protocol
- [RFC 8446](https://www.rfc-editor.org/rfc/rfc8446) â€” TLS 1.3
- [RFC 9110](https://www.rfc-editor.org/rfc/rfc9110) â€” HTTP Semantics
- [RFC 9113](https://www.rfc-editor.org/rfc/rfc9113) â€” HTTP/2
- [RFC 9114](https://www.rfc-editor.org/rfc/rfc9114) â€” HTTP/3

**Articles & Resources:**

- [Cloudflare Learning Center](https://www.cloudflare.com/learning/) â€” Giáº£i thÃ­ch trá»±c quan OSI, DNS, TLS
- [Julia Evans Networking Zines](https://jvns.ca/) â€” Minh há»a networking concepts cá»±c hay
- [Beej's Guide to Network Programming](https://beej.us/guide/bgnet/) â€” Classic, hands-on socket programming
- [Facebook BGP Outage Postmortem](https://engineering.fb.com/2021/10/05/networking-traffic/outage-details/) â€” Case study BGP (4/10/2021)
